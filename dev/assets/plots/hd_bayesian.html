<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bayesian Historical Decomposition (cholesky)</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #fff;
    color: #333;
    padding: 20px;
}
.figure-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 16px;
    color: #222;
}
.figure-source {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 8px;
}
.panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
}
.panel {
    width: calc(100% - 16px);
    min-width: 300px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 12px;
}
.panel-title {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: #444;
}
.axis text { font-size: 11px; fill: #666; }
.axis line, .axis path { stroke: #ccc; }
.grid line { stroke: #f0f0f0; stroke-dasharray: 2,2; }
.grid .domain { stroke: none; }
.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
}
.legend { font-size: 11px; }
.legend rect { rx: 2; }
svg { overflow: visible; }
</style>
</head>
<body>
<div class="figure-title">Bayesian Historical Decomposition (cholesky)</div>
<div class="panel-grid">
<div class="panel">
<div class="panel-title">Var 1 — Posterior Mean Contributions</div>
<div id="bhd_bar_55"></div>
</div>
<div class="panel">
<div class="panel-title">Var 1 — Actual vs Decomposition</div>
<div id="bhd_line_56"></div>
</div>
<div class="panel">
<div class="panel-title">Var 2 — Posterior Mean Contributions</div>
<div id="bhd_bar_57"></div>
</div>
<div class="panel">
<div class="panel-title">Var 2 — Actual vs Decomposition</div>
<div id="bhd_line_58"></div>
</div>
<div class="panel">
<div class="panel-title">Var 3 — Posterior Mean Contributions</div>
<div id="bhd_bar_59"></div>
</div>
<div class="panel">
<div class="panel-title">Var 3 — Actual vs Decomposition</div>
<div id="bhd_line_60"></div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// Shared utilities
const tooltip = d3.select('#tooltip');
function fmt(v) {
    if (v === null || v === undefined) return '';
    return Math.abs(v) >= 1000 ? v.toFixed(1) : (Math.abs(v) >= 1 ? v.toFixed(3) : v.toFixed(4));
}
function showTip(evt, html) {
    tooltip.html(html).style('opacity',1)
        .style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px');
}
function hideTip() { tooltip.style('opacity',0); }

(function() {
    const data = [{"x":1,"s1":-0.33389121321724147,"s2":0.0,"s3":0.0},
{"x":2,"s1":-0.17489140435892575,"s2":-0.11340846774276304,"s3":-0.002202194894770523},
{"x":3,"s1":1.0922918404790665,"s2":-0.20391418869239641,"s3":0.01650703702477719},
{"x":4,"s1":0.6351469750919303,"s2":-0.17122037208563973,"s3":0.05472533229175457},
{"x":5,"s1":-0.4527770705482053,"s2":-0.3319070674531377,"s3":-0.0428470528200304},
{"x":6,"s1":-1.3839428494131856,"s2":0.023865652153192852,"s3":-0.07963443787031793},
{"x":7,"s1":-2.3731115458208594,"s2":0.3264650820891149,"s3":-0.03547542754890743},
{"x":8,"s1":-0.2759541087478768,"s2":0.23424549597511973,"s3":0.11689163513013832},
{"x":9,"s1":-1.0138262144530994,"s2":0.13127706657853114,"s3":0.08815554769000794},
{"x":10,"s1":0.763033685340709,"s2":0.2176089061892057,"s3":-0.10966441302859681},
{"x":11,"s1":0.19960080722361848,"s2":0.2985489692689507,"s3":-0.03348890713442734},
{"x":12,"s1":-0.5000531537152142,"s2":0.16475233420168311,"s3":-0.029389816538188014},
{"x":13,"s1":0.3461187303542225,"s2":0.13974908061425506,"s3":0.06199235174032765},
{"x":14,"s1":1.3530903968053636,"s2":0.14568323677718267,"s3":-0.02084124984562544},
{"x":15,"s1":-0.23113373209607288,"s2":0.16970483901217345,"s3":-0.0009379415376126711},
{"x":16,"s1":-1.3244637335762484,"s2":0.08922502956966441,"s3":-0.006637527319846725},
{"x":17,"s1":-0.12383154363186026,"s2":-0.12043455376902457,"s3":-0.03576923353146375},
{"x":18,"s1":-0.029440281987993103,"s2":-0.10967371612123804,"s3":0.07323969139935364},
{"x":19,"s1":-1.2057023292256361,"s2":-0.14898550075613887,"s3":0.002583778020684852},
{"x":20,"s1":-1.5229732247015975,"s2":0.10829215033792718,"s3":-0.0170593174574244},
{"x":21,"s1":1.204966282151019,"s2":0.08794452170020198,"s3":0.038767121589213124},
{"x":22,"s1":2.4389972237003037,"s2":-0.1129015037126104,"s3":-0.029109779853410195},
{"x":23,"s1":1.7374855402716556,"s2":-0.18702000509965366,"s3":-0.007367311372560517},
{"x":24,"s1":0.6948109461393823,"s2":-0.017594241272968207,"s3":0.0023385228343887217},
{"x":25,"s1":1.1249825003355105,"s2":-0.20547499880457598,"s3":0.011143002834797367},
{"x":26,"s1":0.44104158406550176,"s2":-0.15931212019243265,"s3":0.033134630453325674},
{"x":27,"s1":0.866780629142945,"s2":0.21643580939936735,"s3":0.05107804920334995},
{"x":28,"s1":0.3751040985355331,"s2":0.266303231941291,"s3":0.053181585725558804},
{"x":29,"s1":-0.02269728965699121,"s2":0.28417164837144354,"s3":-0.05949751780245142},
{"x":30,"s1":1.0318486234631992,"s2":0.21089289455038132,"s3":-0.09211703338785175},
{"x":31,"s1":1.7958981640683225,"s2":0.156098168329805,"s3":-0.0005360705463427883},
{"x":32,"s1":0.8705785989523019,"s2":-0.02010376808744329,"s3":-0.019119782045760335},
{"x":33,"s1":-0.3173466000669832,"s2":-0.0014571627389710958,"s3":-0.03610109677060746},
{"x":34,"s1":-0.24137740848609834,"s2":-0.21216810261960792,"s3":0.04452661864246721},
{"x":35,"s1":1.0794718849736589,"s2":-0.4032730760015368,"s3":-0.015609769810246395},
{"x":36,"s1":0.21546463708591754,"s2":-0.24625923220330503,"s3":-0.008111411414554084},
{"x":37,"s1":-0.790237858947089,"s2":-0.016228704758091593,"s3":0.05826076601530142},
{"x":38,"s1":-1.1934491015297504,"s2":0.31210737843785363,"s3":0.03330592742273504},
{"x":39,"s1":0.23893380797792202,"s2":-0.03152115277373924,"s3":0.06734626650385285},
{"x":40,"s1":0.5946870819165473,"s2":-0.1486985595197179,"s3":-0.09290939454879354},
{"x":41,"s1":2.151220180459716,"s2":0.012524363330986804,"s3":-0.091937414520203},
{"x":42,"s1":-0.11095015323182494,"s2":-0.04001605183331784,"s3":0.016438033052017454},
{"x":43,"s1":-0.30730989601187164,"s2":0.10975641111475798,"s3":0.05730023212023321},
{"x":44,"s1":-0.8695571076189973,"s2":0.01419039126533391,"s3":0.07095765847779907},
{"x":45,"s1":-0.4961426086702969,"s2":-0.3364698463775308,"s3":-0.03722665839174676},
{"x":46,"s1":0.2181889010174702,"s2":-0.34579657198832725,"s3":-0.03469330222827904},
{"x":47,"s1":-0.8673043803205743,"s2":-0.12831925430616814,"s3":0.027955631934404836},
{"x":48,"s1":-1.4798779765330954,"s2":-0.002171628094376304,"s3":-0.028306599617713212},
{"x":49,"s1":-0.38857788363932305,"s2":-0.23542985655226062,"s3":0.03500883934149336},
{"x":50,"s1":0.9152616880496841,"s2":-0.2665996208097719,"s3":0.017748836207956805},
{"x":51,"s1":-0.3432680037248979,"s2":-0.10537011263768695,"s3":0.000721496532094829},
{"x":52,"s1":1.0629005366126647,"s2":0.016256313614945138,"s3":-0.053754986699129315},
{"x":53,"s1":0.37424733843924113,"s2":0.024501394861451482,"s3":-0.03770731395401866},
{"x":54,"s1":0.4509989051079627,"s2":-0.08839465249318831,"s3":0.0455909784188772},
{"x":55,"s1":-1.6390058065621596,"s2":-0.11544152487273986,"s3":0.05197011246730109},
{"x":56,"s1":-0.9279465699416657,"s2":0.04664937723347398,"s3":0.004632450927490937},
{"x":57,"s1":1.093010408558747,"s2":0.29062275171760105,"s3":-0.041909613749047156},
{"x":58,"s1":-0.2779464634346303,"s2":0.33269391007684335,"s3":-9.01133993395361e-5},
{"x":59,"s1":1.3160420768729508,"s2":-0.07013868055317451,"s3":0.010099852868775478},
{"x":60,"s1":1.3054124733092443,"s2":0.03758346424211705,"s3":-0.007917803480397835},
{"x":61,"s1":-0.557169093589042,"s2":0.15613194370908232,"s3":-0.008273904431622216},
{"x":62,"s1":-1.6502607067186807,"s2":-0.07947965101456939,"s3":-0.019496365748952766},
{"x":63,"s1":1.03897853283617,"s2":-0.047913585292855526,"s3":-0.002010750438712839},
{"x":64,"s1":-1.1064457699555053,"s2":-0.04308754246289552,"s3":0.006987084217285038},
{"x":65,"s1":0.6106249545591196,"s2":-0.01751004499964481,"s3":-0.020866263920566064},
{"x":66,"s1":-2.0254537694747263,"s2":-0.04471461478986736,"s3":-0.02425087731993559},
{"x":67,"s1":-0.18910201971198853,"s2":-0.26093541702197587,"s3":-0.010270968160991243},
{"x":68,"s1":-0.07793499901670174,"s2":-0.39247987181509986,"s3":-0.04322641259581333},
{"x":69,"s1":-0.9318219640188167,"s2":-0.16498086285188163,"s3":0.07647459639633887},
{"x":70,"s1":1.4113016856029679,"s2":-0.26917899985837684,"s3":0.08654317486251388},
{"x":71,"s1":0.7369153694251365,"s2":0.1883140441391194,"s3":0.03548109939276543},
{"x":72,"s1":-0.4806635916626739,"s2":0.4074400653525976,"s3":0.07189999382862251},
{"x":73,"s1":-1.0838900985774753,"s2":0.2734273251426781,"s3":-0.05040922237556674},
{"x":74,"s1":0.9221038653819743,"s2":0.06916953856210382,"s3":-0.04578872170470442},
{"x":75,"s1":-1.623469171858925,"s2":0.05937587173919969,"s3":-0.0008147935426326063},
{"x":76,"s1":-0.7417471367846927,"s2":0.286319556088238,"s3":0.032085387453962444},
{"x":77,"s1":0.0947516033408787,"s2":0.04665965214234788,"s3":-0.06575365989783555},
{"x":78,"s1":-0.6188222399150596,"s2":-0.13099217326571963,"s3":-0.011762822879920814},
{"x":79,"s1":0.4476276899703326,"s2":-0.005571352057312385,"s3":-0.0381048137767729},
{"x":80,"s1":-1.3855257861662518,"s2":-0.02191184130902066,"s3":0.03348680747344119},
{"x":81,"s1":-1.076361894167705,"s2":-0.13364370203713574,"s3":0.005942804490256702},
{"x":82,"s1":0.04498639420028472,"s2":-0.03788609272519632,"s3":-0.10170097518252597},
{"x":83,"s1":-0.6224083724501666,"s2":-0.1514031335514904,"s3":0.018860867016160843},
{"x":84,"s1":0.013486798660143568,"s2":-0.4533235418670794,"s3":0.06244423586256892},
{"x":85,"s1":-1.3868688011105452,"s2":-0.3470808258286269,"s3":0.03785633743560651},
{"x":86,"s1":0.7239308304089305,"s2":-0.1409111179154658,"s3":0.004763048028705993},
{"x":87,"s1":-0.39204927898676184,"s2":0.14275402581762556,"s3":-0.11145220364677243},
{"x":88,"s1":-0.4010876221917976,"s2":0.17973969381501514,"s3":0.0012916154659325582},
{"x":89,"s1":0.7251569061481689,"s2":0.21419628545895222,"s3":0.11319205396833476},
{"x":90,"s1":-0.1068870218817323,"s2":0.10746989351497757,"s3":0.029183556967685067},
{"x":91,"s1":-1.388946434787613,"s2":-0.010102617554411544,"s3":-0.0710208879850242},
{"x":92,"s1":0.18455134034574783,"s2":0.07761110358781836,"s3":0.03146849116535621},
{"x":93,"s1":-1.2701071915502828,"s2":0.2179373390874271,"s3":0.021758289297188944},
{"x":94,"s1":0.9876997813788927,"s2":0.12117126096886308,"s3":-0.04174420015750019},
{"x":95,"s1":0.5482182364465029,"s2":0.23810617789832814,"s3":-0.03215353450866239},
{"x":96,"s1":0.5999437737179093,"s2":0.19507235920443133,"s3":0.0898504915467196},
{"x":97,"s1":0.4764608438183186,"s2":-0.07435142924979439,"s3":-0.0031962879584664546},
{"x":98,"s1":0.18433911293942046,"s2":-0.1471876361285004,"s3":-0.05300622693718363},
{"x":99,"s1":1.4570405796160006,"s2":0.27302662542803113,"s3":0.008823304801347468},
{"x":100,"s1":-1.094912579206371,"s2":0.07902550983581574,"s3":0.015545853549592653},
{"x":101,"s1":-0.21443014856301004,"s2":0.1290334607454257,"s3":-0.0283107446309603},
{"x":102,"s1":-1.8112078196425667,"s2":0.18600250076424382,"s3":0.02899338272854987},
{"x":103,"s1":-0.19221481623098358,"s2":0.1408220016290218,"s3":0.019924096082875185},
{"x":104,"s1":0.20132231467661257,"s2":0.053693393064238294,"s3":-0.009917176007075765},
{"x":105,"s1":1.3275237681095824,"s2":0.21790503153180932,"s3":0.014721641441037962},
{"x":106,"s1":0.03399204147036576,"s2":0.2151145114505164,"s3":0.05597255115283063},
{"x":107,"s1":1.9810298468339365,"s2":-0.1973193807401489,"s3":-0.023926348154992904},
{"x":108,"s1":-0.3883163145527582,"s2":-0.4069781169949861,"s3":-0.052512018743062626},
{"x":109,"s1":-0.43869358306758904,"s2":0.06557498789208485,"s3":-0.024233442825848925},
{"x":110,"s1":-0.4640091655953491,"s2":0.23286053534328466,"s3":-0.010863591612563415},
{"x":111,"s1":-0.8054134636408934,"s2":-0.03254859005256097,"s3":0.03348540354634854},
{"x":112,"s1":0.7583896777291254,"s2":0.21144797676154112,"s3":0.016122239293912936},
{"x":113,"s1":1.1906242313129256,"s2":0.1263933662216551,"s3":-0.042431657499933974},
{"x":114,"s1":0.6733661991491195,"s2":-0.10946634641225964,"s3":0.07597260827107354},
{"x":115,"s1":-0.25877569650761867,"s2":-0.07475106493574399,"s3":0.023444693454085907},
{"x":116,"s1":-1.8418415915389632,"s2":0.03273133112985615,"s3":-0.022544577892125182},
{"x":117,"s1":-1.5044343985765716,"s2":-0.21028260995079695,"s3":-0.061733486605003454},
{"x":118,"s1":-0.16301539643083138,"s2":-0.11671584546755702,"s3":0.008285528366699426},
{"x":119,"s1":0.7335545769015135,"s2":-0.15267816065855905,"s3":-0.026624390297276333},
{"x":120,"s1":0.49779013441230907,"s2":-0.11039879750357504,"s3":-0.04012204205898181},
{"x":121,"s1":-0.30974067940969324,"s2":0.08907982845624744,"s3":0.01431866450467442},
{"x":122,"s1":-1.0476107350447226,"s2":0.11965387750712063,"s3":-0.03743229658839415},
{"x":123,"s1":0.2509762899391786,"s2":-0.027805498945380012,"s3":0.006369000929316333},
{"x":124,"s1":0.06222105048349619,"s2":0.12548014370703647,"s3":-0.019888480175400222},
{"x":125,"s1":0.06557437431157524,"s2":0.0916407427660326,"s3":-0.007228964481639981},
{"x":126,"s1":-0.08314393066977167,"s2":-0.06013626363252428,"s3":0.028431153161028445},
{"x":127,"s1":0.40347876324386733,"s2":0.02167747575481884,"s3":0.05107597846308782},
{"x":128,"s1":-0.34479091901125086,"s2":0.06172185975254091,"s3":0.012434323082921592},
{"x":129,"s1":0.6864671267984113,"s2":0.2022179533971783,"s3":-0.03931586557933128},
{"x":130,"s1":0.26642200096248575,"s2":0.08886341710417686,"s3":-0.04161547664496538},
{"x":131,"s1":-0.6400267485611373,"s2":0.02755643827199993,"s3":-0.04283575117232413},
{"x":132,"s1":-1.672795517572282,"s2":0.10871078213896847,"s3":0.05908164095557058},
{"x":133,"s1":-0.8467677579871048,"s2":0.042766549502668984,"s3":-0.013689235563899197},
{"x":134,"s1":0.6327861023291408,"s2":0.0023552576759962515,"s3":-0.051293942318584924},
{"x":135,"s1":-1.2994087426746759,"s2":0.1559887199116946,"s3":0.07037186009521824},
{"x":136,"s1":1.1158021174215587,"s2":0.31657122840756186,"s3":0.03988106132408414},
{"x":137,"s1":-0.9702748462038018,"s2":0.191923079667027,"s3":-0.05391446374600252},
{"x":138,"s1":-0.2896525300413302,"s2":-0.07949065483825088,"s3":-0.00886498918428002},
{"x":139,"s1":0.1638477329050229,"s2":-0.08890653975935255,"s3":0.050488810532793096},
{"x":140,"s1":-0.46592239327017543,"s2":0.14240381796694396,"s3":0.026626147526579002},
{"x":141,"s1":1.5590579702197551,"s2":0.052956142192047174,"s3":-0.06062989224824099},
{"x":142,"s1":0.41935047024323113,"s2":0.05893698550402348,"s3":0.03458747269501821},
{"x":143,"s1":0.3067549372849332,"s2":0.11029632506494859,"s3":-0.03831197083665749},
{"x":144,"s1":0.9805542137845054,"s2":0.23896048080010554,"s3":-0.1090282753017436},
{"x":145,"s1":0.889230188943265,"s2":-0.12114699488860017,"s3":-0.017406361285850092},
{"x":146,"s1":0.056987772334954515,"s2":-0.5356114514456001,"s3":0.10533648107536453},
{"x":147,"s1":-0.4752940863980251,"s2":-0.5519013964109534,"s3":0.02132113269923756},
{"x":148,"s1":-0.5737973798612649,"s2":-0.42263447372335655,"s3":-0.0185477417149345},
{"x":149,"s1":0.6148707369965233,"s2":-0.448647411226386,"s3":0.021376685405601607},
{"x":150,"s1":-0.46368667811493663,"s2":-0.056577238176756584,"s3":0.06057571925599523},
{"x":151,"s1":0.16637164077612104,"s2":0.14575355105274534,"s3":-0.03976080552491884},
{"x":152,"s1":-0.918917784974706,"s2":-0.15419060276349322,"s3":0.008499073053328931},
{"x":153,"s1":-0.21590362441023894,"s2":-0.17884126859305116,"s3":0.02311435261735541},
{"x":154,"s1":-1.111138314599865,"s2":-0.24501867540777814,"s3":-0.01970913598346879},
{"x":155,"s1":-0.6687209414254981,"s2":-0.14049620089276332,"s3":-0.10228278781056277},
{"x":156,"s1":0.5988082246171992,"s2":-0.15292033647084827,"s3":0.0803780245818722},
{"x":157,"s1":1.143813623660468,"s2":0.04854382176675662,"s3":0.0839728014362175},
{"x":158,"s1":-1.262163172884597,"s2":-0.3070744198653173,"s3":-0.028315314218645256},
{"x":159,"s1":1.0704112412993605,"s2":-0.16319106131134603,"s3":-0.012978226266103758},
{"x":160,"s1":0.8437261999851815,"s2":0.05337111454337947,"s3":-0.011810878438725992},
{"x":161,"s1":-0.7257589679331655,"s2":-0.08078201696056925,"s3":-0.03513715199147871},
{"x":162,"s1":1.5371261370146618,"s2":-0.07955930689172151,"s3":-0.0037206024770806614},
{"x":163,"s1":-1.021143617573443,"s2":0.1713842716968568,"s3":-0.018381038829029077},
{"x":164,"s1":0.4521300689048077,"s2":0.21534616241939075,"s3":-0.04154385251350123},
{"x":165,"s1":0.8618877596585175,"s2":0.07527868752270889,"s3":0.005148156899532766},
{"x":166,"s1":-0.2190706780721025,"s2":-0.14123726215754062,"s3":0.06578930618247429},
{"x":167,"s1":-1.016566562369025,"s2":-0.0482833233894011,"s3":0.02727167168630866},
{"x":168,"s1":2.396649886475019,"s2":0.08087294918906686,"s3":-0.05509243781168114},
{"x":169,"s1":-0.027357427021248944,"s2":-0.07791391402865609,"s3":-0.02815179542530256},
{"x":170,"s1":0.8550992035992852,"s2":0.08564755012001053,"s3":-0.014763279741552891},
{"x":171,"s1":-0.4796119799039285,"s2":0.1587970940129527,"s3":-0.030888469855665596},
{"x":172,"s1":-0.33622719826089453,"s2":0.22666580849405413,"s3":0.01904284497823061},
{"x":173,"s1":0.17250551338043107,"s2":0.3376797020267165,"s3":0.06033382647960935},
{"x":174,"s1":0.7504651465237392,"s2":-0.05340502807798445,"s3":0.037382292836447145},
{"x":175,"s1":-2.2448935233890266,"s2":-0.4507509882900146,"s3":-0.021674111314089826},
{"x":176,"s1":-0.05991387637076563,"s2":-0.39110946081690867,"s3":-0.016151039774153927},
{"x":177,"s1":1.1823832421923943,"s2":0.0931591851644983,"s3":-0.015661054110690024},
{"x":178,"s1":2.0602241635133027,"s2":0.2618711646438511,"s3":0.01891685084559462},
{"x":179,"s1":0.418083241042797,"s2":-0.07512099293814643,"s3":-0.02820871152051139},
{"x":180,"s1":1.1913217775202474,"s2":-0.28368899958308524,"s3":0.08466545301628368},
{"x":181,"s1":0.4007519737945347,"s2":-0.20974197822311938,"s3":0.027737919627526447},
{"x":182,"s1":1.4727148610259169,"s2":-0.1631273890795807,"s3":-0.03039591274623244},
{"x":183,"s1":0.3677883083915235,"s2":0.08371966753310435,"s3":-0.05181695434476973},
{"x":184,"s1":0.2954691265216688,"s2":0.3456042173266641,"s3":-0.06425492728402633},
{"x":185,"s1":-0.20772413758655325,"s2":0.5395665082234546,"s3":0.06867252993758705},
{"x":186,"s1":-1.4108326649268357,"s2":0.417565875462792,"s3":0.04154390477733993},
{"x":187,"s1":0.6555442747710548,"s2":0.17294964898345733,"s3":-0.06081835001214281},
{"x":188,"s1":0.48222929795398434,"s2":-0.20782685067496937,"s3":0.041072113146362665},
{"x":189,"s1":-1.8578579233122205,"s2":-0.18654057618205444,"s3":0.0187348007501797},
{"x":190,"s1":0.49674613881507795,"s2":0.09535135703667237,"s3":0.005447612969586427},
{"x":191,"s1":0.5969199006126057,"s2":0.16150962199879737,"s3":-0.009851745552777978},
{"x":192,"s1":-1.0248714267621415,"s2":0.0009832389375311356,"s3":-0.05915232615443042},
{"x":193,"s1":-0.6579329967660502,"s2":-0.14183253962009001,"s3":0.023362621939524368},
{"x":194,"s1":-0.5283204708548042,"s2":-0.25367313634234423,"s3":0.004119982913204714},
{"x":195,"s1":1.9500112177141682,"s2":-0.1293145328205938,"s3":0.00954453676271707},
{"x":196,"s1":-0.8641097296198768,"s2":0.12866012925652814,"s3":-0.07791235222900418},
{"x":197,"s1":-1.6726079903103082,"s2":0.19073969085420028,"s3":-0.01674935697458419},
{"x":198,"s1":-0.25996402021466725,"s2":0.01813120322164902,"s3":0.07743992957641714}];
    const series = [{"name":"Shock 1","color":"#1f77b4","key":"s1","dash":""},{"name":"Shock 2","color":"#ff7f0e","key":"s2","dash":""},{"name":"Shock 3","color":"#2ca02c","key":"s3","dash":""}];
    const mode = 'stacked';

    const container = d3.select('#bhd_bar_55');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Contribution') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Contribution');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"actual":-0.31498797116895605,"recon":-0.3149879711689561},
{"x":2,"actual":-0.31125240132442067,"recon":-0.31125240132442067},
{"x":3,"actual":0.8163067649323273,"recon":0.8163067649323273},
{"x":4,"actual":0.47673837983187795,"recon":0.4767383798318781},
{"x":5,"actual":-0.8595553820616212,"recon":-0.8595553820616212},
{"x":6,"actual":-1.4692882055065464,"recon":-1.4692882055065468},
{"x":7,"actual":-2.114334831130985,"recon":-2.1143348311309857},
{"x":8,"actual":0.04378166203061088,"recon":0.043781662030610825},
{"x":9,"actual":-0.8253345499750688,"recon":-0.8253345499750688},
{"x":10,"actual":0.840288523245819,"recon":0.8402885232458192},
{"x":11,"actual":0.4338858743048611,"recon":0.4338858743048611},
{"x":12,"actual":-0.3954398407537453,"recon":-0.3954398407537453},
{"x":13,"actual":0.517130881450359,"recon":0.517130881450359},
{"x":14,"actual":1.4472238915818758,"recon":1.4472238915818758},
{"x":15,"actual":-0.09307792119019635,"recon":-0.09307792119019638},
{"x":16,"actual":-1.2725855703776923,"recon":-1.2725855703776918},
{"x":17,"actual":-0.31074387308373413,"recon":-0.3107438730837342},
{"x":18,"actual":-0.09658102196264856,"recon":-0.09658102196264856},
{"x":19,"actual":-1.382810701683701,"recon":-1.3828107016837015},
{"x":20,"actual":-1.4624467959172898,"recon":-1.4624467959172898},
{"x":21,"actual":1.3009715392603625,"recon":1.3009715392603625},
{"x":22,"actual":2.2662797122662086,"recon":2.2662797122662086},
{"x":23,"actual":1.512392007786763,"recon":1.512392007786763},
{"x":24,"actual":0.6488490404135202,"recon":0.6488490404135203},
{"x":25,"actual":0.8999443097509223,"recon":0.8999443097509225},
{"x":26,"actual":0.2841579102153428,"recon":0.2841579102153427},
{"x":27,"actual":1.1035883018237678,"recon":1.103588301823768},
{"x":28,"actual":0.6638827324729892,"recon":0.6638827324729891},
{"x":29,"actual":0.17127065460959456,"recon":0.17127065460959456},
{"x":30,"actual":1.1199182981069984,"recon":1.1199182981069986},
{"x":31,"actual":1.9207540740525255,"recon":1.9207540740525253},
{"x":32,"actual":0.8006488606751957,"recon":0.8006488606751957},
{"x":33,"actual":-0.385611048520393,"recon":-0.38561104852039313},
{"x":34,"actual":-0.4397250817930096,"recon":-0.4397250817930097},
{"x":35,"actual":0.6298828493988105,"recon":0.6298828493988101},
{"x":36,"actual":-0.06961219651922648,"recon":-0.06961219651922648},
{"x":37,"actual":-0.7789119879113274,"recon":-0.7789119879113275},
{"x":38,"actual":-0.8787419860341007,"recon":-0.8787419860341008},
{"x":39,"actual":0.2440527312174788,"recon":0.2440527312174788},
{"x":40,"actual":0.3223729372800154,"recon":0.3223729372800155},
{"x":41,"actual":2.041100938637203,"recon":2.0411009386372028},
{"x":42,"actual":-0.16523436268962188,"recon":-0.16523436268962188},
{"x":43,"actual":-0.17095944348761516,"recon":-0.1709594434876152},
{"x":44,"actual":-0.8151152486093222,"recon":-0.815115248609322},
{"x":45,"actual":-0.9005453041906385,"recon":-0.9005453041906386},
{"x":46,"actual":-0.19300716396225298,"recon":-0.193007163962253},
{"x":47,"actual":-0.9983741934645419,"recon":-0.9983741934645418},
{"x":48,"actual":-1.5410623950236277,"recon":-1.5410623950236277},
{"x":49,"actual":-0.6197050916331831,"recon":-0.6197050916331831},
{"x":50,"actual":0.6357047126615359,"recon":0.6357047126615359},
{"x":51,"actual":-0.47862281061920225,"recon":-0.47862281061920225},
{"x":52,"actual":0.9946956727381081,"recon":0.9946956727381085},
{"x":53,"actual":0.3303352285550901,"recon":0.33033522855509007},
{"x":54,"actual":0.377489040241215,"recon":0.37748904024121505},
{"x":55,"actual":-1.733183409760652,"recon":-1.7331834097606522},
{"x":56,"actual":-0.9073709325741889,"recon":-0.907370932574189},
{"x":57,"actual":1.3110173557334994,"recon":1.3110173557334994},
{"x":58,"actual":0.02395114244885036,"recon":0.02395114244885032},
{"x":59,"actual":1.2252970583943696,"recon":1.2252970583943694},
{"x":60,"actual":1.304371943276669,"recon":1.3043719432766685},
{"x":61,"actual":-0.4400172451059574,"recon":-0.44001724510595747},
{"x":62,"actual":-1.7799429142766356,"recon":-1.7799429142766356},
{"x":63,"actual":0.9583480063101281,"recon":0.9583480063101282},
{"x":64,"actual":-1.1732524189956186,"recon":-1.1732524189956184},
{"x":65,"actual":0.5415424548443852,"recon":0.5415424548443855},
{"x":66,"actual":-2.1251254523790672,"recon":-2.1251254523790672},
{"x":67,"actual":-0.49101459568950384,"recon":-0.491014595689504},
{"x":68,"actual":-0.5443474742221707,"recon":-0.5443474742221707},
{"x":69,"actual":-1.0510344212689204,"recon":-1.0510344212689207},
{"x":70,"actual":1.1979596698125403,"recon":1.19795966981254},
{"x":71,"actual":0.9300043221624539,"recon":0.9300043221624538},
{"x":72,"actual":-0.032029723276023235,"recon":-0.03202972327602318},
{"x":73,"actual":-0.8915781866049347,"recon":-0.8915781866049347},
{"x":74,"actual":0.9147784914448018,"recon":0.914778491444802},
{"x":75,"actual":-1.59561428445693,"recon":-1.59561428445693},
{"x":76,"actual":-0.454048384037065,"recon":-0.45404838403706516},
{"x":77,"actual":0.04495140479081785,"recon":0.04495140479081784},
{"x":78,"actual":-0.7922834268552733,"recon":-0.7922834268552735},
{"x":79,"actual":0.3732453333416736,"recon":0.37324533334167365},
{"x":80,"actual":-1.4046570107964054,"recon":-1.4046570107964051},
{"x":81,"actual":-1.2347689825091572,"recon":-1.2347689825091577},
{"x":82,"actual":-0.12530686450201148,"recon":-0.12530686450201148},
{"x":83,"actual":-0.78565682978007,"recon":-0.78565682978007},
{"x":84,"actual":-0.4080986981389409,"recon":-0.4080986981389409},
{"x":85,"actual":-1.7267994802981395,"recon":-1.7267994802981397},
{"x":86,"actual":0.5570765697275968,"recon":0.5570765697275966},
{"x":87,"actual":-0.3914536476104827,"recon":-0.3914536476104827},
{"x":88,"actual":-0.250762503705424,"recon":-0.2507625037054239},
{"x":89,"actual":1.0218390547808818,"recon":1.0218390547808818},
{"x":90,"actual":-0.000939762193643709,"recon":-0.0009397621936436847},
{"x":91,"actual":-1.5007761311216228,"recon":-1.5007761311216228},
{"x":92,"actual":0.26292474430434837,"recon":0.26292474430434837},
{"x":93,"actual":-1.0611177539602412,"recon":-1.0611177539602408},
{"x":94,"actual":1.0364206513956815,"recon":1.0364206513956815},
{"x":95,"actual":0.7234646890415947,"recon":0.7234646890415946},
{"x":96,"actual":0.8541604336744864,"recon":0.8541604336744862},
{"x":97,"actual":0.3682069358154837,"recon":0.36820693581548375},
{"x":98,"actual":-0.04656094092083756,"recon":-0.04656094092083761},
{"x":99,"actual":1.7081843190508057,"recon":1.7081843190508053},
{"x":100,"actual":-1.0310474066155366,"recon":-1.0310474066155366},
{"x":101,"actual":-0.14441362324311863,"recon":-0.14441362324311868},
{"x":102,"actual":-1.6269181269443471,"recon":-1.6269181269443471},
{"x":103,"actual":-0.06217490931366065,"recon":-0.06217490931366063},
{"x":104,"actual":0.21439234093920106,"recon":0.21439234093920106},
{"x":105,"actual":1.5294442502878554,"recon":1.5294442502878558},
{"x":106,"actual":0.27437291327913876,"recon":0.27437291327913876},
{"x":107,"actual":1.729077927144221,"recon":1.7290779271442205},
{"x":108,"actual":-0.8785126410853809,"recon":-0.8785126410853811},
{"x":109,"actual":-0.4280582287959271,"recon":-0.42805822879592714},
{"x":110,"actual":-0.27271841265920194,"recon":-0.27271841265920194},
{"x":111,"actual":-0.8351828409416799,"recon":-0.8351828409416798},
{"x":112,"actual":0.9552537029900053,"recon":0.9552537029900054},
{"x":113,"actual":1.2438797492400726,"recon":1.2438797492400728},
{"x":114,"actual":0.6091662702133595,"recon":0.6091662702133595},
{"x":115,"actual":-0.3407882587838508,"recon":-0.34078825878385083},
{"x":116,"actual":-1.8623610290958061,"recon":-1.8623610290958064},
{"x":117,"actual":-1.8071566859269461,"recon":-1.807156685926946},
{"x":118,"actual":-0.30215190432626304,"recon":-0.302151904326263},
{"x":119,"actual":0.5235458351511042,"recon":0.5235458351511041},
{"x":120,"actual":0.3165631040551781,"recon":0.31656310405517823},
{"x":121,"actual":-0.2370483772433455,"recon":-0.2370483772433454},
{"x":122,"actual":-0.9960953449205703,"recon":-0.9960953449205702},
{"x":123,"actual":0.1988336011285409,"recon":0.19883360112854087},
{"x":124,"actual":0.13710652322055839,"recon":0.13710652322055839},
{"x":125,"actual":0.11927996180139382,"recon":0.11927996180139379},
{"x":126,"actual":-0.14555523193584155,"recon":-0.14555523193584155},
{"x":127,"actual":0.4455260266671999,"recon":0.4455260266671999},
{"x":128,"actual":-0.3013409269703624,"recon":-0.3013409269703624},
{"x":129,"actual":0.8186630238216842,"recon":0.8186630238216842},
{"x":130,"actual":0.28296375062712315,"recon":0.28296375062712315},
{"x":131,"actual":-0.6860122522560356,"recon":-0.6860122522560355},
{"x":132,"actual":-1.535709285272317,"recon":-1.5357092852723169},
{"x":133,"actual":-0.848396634842909,"recon":-0.8483966348429091},
{"x":134,"actual":0.5531412268919781,"recon":0.553141226891978},
{"x":135,"actual":-1.1037543534623366,"recon":-1.1037543534623369},
{"x":136,"actual":1.4415482163586306,"recon":1.4415482163586306},
{"x":137,"actual":-0.8629724210773512,"recon":-0.8629724210773513},
{"x":138,"actual":-0.40871436485843515,"recon":-0.40871436485843515},
{"x":139,"actual":0.09472381288388941,"recon":0.09472381288388942},
{"x":140,"actual":-0.3275986185712264,"recon":-0.3275986185712265},
{"x":141,"actual":1.5206780293689868,"recon":1.5206780293689874},
{"x":142,"actual":0.4821687376476987,"recon":0.48216873764769874},
{"x":143,"actual":0.34803310071865035,"recon":0.34803310071865023},
{"x":144,"actual":1.0797802284882931,"recon":1.0797802284882934},
{"x":145,"actual":0.7199706419742407,"recon":0.7199706419742408},
{"x":146,"actual":-0.40399338882985514,"recon":-0.4039933888298551},
{"x":147,"actual":-1.036580540904315,"recon":-1.036580540904315},
{"x":148,"actual":-1.04568578609413,"recon":-1.04568578609413},
{"x":149,"actual":0.15689382038116473,"recon":0.15689382038116484},
{"x":150,"actual":-0.490394387830272,"recon":-0.490394387830272},
{"x":151,"actual":0.24165819550937345,"recon":0.2416581955093735},
{"x":152,"actual":-1.0953155054794443,"recon":-1.0953155054794443},
{"x":153,"actual":-0.40233673118050867,"recon":-0.4023367311805087},
{"x":154,"actual":-1.406572316785686,"recon":-1.4065723167856858},
{"x":155,"actual":-0.9422061209233982,"recon":-0.9422061209233983},
{"x":156,"actual":0.4955597219336491,"recon":0.49555972193364906},
{"x":157,"actual":1.2456240560688676,"recon":1.245624056068868},
{"x":158,"actual":-1.6282590977631333,"recon":-1.6282590977631335},
{"x":159,"actual":0.8635357629273366,"recon":0.8635357629273366},
{"x":160,"actual":0.854580245295261,"recon":0.854580245295261},
{"x":161,"actual":-0.8723843276797875,"recon":-0.8723843276797876},
{"x":162,"actual":1.4231400368512857,"recon":1.4231400368512857},
{"x":163,"actual":-0.8988465755001893,"recon":-0.8988465755001893},
{"x":164,"actual":0.5952261880161231,"recon":0.5952261880161231},
{"x":165,"actual":0.9116084132861851,"recon":0.9116084132861851},
{"x":166,"actual":-0.32522482484174287,"recon":-0.32522482484174287},
{"x":167,"actual":-1.0682844048666915,"recon":-1.0682844048666915},
{"x":168,"actual":2.39172420705783,"recon":2.391724207057831},
{"x":169,"actual":-0.16412932726978166,"recon":-0.16412932726978163},
{"x":170,"actual":0.8952772831831687,"recon":0.8952772831831688},
{"x":171,"actual":-0.38240954654121545,"recon":-0.3824095465412155},
{"x":172,"actual":-0.12122473558318383,"recon":-0.12122473558318383},
{"x":173,"actual":0.5398128510921829,"recon":0.5398128510921829},
{"x":174,"actual":0.7037362204876277,"recon":0.7037362204876279},
{"x":175,"actual":-2.7480248137877052,"recon":-2.748024813787705},
{"x":176,"actual":-0.4978805677564023,"recon":-0.49788056775640227},
{"x":177,"actual":1.2291751824516288,"recon":1.2291751824516286},
{"x":178,"actual":2.310305988208175,"recon":2.3103059882081745},
{"x":179,"actual":0.2840473457895652,"recon":0.2840473457895651},
{"x":180,"actual":0.9615920401588718,"recon":0.9615920401588718},
{"x":181,"actual":0.1880417244043678,"recon":0.18804172440436773},
{"x":182,"actual":1.2484853684055297,"recon":1.2484853684055297},
{"x":183,"actual":0.3689848307852841,"recon":0.36898483078528405},
{"x":184,"actual":0.5461122257697325,"recon":0.5461122257697325},
{"x":185,"actual":0.3698087097799145,"recon":0.36980870977991437},
{"x":186,"actual":-0.9824290754812778,"recon":-0.9824290754812778},
{"x":187,"actual":0.7369693829477952,"recon":0.7369693829477952},
{"x":188,"actual":0.2847683696308036,"recon":0.2847683696308036},
{"x":189,"actual":-2.056369889538669,"recon":-2.056369889538669},
{"x":190,"actual":0.5668389180267627,"recon":0.5668389180267627},
{"x":191,"actual":0.7178715862640512,"recon":0.717871586264051},
{"x":192,"actual":-1.113746704773615,"recon":-1.113746704773615},
{"x":193,"actual":-0.8071091052411898,"recon":-0.80710910524119},
{"x":194,"actual":-0.808579815078518,"recon":-0.8085798150785177},
{"x":195,"actual":1.7995350308617175,"recon":1.7995350308617175},
{"x":196,"actual":-0.8440681433869269,"recon":-0.8440681433869268},
{"x":197,"actual":-1.529323847225266,"recon":-1.5293238472252662},
{"x":198,"actual":-0.19509907821117517,"recon":-0.19509907821117511}];
    const series = [{"name":"Actual","color":"#1f77b4","key":"actual","dash":""},{"name":"Reconstructed","color":"#ff7f0e","key":"recon","dash":"6,3"}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#bhd_line_56');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":-0.039420445907849426,"s2":-1.228401527088395,"s3":0.0},
{"x":2,"s1":0.009961458428856622,"s2":-0.0037317687351479225,"s3":0.039627827700128314},
{"x":3,"s1":0.1314111018476081,"s2":-1.7106484509671611,"s3":0.018921536398571547},
{"x":4,"s1":-0.030963657904264284,"s2":-0.5301106688051862,"s3":-0.2584974135436595},
{"x":5,"s1":-0.06813029386467918,"s2":1.4110203267789938,"s3":0.001839123897291618},
{"x":6,"s1":-0.08361757993707919,"s2":1.0596744137984018,"s3":0.11571332312048342},
{"x":7,"s1":-0.16762221844467953,"s2":0.45639409451621804,"s3":0.341528123113903},
{"x":8,"s1":0.11614916742454394,"s2":0.5000225150175265,"s3":-0.19451039209910198},
{"x":9,"s1":-0.20293373865810999,"s2":1.412606593690385,"s3":-0.3452712613358998},
{"x":10,"s1":0.1439253136496338,"s2":0.6317628382569375,"s3":0.18508134840024257},
{"x":11,"s1":-0.08436059071155888,"s2":0.47043835038887327,"s3":-0.08083731035040892},
{"x":12,"s1":-0.057260548532971724,"s2":0.5978823346080049,"s3":0.2855431889434672},
{"x":13,"s1":0.09978620471059854,"s2":0.44534057346276124,"s3":-0.25494493497957144},
{"x":14,"s1":0.11041375264678034,"s2":0.9523258615063672,"s3":0.19426053308671057},
{"x":15,"s1":-0.14204913372265557,"s2":-0.8052110447180125,"s3":-0.11509849724302089},
{"x":16,"s1":-0.07757098915523136,"s2":0.023203229080142183,"s3":0.07037998733235304},
{"x":17,"s1":0.11000077934158844,"s2":-1.1489452697607538,"s3":0.19821130028794232},
{"x":18,"s1":-0.047424255028122066,"s2":0.4320261187679163,"s3":-0.19695244609177068},
{"x":19,"s1":-0.16071989005870005,"s2":0.5127466439838109,"s3":0.04523538013069691},
{"x":20,"s1":-0.07143339567174334,"s2":-0.02818132087667461,"s3":0.015388087157376919},
{"x":21,"s1":0.23158287177172684,"s2":-1.2442843079222121,"s3":-0.16981062516984122},
{"x":22,"s1":0.10574067285058235,"s2":0.2306056329520403,"s3":0.07372939011292395},
{"x":23,"s1":0.018103953641109376,"s2":-0.4462743297913696,"s3":-0.05467715581561618},
{"x":24,"s1":0.0408175010647461,"s2":-1.461190581529807,"s3":0.039858655062082575},
{"x":25,"s1":0.1679865987643778,"s2":0.9569471184642881,"s3":-0.002844200122874426},
{"x":26,"s1":-0.004063784362851669,"s2":0.8112020578300109,"s3":-0.020758441654519066},
{"x":27,"s1":0.11241710890941302,"s2":1.3210727216093454,"s3":-0.13131613224947192},
{"x":28,"s1":-0.0024720870470664167,"s2":0.6205040514736048,"s3":-0.34446207509320276},
{"x":29,"s1":0.004940026303847061,"s2":1.0433402880908667,"s3":-0.059339263894728995},
{"x":30,"s1":0.14738973449863926,"s2":-0.24737777142533726,"s3":0.1289082587205413},
{"x":31,"s1":0.12311453230104837,"s2":0.10755537690554023,"s3":-0.04883825682400292},
{"x":32,"s1":-0.017740910611773412,"s2":-0.1835367941092223,"s3":0.08994708666765262},
{"x":33,"s1":-0.031129024012763035,"s2":-1.9922405352983321,"s3":0.19784849781067718},
{"x":34,"s1":0.05554203547474295,"s2":-0.7870330900219655,"s3":-0.09661723577957931},
{"x":35,"s1":0.14458784293330798,"s2":-1.0327181097565001,"s3":0.15787478638902708},
{"x":36,"s1":-0.08402714316742406,"s2":1.767584207063875,"s3":0.10561163641216016},
{"x":37,"s1":-0.07089383532835748,"s2":0.32083423690725643,"s3":-0.05425524171896931},
{"x":38,"s1":-0.04577403626147446,"s2":-1.1220666292617516,"s3":0.014223593355038103},
{"x":39,"s1":0.10578640000482654,"s2":0.38390515932906005,"s3":-0.43309017019431606},
{"x":40,"s1":-0.00804135132962045,"s2":-0.41331640061531155,"s3":0.1360916287455376},
{"x":41,"s1":0.19705694708521077,"s2":0.25612411596488566,"s3":0.15511094093554728},
{"x":42,"s1":-0.17562882096568297,"s2":0.7763027851211423,"s3":0.13353498408818204},
{"x":43,"s1":0.06658737179419524,"s2":-1.26247573118332,"s3":0.002108846629773175},
{"x":44,"s1":-0.05547632147905327,"s2":-1.4840066276699073,"s3":-0.24393881961447306},
{"x":45,"s1":0.004094157783335507,"s2":-0.9339042109291842,"s3":0.051177409614480404},
{"x":46,"s1":0.03154396012633684,"s2":0.4538807586633544,"s3":0.03561100668740762},
{"x":47,"s1":-0.1475932922842291,"s2":-0.7591144570469927,"s3":-0.11689224000886426},
{"x":48,"s1":-0.09162465729976133,"s2":-1.247228147746069,"s3":0.1603872984908918},
{"x":49,"s1":0.05611925064253343,"s2":-0.548216879354263,"s3":-0.14428287091822653},
{"x":50,"s1":0.07524353167401102,"s2":-0.007039846051900304,"s3":-0.016814156455415497},
{"x":51,"s1":-0.15336647092396227,"s2":0.23996470300404152,"s3":-0.1769584584875693},
{"x":52,"s1":0.18925734240216596,"s2":-0.16329478733811964,"s3":0.10519924594228934},
{"x":53,"s1":-0.05145223644191602,"s2":-0.6828362247170108,"s3":0.13501372279197926},
{"x":54,"s1":0.05664689157689763,"s2":0.01430853909709904,"s3":-0.010123354604564724},
{"x":55,"s1":-0.20672801493733808,"s2":0.5558929295298011,"s3":-0.11867074993263327},
{"x":56,"s1":0.05964559136033733,"s2":2.1397791066484624,"s3":-0.10572560851096398},
{"x":57,"s1":0.1501759799531371,"s2":-0.31668318948661967,"s3":0.06715590483495208},
{"x":58,"s1":-0.18512434050452195,"s2":-0.42925908996741813,"s3":-0.038667923633278374},
{"x":59,"s1":0.21233493593836217,"s2":1.2456964307188778,"s3":-0.024927702301023986},
{"x":60,"s1":0.04250883177431756,"s2":-0.5052684276223246,"s3":-0.014851946857455531},
{"x":61,"s1":-0.13311242535264947,"s2":-0.12389019175684497,"s3":-0.013168977068065786},
{"x":62,"s1":-0.08111260019246722,"s2":-0.24021782039881018,"s3":0.062509953000152},
{"x":63,"s1":0.26244798973828104,"s2":-0.02498916903931879,"s3":0.02053874165940715},
{"x":64,"s1":-0.295500645903611,"s2":-0.14188435569720598,"s3":-0.020065214818598805},
{"x":65,"s1":0.1915840651326196,"s2":-0.22309696167929785,"s3":0.05021305054728244},
{"x":66,"s1":-0.32032899538636483,"s2":-2.433005021300968,"s3":0.07104970986574288},
{"x":67,"s1":0.17114228057061667,"s2":0.1449149501526245,"s3":0.03305268752863164},
{"x":68,"s1":-0.06668198876318245,"s2":-1.7846322676875708,"s3":0.3405004359819128},
{"x":69,"s1":-0.13053190068291487,"s2":0.2629997211361581,"s3":-0.066939514403101},
{"x":70,"s1":0.24403232455937654,"s2":1.7791762548549417,"s3":-0.08327485462934915},
{"x":71,"s1":-0.07120615732014812,"s2":1.2028760522658404,"s3":-0.08863501571977923},
{"x":72,"s1":-0.07772309255668738,"s2":0.6041759379798644,"s3":-0.42722862371636955},
{"x":73,"s1":-0.03948752907660834,"s2":-0.45447092353808827,"s3":-0.019542373458405753},
{"x":74,"s1":0.19476001682146032,"s2":1.407802114181103,"s3":-0.08102963454129126},
{"x":75,"s1":-0.3234192725115428,"s2":0.6102249048581947,"s3":-0.0013017433460884651},
{"x":76,"s1":0.08070544334200055,"s2":-0.7780875939867118,"s3":-0.2774397182072897},
{"x":77,"s1":0.025851978304302047,"s2":-0.10875359619641732,"s3":0.17036359616979263},
{"x":78,"s1":-0.12787455968886863,"s2":0.231853258266223,"s3":-0.14056146558048271},
{"x":79,"s1":0.10184564662363052,"s2":-0.662856610823114,"s3":0.2563463396268638},
{"x":80,"s1":-0.22318141151700482,"s2":-0.3078715173985112,"s3":-0.16062454039511959},
{"x":81,"s1":0.007202572278228081,"s2":0.21437350827110277,"s3":-0.05488972841301209},
{"x":82,"s1":0.050728278178039765,"s2":-2.011382270825163,"s3":0.32417901533930726},
{"x":83,"s1":-0.13499703742369581,"s2":-1.334302187527807,"s3":0.05908898689547094},
{"x":84,"s1":0.046753389127668556,"s2":-1.126771180243222,"s3":0.015745153250153836},
{"x":85,"s1":-0.18358107581474523,"s2":0.636528020674608,"s3":-0.10761976805338332},
{"x":86,"s1":0.20270813514157052,"s2":0.512052933624788,"s3":-0.19510440852713326},
{"x":87,"s1":-0.16548830679485063,"s2":0.9540827803367545,"s3":0.34039532485180074},
{"x":88,"s1":-0.00039726896284304465,"s2":0.5774888863330148,"s3":0.11870524679280028},
{"x":89,"s1":0.11471441721447583,"s2":0.03222202351250507,"s3":-0.18179872182713747},
{"x":90,"s1":-0.09579136910177603,"s2":-0.23910455678158285,"s3":-0.17177255311326523},
{"x":91,"s1":-0.13107107184890693,"s2":1.2706392532717028,"s3":0.18421668813087566},
{"x":92,"s1":0.15015846604446445,"s2":0.09144216138338418,"s3":-0.16610362705802983},
{"x":93,"s1":-0.22116624208820784,"s2":0.9779161029952094,"s3":-0.07877256038539818},
{"x":94,"s1":0.21795572842358138,"s2":0.8205987211892672,"s3":0.01249045657052146},
{"x":95,"s1":-0.06932426467936163,"s2":0.5298848229815764,"s3":0.20530207153068555},
{"x":96,"s1":0.047664063926377655,"s2":-1.8594300282220164,"s3":-0.3123117175025398},
{"x":97,"s1":0.036028493627997926,"s2":1.6894490304302237,"s3":-0.006047286400837592},
{"x":98,"s1":0.009827299413156363,"s2":0.13186031700891387,"s3":0.03608745258055719},
{"x":99,"s1":0.17914736692547578,"s2":0.4049008892977509,"s3":-0.01799507377544766},
{"x":100,"s1":-0.24720083647560798,"s2":0.6499725531375558,"s3":-0.07947171051156483},
{"x":101,"s1":0.13169215022630854,"s2":0.8274476043375905,"s3":0.12932014023120225},
{"x":102,"s1":-0.2197766821144056,"s2":-0.06072939874522403,"s3":-0.10452398491617788},
{"x":103,"s1":0.11682076688028255,"s2":0.5909378819674784,"s3":-0.035058537693431625},
{"x":104,"s1":-0.03361728317475156,"s2":1.30369665454442,"s3":-0.0020886012911249916},
{"x":105,"s1":0.11299926963279885,"s2":-0.08103823069687753,"s3":-0.004835517281809428},
{"x":106,"s1":-0.10658131669546303,"s2":-2.1586181375000626,"s3":-0.264889864190972},
{"x":107,"s1":0.28688521357697183,"s2":-0.5099713913836931,"s3":-0.045952343208273204},
{"x":108,"s1":-0.20519331925387274,"s2":1.876579789940785,"s3":-0.0027325590645354775},
{"x":109,"s1":0.05984471012462845,"s2":-0.8204693567408665,"s3":0.04483551719008584},
{"x":110,"s1":-0.009979066015398037,"s2":0.8856938254879004,"s3":0.10274658434778967},
{"x":111,"s1":-0.07580825617471006,"s2":0.8248986756081927,"s3":-0.06024670799706488},
{"x":112,"s1":0.13683605027571275,"s2":-0.2099453771694001,"s3":-0.07008736506613386},
{"x":113,"s1":0.03782654239801416,"s2":-0.9188853815719606,"s3":0.23161865599601428},
{"x":114,"s1":-0.003720599508184801,"s2":0.8895670151926597,"s3":-0.25597060063590876},
{"x":115,"s1":-0.03279853227568353,"s2":-1.150547335825959,"s3":-0.05251673859857273},
{"x":116,"s1":-0.1523534264860205,"s2":-0.3415481311481213,"s3":-0.15855760716648665},
{"x":117,"s1":-0.018185771336929918,"s2":-0.5275743141322358,"s3":0.17768106551597235},
{"x":118,"s1":0.03830509790341209,"s2":-0.6757106462927026,"s3":-0.14026971827557516},
{"x":119,"s1":0.020960518678771807,"s2":0.06266354104455288,"s3":0.1144156232691461},
{"x":120,"s1":-0.027556704878807844,"s2":0.9421663700949873,"s3":0.11089427972596345},
{"x":121,"s1":-0.05007569243330419,"s2":-0.409516152464532,"s3":-0.024823228149474796},
{"x":122,"s1":-0.06733806070329963,"s2":0.3214397234314204,"s3":0.21583392051048342},
{"x":123,"s1":0.11331439884206777,"s2":0.8378713801629154,"s3":-0.018704727868819757},
{"x":124,"s1":-0.06167654217477666,"s2":-0.5613665048744152,"s3":0.19315831785604476},
{"x":125,"s1":-0.00048652133707939663,"s2":0.25404076451727264,"s3":0.11395677923313557},
{"x":126,"s1":-0.008445656292922476,"s2":-0.15254263904543838,"s3":0.10760936383696558},
{"x":127,"s1":0.06013688455986306,"s2":0.9083250907807097,"s3":-0.08826422560114636},
{"x":128,"s1":-0.08016390094256617,"s2":0.5607975311182352,"s3":-0.061973887224357406},
{"x":129,"s1":0.12585185558339462,"s2":-0.15187866219442836,"s3":0.021741611949884294},
{"x":130,"s1":-0.03893839939105847,"s2":0.5062737128961863,"s3":0.07146111181458215},
{"x":131,"s1":-0.07618331247399299,"s2":0.29361063817577904,"s3":0.2771342116330765},
{"x":132,"s1":-0.12181368579703354,"s2":-0.14272606321711234,"s3":-0.1521258516234621},
{"x":133,"s1":0.02687149435519539,"s2":0.22544046875598261,"s3":0.1235930964269066},
{"x":134,"s1":0.07514274833601689,"s2":1.3021057258193907,"s3":0.24990312879364732},
{"x":135,"s1":-0.26086967288866386,"s2":1.057052622553607,"s3":-0.09911941411811764},
{"x":136,"s1":0.26360781232612107,"s2":0.020655401312666032,"s3":-0.10651751294236889},
{"x":137,"s1":-0.2548276375846077,"s2":-1.0308005143871661,"s3":0.12920867305009098},
{"x":138,"s1":0.08027064632123299,"s2":0.9026645162330303,"s3":0.07532310026250222},
{"x":139,"s1":0.01867140224255336,"s2":0.01819642291693131,"s3":-0.07610209804750875},
{"x":140,"s1":-0.09029580276569064,"s2":0.4071882993160891,"s3":-0.15563911961957225},
{"x":141,"s1":0.2256892137776384,"s2":-0.09392059691467426,"s3":0.20286686105320495},
{"x":142,"s1":-0.10319514341017057,"s2":1.3301284521152628,"s3":-0.25904870812473285},
{"x":143,"s1":0.05404564425571575,"s2":0.20341025510702068,"s3":0.04504549748759585},
{"x":144,"s1":0.12144863049911747,"s2":-1.8455465017955288,"s3":0.2694393962273328},
{"x":145,"s1":0.03335762251370203,"s2":-2.5090553557193367,"s3":0.3090958317681937},
{"x":146,"s1":-0.03150047864475592,"s2":-1.250518423896955,"s3":-0.149183669614243},
{"x":147,"s1":-0.012363996162689826,"s2":-2.0773673754126047,"s3":0.05604571280351452},
{"x":148,"s1":-0.010677643011603045,"s2":-1.0161698676993778,"s3":0.04624344651321627},
{"x":149,"s1":0.10550471355527757,"s2":1.4640595216447851,"s3":0.043840107542574606},
{"x":150,"s1":-0.1358229431985572,"s2":-0.9267228194727056,"s3":-0.25851889925167787},
{"x":151,"s1":0.08082130978364081,"s2":-0.16369029891590425,"s3":0.14303236595263324},
{"x":152,"s1":-0.13192330206673764,"s2":-1.5105250983260436,"s3":-0.1258633424580615},
{"x":153,"s1":0.059706538669343,"s2":0.09196924824126107,"s3":-0.08036209860547415},
{"x":154,"s1":-0.14638942453777892,"s2":-1.543642630014665,"s3":-0.15614146254758024},
{"x":155,"s1":0.003023945405716814,"s2":1.1056670428339173,"s3":0.44232450287006625},
{"x":156,"s1":0.08393002345771026,"s2":-1.28438120720544,"s3":-0.196519546133278},
{"x":157,"s1":0.04557673149926964,"s2":-1.1465076231164244,"s3":-0.1516685588402691},
{"x":158,"s1":-0.23339964278328795,"s2":0.4511361359692774,"s3":-0.04988550411489266},
{"x":159,"s1":0.2930740936960853,"s2":-0.08641853766486235,"s3":-0.08021739138515878},
{"x":160,"s1":-0.03201009637582691,"s2":-0.8019079379564495,"s3":-0.0606868061461872},
{"x":161,"s1":-0.1351370281197015,"s2":0.6085210607779026,"s3":0.06764328161502096},
{"x":162,"s1":0.29049372353766045,"s2":0.8781142844270003,"s3":-0.04594654606752238},
{"x":163,"s1":-0.2726911972994246,"s2":0.6684389846093782,"s3":0.03899625428302305},
{"x":164,"s1":0.19276951047205435,"s2":-0.4818942171619448,"s3":0.16067416804594034},
{"x":165,"s1":0.03854869090433092,"s2":-0.7327781402034031,"s3":0.1375827688011691},
{"x":166,"s1":-0.09464531643570992,"s2":0.8593389802445379,"s3":-0.09355455023039763},
{"x":167,"s1":-0.06138509909303921,"s2":-0.6031884094924286,"s3":-0.1258925989180829},
{"x":168,"s1":0.3757623584675798,"s2":0.12095366676056792,"s3":0.09162230829218397},
{"x":169,"s1":-0.2599762994620362,"s2":0.7868052753195152,"s3":0.025842720947315153},
{"x":170,"s1":0.18470361003943478,"s2":0.31049025211179243,"s3":0.0683063895605379},
{"x":171,"s1":-0.10442677466182333,"s2":1.7956565679732128,"s3":0.19032383066958683},
{"x":172,"s1":0.03602464074277109,"s2":0.40529983464975466,"s3":0.10580676020029872},
{"x":173,"s1":0.03753596329077457,"s2":-1.5224582133502753,"s3":-0.042196672233452186},
{"x":174,"s1":0.05517472205691838,"s2":-2.1986357853186047,"s3":-0.1162633836615411},
{"x":175,"s1":-0.32569854546215954,"s2":-0.1125103322167835,"s3":0.01267560682896932},
{"x":176,"s1":0.2267936305259448,"s2":1.439845777247574,"s3":-0.02839583598433172},
{"x":177,"s1":0.06557862090741641,"s2":0.22227752603945966,"s3":0.08193396530356814},
{"x":178,"s1":0.10745440448555892,"s2":-1.3693517545850213,"s3":-0.10376088183986588},
{"x":179,"s1":-0.08718505511815856,"s2":-0.5927127281166822,"s3":0.26417617352803274},
{"x":180,"s1":0.20279631312616178,"s2":-1.0280330114406386,"s3":-0.29473072378093995},
{"x":181,"s1":-0.018154693415706465,"s2":0.12142225361009633,"s3":-0.06378081122512355},
{"x":182,"s1":0.18599069782376457,"s2":0.8043678252555493,"s3":-0.14798805829159062},
{"x":183,"s1":-0.059366089294683885,"s2":2.2978690173279928,"s3":0.0381458663579787},
{"x":184,"s1":0.06491713468774558,"s2":1.6453624908995519,"s3":0.2711749333038098},
{"x":185,"s1":-0.019911346071974208,"s2":1.3224018482112978,"s3":-0.13271485919489787},
{"x":186,"s1":-0.132421439710793,"s2":-0.687580817071776,"s3":-0.10962363374440966},
{"x":187,"s1":0.19645317581927138,"s2":-1.1660479711938931,"s3":0.20515345428837484},
{"x":188,"s1":-0.057830331300768596,"s2":0.14045363890667661,"s3":-0.15475127908066302},
{"x":189,"s1":-0.24981874806223509,"s2":0.8923581441002053,"s3":0.017944385198932655},
{"x":190,"s1":0.25190942734912375,"s2":0.09663412831085014,"s3":-0.12822723667480368},
{"x":191,"s1":-0.039850990851073416,"s2":-0.2819716835727056,"s3":-0.06622934579146457},
{"x":192,"s1":-0.17778486703791976,"s2":-1.0227782600555733,"s3":0.1711964889633981},
{"x":193,"s1":0.043951336339178755,"s2":-0.8781667803412021,"s3":-0.09217304431330813},
{"x":194,"s1":-0.033528309697676596,"s2":0.27170332936490554,"s3":0.06818838013358615},
{"x":195,"s1":0.23688754010877103,"s2":0.9972396870683633,"s3":-0.19235659100400637},
{"x":196,"s1":-0.3036234127711204,"s2":0.2310016018098879,"s3":0.2808893318557974},
{"x":197,"s1":-0.0476946713928337,"s2":-0.3203777585957414,"s3":0.12069221792807819},
{"x":198,"s1":0.10745073251586337,"s2":0.43129177504318245,"s3":-0.16639430021736795}];
    const series = [{"name":"Shock 1","color":"#1f77b4","key":"s1","dash":""},{"name":"Shock 2","color":"#ff7f0e","key":"s2","dash":""},{"name":"Shock 3","color":"#2ca02c","key":"s3","dash":""}];
    const mode = 'stacked';

    const container = d3.select('#bhd_bar_57');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Contribution') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Contribution');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"actual":-1.7848438316990334,"recon":-1.7848438316990334},
{"x":2,"actual":-0.16623470009258495,"recon":-0.16623470009258495},
{"x":3,"actual":-1.7454483988406397,"recon":-1.7454483988406404},
{"x":4,"actual":-0.9803110100097213,"recon":-0.9803110100097213},
{"x":5,"actual":1.1688617265928365,"recon":1.1688617265928365},
{"x":6,"actual":0.920524806288261,"recon":0.9205248062882612},
{"x":7,"actual":0.46045426114762456,"recon":0.46045426114762444},
{"x":8,"actual":0.2532955371650841,"recon":0.2532955371650841},
{"x":9,"actual":0.6955520555713279,"recon":0.695552055571328},
{"x":10,"actual":0.7920467708084655,"recon":0.7920467708084656},
{"x":11,"actual":0.13656616954154815,"recon":0.1365661695415481},
{"x":12,"actual":0.6575938744608941,"recon":0.6575938744608943},
{"x":13,"actual":0.12159897817506596,"recon":0.12159897817506585},
{"x":14,"actual":1.0884252178081695,"recon":1.0884252178081695},
{"x":15,"actual":-1.230932314669837,"recon":-1.230932314669837},
{"x":16,"actual":-0.15255327957932407,"recon":-0.15255327957932405},
{"x":17,"actual":-1.009298164384915,"recon":-1.0092981643849153},
{"x":18,"actual":0.019085504616061625,"recon":0.01908550461606165},
{"x":19,"actual":0.22869825992060117,"recon":0.22869825992060117},
{"x":20,"actual":-0.252789829512057,"recon":-0.252789829512057},
{"x":21,"actual":-1.3510751357600943,"recon":-1.351075135760094},
{"x":22,"actual":0.24151276661396912,"recon":0.24151276661396914},
{"x":23,"actual":-0.651410461185863,"recon":-0.6514104611858631},
{"x":24,"actual":-1.5490772966474802,"recon":-1.5490772966474802},
{"x":25,"actual":0.9535266589138557,"recon":0.9535266589138558},
{"x":26,"actual":0.6178169923894877,"recon":0.6178169923894877},
{"x":27,"actual":1.1336108590501817,"recon":1.1336108590501817},
{"x":28,"actual":0.10500705539472267,"recon":0.10500705539472252},
{"x":29,"actual":0.8203782171901547,"recon":0.8203782171901547},
{"x":30,"actual":-0.13964260959101713,"recon":-0.13964260959101704},
{"x":31,"actual":0.013268820764113454,"recon":0.013268820764113426},
{"x":32,"actual":-0.27989344930747645,"recon":-0.2798934493074764},
{"x":33,"actual":-1.9940838929105538,"recon":-1.9940838929105533},
{"x":34,"actual":-0.9966711216406117,"recon":-0.9966711216406117},
{"x":35,"actual":-0.8988183118819917,"recon":-0.8988183118819919},
{"x":36,"actual":1.620605868828917,"recon":1.620605868828917},
{"x":37,"actual":0.027122328299694905,"recon":0.02712232829969502},
{"x":38,"actual":-1.3221799037571815,"recon":-1.3221799037571818},
{"x":39,"actual":-0.11196144249683862,"recon":-0.11196144249683876},
{"x":40,"actual":-0.4538289548611695,"recon":-0.4538289548611695},
{"x":41,"actual":0.4397291722976407,"recon":0.43972917229764064},
{"x":42,"actual":0.5656461165409565,"recon":0.5656461165409565},
{"x":43,"actual":-1.362342344476236,"recon":-1.3623423444762361},
{"x":44,"actual":-1.951984600489305,"recon":-1.951984600489305},
{"x":45,"actual":-1.0471954752648118,"recon":-1.0471954752648118},
{"x":46,"actual":0.35247289373883844,"recon":0.3524728937388385},
{"x":47,"actual":-1.1921628210823072,"recon":-1.1921628210823072},
{"x":48,"actual":-1.3470283382998303,"recon":-1.3470283382998303},
{"x":49,"actual":-0.8049433313769216,"recon":-0.8049433313769216},
{"x":50,"actual":-0.11717330258166145,"recon":-0.11717330258166143},
{"x":51,"actual":-0.2589230581569121,"recon":-0.258923058156912},
{"x":52,"actual":-0.03740103074382494,"recon":-0.03740103074382489},
{"x":53,"actual":-0.76783757011766,"recon":-0.76783757011766},
{"x":54,"actual":-0.10773075568166078,"recon":-0.1077307556816608},
{"x":55,"actual":0.06193133290845583,"recon":0.06193133290845598},
{"x":56,"actual":1.9251362577462645,"recon":1.9251362577462647},
{"x":57,"actual":-0.2679141364502461,"recon":-0.26791413645024603},
{"x":58,"actual":-0.8216141858570349,"recon":-0.821614185857035},
{"x":59,"actual":1.2645408326043261,"recon":1.2645408326043261},
{"x":60,"actual":-0.646174374457404,"recon":-0.6461743744574042},
{"x":61,"actual":-0.43873442592953926,"recon":-0.43873442592953926},
{"x":62,"actual":-0.4273832993431308,"recon":-0.42738329934313074},
{"x":63,"actual":0.08943473060634503,"recon":0.08943473060634502},
{"x":64,"actual":-0.6260130481714535,"recon":-0.6260130481714536},
{"x":65,"actual":-0.1498626777514433,"recon":-0.14986267775144324},
{"x":66,"actual":-2.850847138573644,"recon":-2.850847138573644},
{"x":67,"actual":0.1805470864998137,"recon":0.1805470864998137},
{"x":68,"actual":-1.679376652220903,"recon":-1.679376652220903},
{"x":69,"actual":-0.10303452570192292,"recon":-0.10303452570192284},
{"x":70,"actual":1.771370893032902,"recon":1.7713708930329022},
{"x":71,"actual":0.8744720474738453,"recon":0.8744720474738449},
{"x":72,"actual":-0.06933861004526162,"recon":-0.06933861004526154},
{"x":73,"actual":-0.682063657825172,"recon":-0.682063657825172},
{"x":74,"actual":1.3529696647092015,"recon":1.352969664709202},
{"x":75,"actual":0.11694105724849299,"recon":0.11694105724849305},
{"x":76,"actual":-1.1433847006040716,"recon":-1.1433847006040716},
{"x":77,"actual":-0.08110085347439343,"recon":-0.08110085347439344},
{"x":78,"actual":-0.20514559875519925,"recon":-0.20514559875519925},
{"x":79,"actual":-0.4732274563246907,"recon":-0.47322745632469065},
{"x":80,"actual":-0.8602403010627068,"recon":-0.8602403010627065},
{"x":81,"actual":-0.0018764796157523514,"recon":-0.0018764796157523245},
{"x":82,"actual":-1.8050378090598873,"recon":-1.8050378090598869},
{"x":83,"actual":-1.5787730698081026,"recon":-1.5787730698081028},
{"x":84,"actual":-1.2328354696174704,"recon":-1.2328354696174708},
{"x":85,"actual":0.1767643450544082,"recon":0.17676434505440833},
{"x":86,"actual":0.3510938284871542,"recon":0.351093828487154},
{"x":87,"actual":0.9604269666416337,"recon":0.9604269666416335},
{"x":88,"actual":0.5272340324109009,"recon":0.5272340324109008},
{"x":89,"actual":-0.2034251128522277,"recon":-0.20342511285222772},
{"x":90,"actual":-0.6752313107486952,"recon":-0.6752313107486952},
{"x":91,"actual":1.1552220378016005,"recon":1.1552220378016005},
{"x":92,"actual":-0.09306583138225231,"recon":-0.09306583138225236},
{"x":93,"actual":0.5094144687695322,"recon":0.5094144687695322},
{"x":94,"actual":0.8824820744312988,"recon":0.882482074431299},
{"x":95,"actual":0.49729979808082914,"recon":0.4972997980808291},
{"x":96,"actual":-2.29264051355025,"recon":-2.29264051355025},
{"x":97,"actual":1.5508674059053131,"recon":1.550867405905313},
{"x":98,"actual":0.009212237250556251,"recon":0.009212237250556254},
{"x":99,"actual":0.3974903506957078,"recon":0.397490350695708},
{"x":100,"actual":0.15473717439831194,"recon":0.1547371743983118},
{"x":101,"actual":0.9198970630430301,"recon":0.91989706304303},
{"x":102,"actual":-0.5535928975278788,"recon":-0.5535928975278787},
{"x":103,"actual":0.5041372794022583,"recon":0.5041372794022582},
{"x":104,"actual":1.0994279383264725,"recon":1.099427938326472},
{"x":105,"actual":-0.1414373100979593,"recon":-0.14143731009795926},
{"x":106,"actual":-2.6986521501385687,"recon":-2.6986521501385687},
{"x":107,"actual":-0.43760135276706574,"recon":-0.4376013527670656},
{"x":108,"actual":1.5000910798703055,"recon":1.5000910798703055},
{"x":109,"actual":-0.8843519611782232,"recon":-0.8843519611782233},
{"x":110,"actual":0.8098985120682209,"recon":0.8098985120682209},
{"x":111,"actual":0.5202808796843466,"recon":0.5202808796843466},
{"x":112,"actual":-0.31175952371189236,"recon":-0.31175952371189236},
{"x":113,"actual":-0.8180030149300034,"recon":-0.8180030149300034},
{"x":114,"actual":0.4613129832964952,"recon":0.461312983296495},
{"x":115,"actual":-1.4044254384522865,"recon":-1.4044254384522865},
{"x":116,"actual":-0.8210219965526997,"recon":-0.8210219965526996},
{"x":117,"actual":-0.5366418517052646,"recon":-0.5366418517052645},
{"x":118,"actual":-0.9462380984169368,"recon":-0.9462380984169367},
{"x":119,"actual":0.029476851240399612,"recon":0.029476851240399615},
{"x":120,"actual":0.8569411131900718,"recon":0.8569411131900718},
{"x":121,"actual":-0.6529779047993821,"recon":-0.6529779047993821},
{"x":122,"actual":0.30137275148653303,"recon":0.30137275148653303},
{"x":123,"actual":0.7639182193840923,"recon":0.7639182193840923},
{"x":124,"actual":-0.5984475609452182,"recon":-0.5984475609452183},
{"x":125,"actual":0.19894819066125766,"recon":0.19894819066125768},
{"x":126,"actual":-0.2219417632534665,"recon":-0.22194176325346643},
{"x":127,"actual":0.7116349179873552,"recon":0.7116349179873553},
{"x":128,"actual":0.25009691119924055,"recon":0.2500969111992404},
{"x":129,"actual":-0.1728480264132206,"recon":-0.17284802641322058},
{"x":130,"actual":0.37023359356763874,"recon":0.3702335935676388},
{"x":131,"actual":0.32599870558279154,"recon":0.32599870558279137},
{"x":132,"actual":-0.5852284323896791,"recon":-0.5852284323896791},
{"x":133,"actual":0.2073422277860134,"recon":0.20734222778601347},
{"x":134,"actual":1.4585887711969836,"recon":1.4585887711969838},
{"x":135,"actual":0.5285007037947543,"recon":0.5285007037947542},
{"x":136,"actual":0.009182868944347033,"recon":0.009182868944347056},
{"x":137,"actual":-1.324982310673754,"recon":-1.324982310673754},
{"x":138,"actual":0.8896954310646944,"recon":0.8896954310646944},
{"x":139,"actual":-0.20779710464009524,"recon":-0.20779710464009524},
{"x":140,"actual":-0.007309454821244967,"recon":-0.007309454821244982},
{"x":141,"actual":0.16607264616409795,"recon":0.16607264616409795},
{"x":142,"actual":0.799321768828288,"recon":0.7993217688282882},
{"x":143,"actual":0.1339385650982611,"recon":0.13393856509826113},
{"x":144,"actual":-1.6232213068211496,"recon":-1.6232213068211496},
{"x":145,"actual":-2.335164733189512,"recon":-2.335164733189512},
{"x":146,"actual":-1.5997654039080251,"recon":-1.599765403908025},
{"x":147,"actual":-2.2022484905238517,"recon":-2.2022484905238513},
{"x":148,"actual":-1.1491668959498356,"recon":-1.1491668959498358},
{"x":149,"actual":1.4448415109905657,"recon":1.4448415109905661},
{"x":150,"actual":-1.4896274936750118,"recon":-1.4896274936750118},
{"x":151,"actual":-0.10839945493170138,"recon":-0.10839945493170135},
{"x":152,"actual":-1.936874574602914,"recon":-1.936874574602914},
{"x":153,"actual":-0.09724914344694126,"recon":-0.09724914344694123},
{"x":154,"actual":-2.0147363488520953,"recon":-2.0147363488520953},
{"x":155,"actual":1.3824526593576294,"recon":1.3824526593576292},
{"x":156,"actual":-1.5655335616330786,"recon":-1.5655335616330788},
{"x":157,"actual":-1.4211622822094951,"recon":-1.421162282209495},
{"x":158,"actual":-0.0007118426809745056,"recon":-0.0007118426809744338},
{"x":159,"actual":-0.04212466710600698,"recon":-0.042124667106006985},
{"x":160,"actual":-1.0631676722305348,"recon":-1.0631676722305348},
{"x":161,"actual":0.3724644825211509,"recon":0.3724644825211509},
{"x":162,"actual":0.9540986301450674,"recon":0.9540986301450672},
{"x":163,"actual":0.2661812098409057,"recon":0.2661812098409055},
{"x":164,"actual":-0.29701337039602127,"recon":-0.29701337039602127},
{"x":165,"actual":-0.7252095122499744,"recon":-0.7252095122499742},
{"x":166,"actual":0.5025762818263592,"recon":0.5025762818263593},
{"x":167,"actual":-0.9590289392556218,"recon":-0.9590289392556219},
{"x":168,"actual":0.41977550176826056,"recon":0.41977550176826056},
{"x":169,"actual":0.38410886505272296,"recon":0.38410886505272285},
{"x":170,"actual":0.3949374199596939,"recon":0.3949374199596939},
{"x":171,"actual":1.7129907922289054,"recon":1.7129907922289054},
{"x":172,"actual":0.3785684038407532,"recon":0.37856840384075324},
{"x":173,"actual":-1.6956817540450246,"recon":-1.695681754045024},
{"x":174,"actual":-2.428287278675299,"recon":-2.428287278675299},
{"x":175,"actual":-0.5940961026020448,"recon":-0.5940961026020448},
{"x":176,"actual":1.4696807400371157,"recon":1.469680740037116},
{"x":177,"actual":0.2012272804983731,"recon":0.20122728049837307},
{"x":178,"actual":-1.5342210636913995,"recon":-1.5342210636913993},
{"x":179,"actual":-0.5842844414588794,"recon":-0.5842844414588791},
{"x":180,"actual":-1.2885302538474879,"recon":-1.2885302538474879},
{"x":181,"actual":-0.12907608278280486,"recon":-0.12907608278280486},
{"x":182,"actual":0.673807633035652,"recon":0.6738076330356522},
{"x":183,"actual":2.1080859626392168,"recon":2.1080859626392163},
{"x":184,"actual":1.8128917271390366,"recon":1.8128917271390361},
{"x":185,"actual":1.0012128111923548,"recon":1.0012128111923546},
{"x":186,"actual":-1.0981887222790498,"recon":-1.0981887222790498},
{"x":187,"actual":-0.9330041728383178,"recon":-0.933004172838318},
{"x":188,"actual":-0.2406908032268262,"recon":-0.24069080322682615},
{"x":189,"actual":0.4919209494848318,"recon":0.4919209494848317},
{"x":190,"actual":0.05175348723309896,"recon":0.05175348723309903},
{"x":191,"actual":-0.5566148519673147,"recon":-0.5566148519673147},
{"x":192,"actual":-1.197929469882166,"recon":-1.197929469882166},
{"x":193,"actual":-1.0949513200674024,"recon":-1.0949513200674026},
{"x":194,"actual":0.1378005680487438,"recon":0.13780056804874397},
{"x":195,"actual":0.8732078044210568,"recon":0.8732078044210568},
{"x":196,"actual":0.039704689142493844,"recon":0.0397046891424937},
{"x":197,"actual":-0.41594304381256814,"recon":-0.4159430438125681},
{"x":198,"actual":0.20378537558960677,"recon":0.20378537558960674}];
    const series = [{"name":"Actual","color":"#1f77b4","key":"actual","dash":""},{"name":"Reconstructed","color":"#ff7f0e","key":"recon","dash":"6,3"}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#bhd_line_58');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":-0.02585091534261105,"s2":-0.03205059108611836,"s3":0.5636674128110764},
{"x":2,"s1":-0.012115429214309525,"s2":-0.005986331507667389,"s3":1.328293212015269},
{"x":3,"s1":0.08405966041233112,"s2":0.006029591632244027,"s3":-0.9430789114975512},
{"x":4,"s1":0.03721587387654526,"s2":-0.022027829724844405,"s3":-1.2026172770560604},
{"x":5,"s1":-0.021968946007828977,"s2":0.10334712294944773,"s3":-1.0266606715506958},
{"x":6,"s1":-0.08972876563372549,"s2":0.054959977904168754,"s3":2.324404437291793},
{"x":7,"s1":-0.18277259894572342,"s2":-0.04205677083995256,"s3":1.2326834246813456},
{"x":8,"s1":-0.03028664837214072,"s2":-0.029640430714166017,"s3":-1.5760276287718078},
{"x":9,"s1":-0.12326645997632181,"s2":0.022426345608591552,"s3":0.25829314863217956},
{"x":10,"s1":0.05347618213048143,"s2":0.0053846002574631895,"s3":-1.410200159251007},
{"x":11,"s1":-0.00507158690317891,"s2":-0.04245494489614609,"s3":1.4264127431645965},
{"x":12,"s1":-0.033123320817252534,"s2":-0.006757173175359502,"s3":-1.4025840607953748},
{"x":13,"s1":0.03858827125871436,"s2":-0.002658086920723083,"s3":0.6520955437867709},
{"x":14,"s1":0.096716168783587,"s2":0.004074096408400437,"s3":-0.91126493919459},
{"x":15,"s1":-0.02518814366310402,"s2":-0.034938466151583664,"s3":-0.5779165084124654},
{"x":16,"s1":-0.0793444898550437,"s2":-0.040889182900186,"s3":1.423446378278275},
{"x":17,"s1":0.004281405295170514,"s2":0.005064829591977558,"s3":-0.4214473930736721},
{"x":18,"s1":-0.02657390142382117,"s2":0.006167940069467127,"s3":0.451339138360685},
{"x":19,"s1":-0.1036510949561685,"s2":0.06184737503514812,"s3":0.944421884561279},
{"x":20,"s1":-0.11068017754943696,"s2":-0.017682377976816085,"s3":-0.5312017901977488},
{"x":21,"s1":0.08836923159615692,"s2":-0.05468343654340847,"s3":0.4819805133364265},
{"x":22,"s1":0.1524597637838456,"s2":0.001462253113840339,"s3":-0.0789149320657492},
{"x":23,"s1":0.13266633526041216,"s2":0.04304972895544533,"s3":0.5548819511489775},
{"x":24,"s1":0.0903152574958394,"s2":-0.04913211731574175,"s3":1.0066101964438319},
{"x":25,"s1":0.1254866346337445,"s2":0.03530491196590935,"s3":1.797972027725496},
{"x":26,"s1":0.044995027890165344,"s2":0.08508268809791016,"s3":1.9508391057046728},
{"x":27,"s1":0.08523101587580775,"s2":-0.001656006866376913,"s3":-0.4661319003072744},
{"x":28,"s1":0.03815372052650865,"s2":-0.01476625812898483,"s3":-0.8976951337666598},
{"x":29,"s1":0.0119170110588887,"s2":-0.0244872870836437,"s3":-0.06266624195838169},
{"x":30,"s1":0.09223259941094214,"s2":-0.023918627350696893,"s3":-1.2483222936047342},
{"x":31,"s1":0.13383039349789067,"s2":-0.03912186258987798,"s3":-1.0695335009878},
{"x":32,"s1":0.07134628507851183,"s2":0.007642446310726627,"s3":0.31765673123611643},
{"x":33,"s1":0.0021840110230102287,"s2":-0.05550596627337415,"s3":-1.2808855937717925},
{"x":34,"s1":0.0052303964568635895,"s2":-0.021204177303970888,"s3":-0.053464999757046126},
{"x":35,"s1":0.08413673091862546,"s2":0.05144035797822334,"s3":0.879304728381793},
{"x":36,"s1":0.001151449234838387,"s2":0.07369080030545569,"s3":0.7686548459558409},
{"x":37,"s1":-0.04612671202537571,"s2":0.056104899662618564,"s3":2.052350451694925},
{"x":38,"s1":-0.078441669393412,"s2":-0.10326759895626167,"s3":-1.951870219190576},
{"x":39,"s1":0.016250911824051587,"s2":-0.008811618834673293,"s3":-0.9293480225803782},
{"x":40,"s1":0.020884364883734984,"s2":0.039778842367448206,"s3":-0.3438934615713796},
{"x":41,"s1":0.16334169268876692,"s2":-0.007966720497694039,"s3":0.730764420564481},
{"x":42,"s1":-0.011639664749001894,"s2":0.036860257171448876,"s3":1.3509418445694852},
{"x":43,"s1":0.01474291009409545,"s2":-0.03974545027795414,"s3":-0.5934859562036063},
{"x":44,"s1":-0.05777356918488394,"s2":-0.07581071853804967,"s3":0.16591477179843042},
{"x":45,"s1":-0.040183730616975374,"s2":0.02152253259680779,"s3":0.5438761646073529},
{"x":46,"s1":0.004614712904852633,"s2":0.0703934945988336,"s3":-0.6502837758124996},
{"x":47,"s1":-0.08145701302547474,"s2":0.018938509850293633,"s3":1.3293399049240717},
{"x":48,"s1":-0.10839643837563995,"s2":-0.05786876326206367,"s3":0.20731495413675213},
{"x":49,"s1":-0.03158315545422883,"s2":0.010506807282846338,"s3":0.659847249720162},
{"x":50,"s1":0.04650378671718977,"s2":0.05004272536092063,"s3":-1.1234438561506},
{"x":51,"s1":-0.046883119344161346,"s2":0.028466652536827425,"s3":-0.412076289774864},
{"x":52,"s1":0.10174241223252682,"s2":-0.004956413889151351,"s3":0.6880270578925395},
{"x":53,"s1":0.022289633455257613,"s2":-0.028896816788818495,"s3":0.930088796414037},
{"x":54,"s1":0.04725776555054165,"s2":0.005867459483204196,"s3":0.39722455331602985},
{"x":55,"s1":-0.12088602647826752,"s2":0.043867253481064294,"s3":-0.35172352830111403},
{"x":56,"s1":-0.05177757059179034,"s2":0.05751762990775481,"s3":0.4278055274079003},
{"x":57,"s1":0.06936361336805583,"s2":-0.023081458230171586,"s3":0.08708785533421493},
{"x":58,"s1":-0.05482912833402158,"s2":-0.10119703973889543,"s3":-0.010185573713611307},
{"x":59,"s1":0.12130765312326174,"s2":0.046216997067685874,"s3":-0.15326977792667576},
{"x":60,"s1":0.09672406947423452,"s2":0.013511785978267334,"s3":-0.5105458155030627},
{"x":61,"s1":-0.034909445821430386,"s2":-0.05600773930333671,"s3":-0.14988657204317188},
{"x":62,"s1":-0.09842372526324943,"s2":0.012617859156758412,"s3":-0.2134172580072388},
{"x":63,"s1":0.09057311756885138,"s2":0.005198079531665395,"s3":-0.7688702440356533},
{"x":64,"s1":-0.1263564713412686,"s2":0.006436156232149352,"s3":-0.8198540720956311},
{"x":65,"s1":0.06406646483277185,"s2":-0.006109734413351367,"s3":-0.8739813505913571},
{"x":66,"s1":-0.17494571594844557,"s2":-0.058434160273629396,"s3":-1.553302548938722},
{"x":67,"s1":0.0024700304999885772,"s2":0.0033016593114919405,"s3":1.5348808279569406},
{"x":68,"s1":-0.03432651088138203,"s2":0.055702339512894765,"s3":1.2834712594264128},
{"x":69,"s1":-0.08847770483147965,"s2":-0.0072728783981409325,"s3":1.8440937008721956},
{"x":70,"s1":0.12018657373624213,"s2":0.11824318279194046,"s3":2.8353380083019135},
{"x":71,"s1":0.03481201363388518,"s2":0.02590927031637008,"s3":-0.020355409485850372},
{"x":72,"s1":-0.023044022819894747,"s2":-0.05335610871782973,"s3":0.8700566835738802},
{"x":73,"s1":-0.06039622679538994,"s2":-0.059367227730366776,"s3":0.5178524327404781},
{"x":74,"s1":0.07722153219609242,"s2":0.013990808547174804,"s3":1.2469445569499398},
{"x":75,"s1":-0.15571831573688202,"s2":0.04370049742559529,"s3":-1.285278737131605},
{"x":76,"s1":-0.03734930330826789,"s2":-0.07563747461793166,"s3":0.5395218540761132},
{"x":77,"s1":-0.006165832115876581,"s2":-0.03274889689745974,"s3":-1.47843260832604},
{"x":78,"s1":-0.07073705974007187,"s2":0.03890476206725129,"s3":1.0009748226217565},
{"x":79,"s1":0.03754295887861944,"s2":-0.008844386669080159,"s3":-0.9159360242182734},
{"x":80,"s1":-0.12092467984138797,"s2":-0.022270071710655294,"s3":-2.1654018153158536},
{"x":81,"s1":-0.07069628418506012,"s2":0.030844097872507522,"s3":0.21692975881252302},
{"x":82,"s1":-0.00918345697626705,"s2":-0.03742053492391039,"s3":0.25323836684443773},
{"x":83,"s1":-0.07555611445311118,"s2":-0.052095233348151304,"s3":0.7662037575328006},
{"x":84,"s1":0.001997148641296604,"s2":0.047797056376493126,"s3":0.10169809026831249},
{"x":85,"s1":-0.11780850091178141,"s2":0.06679421766932211,"s3":-2.32208675138214},
{"x":86,"s1":0.06578208814698351,"s2":0.0601464760497038,"s3":0.4675189583202184},
{"x":87,"s1":-0.05894554348428327,"s2":-0.0023837546759483655,"s3":1.5653463617615728},
{"x":88,"s1":-0.023636592241844907,"s2":-0.0012078739545943057,"s3":0.5144664552558027},
{"x":89,"s1":0.05908933400775369,"s2":-0.0339214768565606,"s3":-0.7006463585133046},
{"x":90,"s1":-0.02151904404765627,"s2":-0.027790212975396942,"s3":1.5017303974547656},
{"x":91,"s1":-0.0988434544955633,"s2":0.03280612034738387,"s3":0.10297501316078873},
{"x":92,"s1":0.028169149394592596,"s2":0.019370205635537506,"s3":-0.3266254493884274},
{"x":93,"s1":-0.1252068859263943,"s2":-0.027383505520325615,"s3":-0.29435906327886113},
{"x":94,"s1":0.08368069109915012,"s2":0.021695447931220517,"s3":2.173322283505951},
{"x":95,"s1":0.01769566300285895,"s2":-0.021126223587263158,"s3":-0.46043337564497266},
{"x":96,"s1":0.05415207420159044,"s2":-0.07837400954907066,"s3":-0.02499241391746136},
{"x":97,"s1":0.04817665559249326,"s2":0.014492201865480328,"s3":0.33791528613797034},
{"x":98,"s1":0.025025817959243957,"s2":0.0895799113611871,"s3":0.24446854331290666},
{"x":99,"s1":0.12262131487193963,"s2":-0.05831233532868297,"s3":-0.49236929833321524},
{"x":100,"s1":-0.09110313075238341,"s2":0.010520732247202421,"s3":1.036246584749127},
{"x":101,"s1":0.015337763227330457,"s2":0.00891802539642,"s3":0.2545842129641851},
{"x":102,"s1":-0.15135149413866467,"s2":-0.022013210819734667,"s3":0.39008896215889166},
{"x":103,"s1":-0.012541575717627537,"s2":-0.019149085769365283,"s3":0.8765890509911309},
{"x":104,"s1":-0.012089399888905339,"s2":0.039865292307908494,"s3":1.714392415518969},
{"x":105,"s1":0.09229417372417902,"s2":-0.01953831703402432,"s3":-0.1478746094026537},
{"x":106,"s1":-0.002197715622382457,"s2":-0.11066438131840253,"s3":-0.19236311150026128},
{"x":107,"s1":0.1802639244802802,"s2":-0.019096971816775905,"s3":-0.451956471999711},
{"x":108,"s1":-0.03714770220223042,"s2":0.13776531678415607,"s3":-0.3841455246496295},
{"x":109,"s1":-0.0011161145962510055,"s2":0.008494860606976755,"s3":0.570360545895697},
{"x":110,"s1":-0.030148228108059148,"s2":-0.062125068781592976,"s3":0.07357193444401769},
{"x":111,"s1":-0.06973511834987474,"s2":0.05757682752696009,"s3":-0.6134972292191829},
{"x":112,"s1":0.054809203406232035,"s2":-0.03458767964984434,"s3":2.185606964801236},
{"x":113,"s1":0.07449234046768817,"s2":-0.05755671696146797,"s3":0.20221955799521296},
{"x":114,"s1":0.05382845339496034,"s2":0.027407417976225226,"s3":0.5190639256058176},
{"x":115,"s1":-0.000315603803908228,"s2":0.014060508053954575,"s3":-1.1087355242821275},
{"x":116,"s1":-0.126889206076197,"s2":-0.05149353286681659,"s3":0.5464920059712225},
{"x":117,"s1":-0.10676700805553821,"s2":0.03105467456106225,"s3":-1.4020407639658041},
{"x":118,"s1":-0.03524639855796446,"s2":-0.005603189178142902,"s3":-0.8277633483804495},
{"x":119,"s1":0.02515142467519757,"s2":0.02030847939307232,"s3":-0.49540725477232295},
{"x":120,"s1":0.02521267542239168,"s2":0.05129152202699194,"s3":-1.7192889870505987},
{"x":121,"s1":-0.015233450710804702,"s2":-0.00851826650932253,"s3":-0.36494225553216647},
{"x":122,"s1":-0.06904671251619535,"s2":-0.03206860072021912,"s3":-1.6800024656540908},
{"x":123,"s1":0.023683693530054183,"s2":0.041694026874534294,"s3":-0.6450515815357158},
{"x":124,"s1":-0.017701253334436284,"s2":-0.021478114455193244,"s3":-0.26894520408782535},
{"x":125,"s1":0.0029906303665458104,"s2":-0.02905768855354709,"s3":0.6829686716219956},
{"x":126,"s1":-0.0031374210315700175,"s2":0.021160161205947953,"s3":-0.0627513523668583},
{"x":127,"s1":0.03373262786143002,"s2":0.014517551423948644,"s3":-0.7434767424872716},
{"x":128,"s1":-0.030907721626567942,"s2":0.024838017252944197,"s3":-1.1310456796671209},
{"x":129,"s1":0.06241221378819435,"s2":-0.03926807369992449,"s3":-1.4877161901443317},
{"x":130,"s1":0.01264627350157735,"s2":-0.009600683092372855,"s3":0.6345459161454547},
{"x":131,"s1":-0.044025932127381234,"s2":0.018690038913482584,"s3":-1.5918417511311804},
{"x":132,"s1":-0.12024966813962966,"s2":-0.021006933021573047,"s3":-0.9985233364910381},
{"x":133,"s1":-0.06462539396882316,"s2":-0.006625000570693575,"s3":1.0534116608689654},
{"x":134,"s1":0.02475925226407832,"s2":0.04178393530276821,"s3":0.05091024580613797},
{"x":135,"s1":-0.12967820677217998,"s2":0.02528808843469802,"s3":-0.9542250852039936},
{"x":136,"s1":0.10573456644720187,"s2":-0.04836676509121055,"s3":0.11078248088535816},
{"x":137,"s1":-0.10072750958739461,"s2":-0.0700434210974486,"s3":0.8088726042034776},
{"x":138,"s1":-0.005473943574631385,"s2":0.02171443445549039,"s3":0.4526284604019071},
{"x":139,"s1":0.006286021177868708,"s2":0.04968752281467309,"s3":-0.979176878104261},
{"x":140,"s1":-0.04824144575844683,"s2":-0.02742878084631299,"s3":1.2301848591569329},
{"x":141,"s1":0.12940446868931094,"s2":-0.0030662031549041203,"s3":-1.803305932281243},
{"x":142,"s1":0.015437535056139408,"s2":0.017560118557721358,"s3":-2.307268813006076},
{"x":143,"s1":0.044557196014154574,"s2":0.017219294151294473,"s3":-1.1988532542935548},
{"x":144,"s1":0.08920411985285895,"s2":-0.1011942745385037,"s3":1.0490107216905646},
{"x":145,"s1":0.06799936319134751,"s2":-0.07991821939929673,"s3":-0.6353855015788121},
{"x":146,"s1":0.013339624796176638,"s2":0.034973426843579375,"s3":0.05496836859152907},
{"x":147,"s1":-0.018585185214107527,"s2":0.045352355466102924,"s3":0.499613730613879},
{"x":148,"s1":-0.03691821529882702,"s2":0.012166133692324617,"s3":1.4546242397987914},
{"x":149,"s1":0.044954629793210826,"s2":0.1144600476649029,"s3":-0.7181667348655252},
{"x":150,"s1":-0.052495498444543626,"s2":0.021185643827126316,"s3":1.2856654614854004},
{"x":151,"s1":0.024460945130488774,"s2":-0.07031524583395019,"s3":0.35443200504777794},
{"x":152,"s1":-0.07554864832003004,"s2":-0.0028390495874062185,"s3":-0.022612832168504602},
{"x":153,"s1":-0.011323988348698218,"s2":0.005758676058653931,"s3":-2.0369994176743296},
{"x":154,"s1":-0.09924156907320975,"s2":0.02312837438588748,"s3":2.388262167040876},
{"x":155,"s1":-0.054014382654364576,"s2":0.017119431480194826,"s3":0.8593981631322422},
{"x":156,"s1":0.035447052196565174,"s2":0.03409058815912526,"s3":0.4203210863802903},
{"x":157,"s1":0.06893245779907663,"s2":-0.08250592103140919,"s3":0.6016177647009922},
{"x":158,"s1":-0.09861872255314379,"s2":0.059067436622997314,"s3":0.05692513035977023},
{"x":159,"s1":0.11713750847628467,"s2":0.04786428313432895,"s3":-0.5381188408202421},
{"x":160,"s1":0.0444376153603815,"s2":-0.04033205028467011,"s3":-0.00900301188973204},
{"x":161,"s1":-0.05407196884037024,"s2":0.013240411537569156,"s3":-0.9012693308066957},
{"x":162,"s1":0.14723340918509067,"s2":0.06008077106922762,"s3":-1.173137263258752},
{"x":163,"s1":-0.09960135049191877,"s2":-0.0028429741293115314,"s3":-0.29059184996051945},
{"x":164,"s1":0.06283339020338187,"s2":-0.045717975349666935,"s3":0.887377303559613},
{"x":165,"s1":0.05569773578710758,"s2":-0.047602261761539096,"s3":0.21505121668106186},
{"x":166,"s1":-0.02236229078752697,"s2":0.0420140866383943,"s3":-1.000489326006457},
{"x":167,"s1":-0.06171705640733065,"s2":0.01974154804501706,"s3":-0.5001011897797925},
{"x":168,"s1":0.19766238255083743,"s2":-0.03589193707957697,"s3":-1.0586331865560055},
{"x":169,"s1":-0.0378656055283651,"s2":0.0442139110445568,"s3":-1.2840857262457492},
{"x":170,"s1":0.09989022868096413,"s2":0.008660155574446111,"s3":-0.13462194565748625},
{"x":171,"s1":-0.03083610349460762,"s2":0.016826796568156048,"s3":0.6815108428505936},
{"x":172,"s1":-0.010865683759319341,"s2":0.006232195635731763,"s3":0.6146952989730188},
{"x":173,"s1":0.010606386845363056,"s2":-0.10992113392557454,"s3":-0.1819405701075962},
{"x":174,"s1":0.049862116462301605,"s2":-0.07935869768906388,"s3":0.08333779898209477},
{"x":175,"s1":-0.18118178611410182,"s2":0.052687087057111504,"s3":-0.3722159368549376},
{"x":176,"s1":0.025783866183900814,"s2":0.12956409040872405,"s3":0.4498976318466745},
{"x":177,"s1":0.061537210380851935,"s2":0.012798178752730434,"s3":-0.7617080930269963},
{"x":178,"s1":0.14025172943028535,"s2":-0.09888680857696218,"s3":2.5035099808756187},
{"x":179,"s1":0.038990830839518396,"s2":-0.030091372987560087,"s3":0.23928376818980998},
{"x":180,"s1":0.1332497078921576,"s2":0.03163398274980796,"s3":0.5192536688272663},
{"x":181,"s1":0.03976894498893055,"s2":0.02416352334063174,"s3":-0.9441888925701492},
{"x":182,"s1":0.13343955933172705,"s2":0.060535309467710095,"s3":-1.150250674032982},
{"x":183,"s1":0.03024634148103357,"s2":0.05581902268841733,"s3":1.3030591050025724},
{"x":184,"s1":0.046735301751403814,"s2":0.019917757885647615,"s3":0.06907634777922636},
{"x":185,"s1":-0.005620411567750665,"s2":-0.05240793124166476,"s3":-0.8597736993903093},
{"x":186,"s1":-0.10456201900647243,"s2":-0.07736418647959406,"s3":1.404964736880699},
{"x":187,"s1":0.0590227674221567,"s2":-0.08327659228238328,"s3":0.019210211849216452},
{"x":188,"s1":0.009107273671038515,"s2":0.030505138660507133,"s3":0.8438849956036795},
{"x":189,"s1":-0.14673780810178463,"s2":0.07315454173630284,"s3":-0.14055270566095412},
{"x":190,"s1":0.06630907838975601,"s2":-0.0011542377850259245,"s3":-0.9228876719428428},
{"x":191,"s1":0.01618002693423085,"s2":-0.047714826056796694,"s3":0.6630322819653921},
{"x":192,"s1":-0.08813978456967446,"s2":-0.03133579730018993,"s3":-0.4694260261079447},
{"x":193,"s1":-0.031086737861658553,"s2":-0.012678103425035768,"s3":0.34773146748038397},
{"x":194,"s1":-0.049445377117264565,"s2":0.04639435446871575,"s3":-2.223754688394},
{"x":195,"s1":0.14091436519810288,"s2":0.06202060995576995,"s3":-0.12731817801778003},
{"x":196,"s1":-0.0946163788392471,"s2":-0.002514857814916237,"s3":0.5678117086887792},
{"x":197,"s1":-0.0956279878658517,"s2":-0.04858568971663312,"s3":-1.4283916292870278},
{"x":198,"s1":-0.011490755606158434,"s2":0.0018762478373237257,"s3":-0.7308059518975104}];
    const series = [{"name":"Shock 1","color":"#1f77b4","key":"s1","dash":""},{"name":"Shock 2","color":"#ff7f0e","key":"s2","dash":""},{"name":"Shock 3","color":"#2ca02c","key":"s3","dash":""}];
    const mode = 'stacked';

    const container = d3.select('#bhd_bar_59');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Contribution') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Contribution');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"actual":0.6040781375558437,"recon":0.6040781375558436},
{"x":2,"actual":1.323975871605075,"recon":1.323975871605075},
{"x":3,"actual":-0.8041415779212032,"recon":-0.8041415779212033},
{"x":4,"actual":-1.1655099115971852,"recon":-1.165509911597185},
{"x":5,"actual":-0.9246227347782955,"recon":-0.9246227347782955},
{"x":6,"actual":2.3076541548609963,"recon":2.307654154860996},
{"x":7,"actual":1.0275525442743354,"recon":1.0275525442743354},
{"x":8,"actual":-1.6171073899977824,"recon":-1.6171073899977824},
{"x":9,"actual":0.17619718957134095,"recon":0.17619718957134084},
{"x":10,"actual":-1.3327935030351896,"recon":-1.3327935030351896},
{"x":11,"actual":1.3975173413848279,"recon":1.3975173413848285},
{"x":12,"actual":-1.4238698713905256,"recon":-1.4238698713905256},
{"x":13,"actual":0.7066139156590852,"recon":0.7066139156590853},
{"x":14,"actual":-0.7919054131663745,"recon":-0.7919054131663746},
{"x":15,"actual":-0.6194707428946498,"recon":-0.6194707428946499},
{"x":16,"actual":1.32178266536062,"recon":1.32178266536062},
{"x":17,"actual":-0.3935313962819023,"recon":-0.39353139628190226},
{"x":18,"actual":0.44950129001214406,"recon":0.4495012900121441},
{"x":19,"actual":0.9211863042765286,"recon":0.9211863042765285},
{"x":20,"actual":-0.6409964508362196,"recon":-0.6409964508362196},
{"x":21,"actual":0.5342342153530135,"recon":0.5342342153530135},
{"x":22,"actual":0.09357484119899823,"recon":0.09357484119899821},
{"x":23,"actual":0.7491657589973484,"recon":0.7491657589973486},
{"x":24,"actual":1.0663610479200738,"recon":1.0663610479200738},
{"x":25,"actual":1.977331287458031,"recon":1.9773312874580316},
{"x":26,"actual":2.0994845194414373,"recon":2.099484519441437},
{"x":27,"actual":-0.36398919596652585,"recon":-0.36398919596652596},
{"x":28,"actual":-0.855739980417965,"recon":-0.8557399804179648},
{"x":29,"actual":-0.05666882679673377,"recon":-0.056668826796733754},
{"x":30,"actual":-1.1614406320618373,"recon":-1.161440632061837},
{"x":31,"actual":-0.9562572809521593,"recon":-0.9562572809521594},
{"x":32,"actual":0.4152131511454801,"recon":0.41521315114548},
{"x":33,"actual":-1.315639860466744,"recon":-1.3156398604667445},
{"x":34,"actual":-0.05087109223761541,"recon":-0.05087109223761542},
{"x":35,"actual":1.0334495056036175,"recon":1.0334495056036173},
{"x":36,"actual":0.8620647837362881,"recon":0.862064783736288},
{"x":37,"actual":2.0808963275770727,"recon":2.0808963275770727},
{"x":38,"actual":-2.115011799316482,"recon":-2.1150117993164823},
{"x":39,"actual":-0.9033410413706305,"recon":-0.9033410413706304},
{"x":40,"actual":-0.2646625661112143,"recon":-0.26466256611121425},
{"x":41,"actual":0.9047070809652977,"recon":0.9047070809652977},
{"x":42,"actual":1.3947301251993889,"recon":1.394730125199389},
{"x":43,"actual":-0.5999208081799463,"recon":-0.5999208081799463},
{"x":44,"actual":0.05089817228164207,"recon":0.050898172281642},
{"x":45,"actual":0.5437826547935463,"recon":0.5437826547935463},
{"x":46,"actual":-0.5567078801026357,"recon":-0.5567078801026359},
{"x":47,"actual":1.2853890899552018,"recon":1.2853890899552018},
{"x":48,"actual":0.059617440705236356,"recon":0.05961744070523635},
{"x":49,"actual":0.6573385897550387,"recon":0.6573385897550386},
{"x":50,"actual":-1.0083296558662211,"recon":-1.0083296558662214},
{"x":51,"actual":-0.4119250683758798,"recon":-0.4119250683758798},
{"x":52,"actual":0.8033807444422357,"recon":0.8033807444422357},
{"x":53,"actual":0.9420493012868197,"recon":0.9420493012868196},
{"x":54,"actual":0.46891746655613004,"recon":0.46891746655613},
{"x":55,"actual":-0.4101746130919481,"recon":-0.4101746130919481},
{"x":56,"actual":0.4521132749302398,"recon":0.45211327493023984},
{"x":57,"actual":0.1519376986784811,"recon":0.15193769867848111},
{"x":58,"actual":-0.1476440535801423,"recon":-0.14764405358014232},
{"x":59,"actual":0.03282256047066197,"recon":0.03282256047066198},
{"x":60,"actual":-0.38174227184416837,"recon":-0.38174227184416837},
{"x":61,"actual":-0.22223606896154458,"recon":-0.22223606896154458},
{"x":62,"actual":-0.2806554359073341,"recon":-0.28065543590733416},
{"x":63,"actual":-0.6545313587287397,"recon":-0.6545313587287398},
{"x":64,"actual":-0.921206698998353,"recon":-0.921206698998353},
{"x":65,"actual":-0.7974569319655386,"recon":-0.7974569319655386},
{"x":66,"actual":-1.7681147369543984,"recon":-1.7681147369543986},
{"x":67,"actual":1.5592202059748197,"recon":1.55922020597482},
{"x":68,"actual":1.3234147762643247,"recon":1.3234147762643245},
{"x":69,"actual":1.7669108058489738,"recon":1.766910805848974},
{"x":70,"actual":3.092335453036495,"recon":3.0923354530364953},
{"x":71,"actual":0.0589335626708041,"recon":0.058933562670804074},
{"x":72,"actual":0.8122242402425549,"recon":0.8122242402425549},
{"x":73,"actual":0.4166566664211206,"recon":0.41665666642112065},
{"x":74,"actual":1.3567245858996066,"recon":1.3567245858996062},
{"x":75,"actual":-1.3787288672364928,"recon":-1.3787288672364924},
{"x":76,"actual":0.44510276435631296,"recon":0.445102764356313},
{"x":77,"actual":-1.498779649132977,"recon":-1.4987796491329768},
{"x":78,"actual":0.9877102131553351,"recon":0.9877102131553352},
{"x":79,"actual":-0.8686697638023346,"recon":-0.8686697638023347},
{"x":80,"actual":-2.2900288786614977,"recon":-2.2900288786614973},
{"x":81,"actual":0.19564526070636978,"recon":0.19564526070636978},
{"x":82,"actual":0.2252020631506597,"recon":0.22520206315065966},
{"x":83,"actual":0.6571200979379376,"recon":0.6571200979379375},
{"x":84,"actual":0.1700599834925016,"recon":0.1700599834925016},
{"x":85,"actual":-2.3545333464182,"recon":-2.3545333464182},
{"x":86,"actual":0.612015210723305,"recon":0.6120152107233051},
{"x":87,"actual":1.5225847518077407,"recon":1.5225847518077407},
{"x":88,"actual":0.5081896772657628,"recon":0.5081896772657629},
{"x":89,"actual":-0.6569108131557121,"recon":-0.6569108131557121},
{"x":90,"actual":1.4709888286381116,"recon":1.4709888286381119},
{"x":91,"actual":0.05550536721900871,"recon":0.055505367219008686},
{"x":92,"actual":-0.2605184061518979,"recon":-0.260518406151898},
{"x":93,"actual":-0.4283817665191817,"recon":-0.4283817665191817},
{"x":94,"actual":2.2972661107427217,"recon":2.297266110742721},
{"x":95,"actual":-0.4452962480229775,"recon":-0.4452962480229775},
{"x":96,"actual":-0.030646661058542215,"recon":-0.030646661058542204},
{"x":97,"actual":0.41915183180234333,"recon":0.4191518318023433},
{"x":98,"actual":0.3776419608397371,"recon":0.37764196083973706},
{"x":99,"actual":-0.40949263058355917,"recon":-0.4094926305835592},
{"x":100,"actual":0.9742318744503455,"recon":0.9742318744503453},
{"x":101,"actual":0.2974076897943349,"recon":0.2974076897943349},
{"x":102,"actual":0.23529194540689172,"recon":0.23529194540689172},
{"x":103,"actual":0.8634660777105375,"recon":0.8634660777105375},
{"x":104,"actual":1.7607359961443714,"recon":1.7607359961443716},
{"x":105,"actual":-0.05655106450609967,"recon":-0.056551064506099646},
{"x":106,"actual":-0.2866575202346469,"recon":-0.2866575202346469},
{"x":107,"actual":-0.27222183112980736,"recon":-0.27222183112980736},
{"x":108,"actual":-0.2649602218613045,"recon":-0.26496022186130447},
{"x":109,"actual":0.5963069801128221,"recon":0.5963069801128221},
{"x":110,"actual":-0.00013367423923507028,"recon":-0.00013367423923505914},
{"x":111,"actual":-0.6070878318356983,"recon":-0.6070878318356981},
{"x":112,"actual":2.224396176764023,"recon":2.2243961767640235},
{"x":113,"actual":0.23772286970783252,"recon":0.23772286970783252},
{"x":114,"actual":0.6188674851834027,"recon":0.6188674851834026},
{"x":115,"actual":-1.076422931825682,"recon":-1.0764229318256817},
{"x":116,"actual":0.3866769552346083,"recon":0.38667695523460827},
{"x":117,"actual":-1.459185409253881,"recon":-1.4591854092538807},
{"x":118,"actual":-0.8500452479101577,"recon":-0.8500452479101575},
{"x":119,"actual":-0.4313796624976538,"recon":-0.4313796624976537},
{"x":120,"actual":-1.624217101394816,"recon":-1.6242171013948157},
{"x":121,"actual":-0.37012628454589436,"recon":-0.37012628454589436},
{"x":122,"actual":-1.7625500906841063,"recon":-1.7625500906841058},
{"x":123,"actual":-0.5611061729247279,"recon":-0.561106172924728},
{"x":124,"actual":-0.2895568836710555,"recon":-0.28955688367105553},
{"x":125,"actual":0.6754693016413936,"recon":0.6754693016413937},
{"x":126,"actual":-0.026160923986081,"recon":-0.02616092398608099},
{"x":127,"actual":-0.6766588749954937,"recon":-0.6766588749954935},
{"x":128,"actual":-1.1185476958343452,"recon":-1.1185476958343452},
{"x":129,"actual":-1.4460043618496627,"recon":-1.4460043618496623},
{"x":130,"actual":0.6561591947610586,"recon":0.6561591947610586},
{"x":131,"actual":-1.5986099561386793,"recon":-1.5986099561386797},
{"x":132,"actual":-1.1212122494458416,"recon":-1.1212122494458414},
{"x":133,"actual":1.0007289545358482,"recon":1.000728954535848},
{"x":134,"actual":0.13602112157938387,"recon":0.13602112157938387},
{"x":135,"actual":-1.0400475153350763,"recon":-1.0400475153350761},
{"x":136,"actual":0.18671797044774888,"recon":0.18671797044774885},
{"x":137,"actual":0.6566693617250339,"recon":0.6566693617250339},
{"x":138,"actual":0.48743663948916544,"recon":0.48743663948916544},
{"x":139,"actual":-0.90463564590532,"recon":-0.9046356459053198},
{"x":140,"actual":1.1730823207585723,"recon":1.1730823207585725},
{"x":141,"actual":-1.6583999785404366,"recon":-1.6583999785404369},
{"x":142,"actual":-2.2557034711858157,"recon":-2.2557034711858157},
{"x":143,"actual":-1.1185090759217067,"recon":-1.1185090759217065},
{"x":144,"actual":1.0555882552113194,"recon":1.0555882552113194},
{"x":145,"actual":-0.628736669580362,"recon":-0.6287366695803619},
{"x":146,"actual":0.12184910843768444,"recon":0.12184910843768446},
{"x":147,"actual":0.5449485890722736,"recon":0.5449485890722738},
{"x":148,"actual":1.4484398463986885,"recon":1.4484398463986885},
{"x":149,"actual":-0.5401843692010122,"recon":-0.540184369201012},
{"x":150,"actual":1.2729232950743827,"recon":1.2729232950743825},
{"x":151,"actual":0.3271453925507159,"recon":0.3271453925507159},
{"x":152,"actual":-0.08243284186954149,"recon":-0.08243284186954149},
{"x":153,"actual":-2.023997041757974,"recon":-2.0239970417579745},
{"x":154,"actual":2.330716660559953,"recon":2.330716660559953},
{"x":155,"actual":0.841070900164472,"recon":0.8410709001644718},
{"x":156,"actual":0.5084264149423802,"recon":0.5084264149423801},
{"x":157,"actual":0.606611989675059,"recon":0.606611989675059},
{"x":158,"actual":0.03594153263602316,"recon":0.035941532636023135},
{"x":159,"actual":-0.3545493610032292,"recon":-0.3545493610032291},
{"x":160,"actual":0.013670241392378725,"recon":0.01367024139237873},
{"x":161,"actual":-0.9235331999030975,"recon":-0.9235331999030973},
{"x":162,"actual":-0.9472553947980346,"recon":-0.9472553947980342},
{"x":163,"actual":-0.3744684863753504,"recon":-0.3744684863753504},
{"x":164,"actual":0.9230604066197271,"recon":0.9230604066197272},
{"x":165,"actual":0.24171437891302974,"recon":0.24171437891302971},
{"x":166,"actual":-0.9622698419491902,"recon":-0.9622698419491902},
{"x":167,"actual":-0.5235090099357067,"recon":-0.5235090099357066},
{"x":168,"actual":-0.8782950528783456,"recon":-0.8782950528783455},
{"x":169,"actual":-1.259169732523158,"recon":-1.2591697325231581},
{"x":170,"actual":-0.007503873195676641,"recon":-0.007503873195676632},
{"x":171,"actual":0.6860692241305412,"recon":0.6860692241305414},
{"x":172,"actual":0.6286294990558308,"recon":0.6286294990558305},
{"x":173,"actual":-0.2626876289814083,"recon":-0.26268762898140835},
{"x":174,"actual":0.07240890596173186,"recon":0.07240890596173187},
{"x":175,"actual":-0.4821429477055285,"recon":-0.4821429477055285},
{"x":176,"actual":0.6238132766456986,"recon":0.6238132766456986},
{"x":177,"actual":-0.6688050156870146,"recon":-0.6688050156870146},
{"x":178,"actual":2.5634425899353412,"recon":2.5634425899353412},
{"x":179,"actual":0.26675091424816766,"recon":0.26675091424816766},
{"x":180,"actual":0.7027050476756311,"recon":0.7027050476756314},
{"x":181,"actual":-0.8616887360341875,"recon":-0.8616887360341875},
{"x":182,"actual":-0.9377081170271454,"recon":-0.9377081170271456},
{"x":183,"actual":1.4076921573784222,"recon":1.4076921573784227},
{"x":184,"actual":0.15429709562267718,"recon":0.15429709562267716},
{"x":185,"actual":-0.8992343539933253,"recon":-0.8992343539933254},
{"x":186,"actual":1.241606219601032,"recon":1.241606219601032},
{"x":187,"actual":0.01352407519538925,"recon":0.01352407519538925},
{"x":188,"actual":0.9020650961416244,"recon":0.9020650961416246},
{"x":189,"actual":-0.1955682838200366,"recon":-0.19556828382003655},
{"x":190,"actual":-0.8391651431317134,"recon":-0.8391651431317134},
{"x":191,"actual":0.6500651710492259,"recon":0.6500651710492256},
{"x":192,"actual":-0.5703339197714097,"recon":-0.5703339197714097},
{"x":193,"actual":0.32253431440008906,"recon":0.322534314400089},
{"x":194,"actual":-2.2082380228361496,"recon":-2.2082380228361496},
{"x":195,"actual":0.09418448534249216,"recon":0.09418448534249216},
{"x":196,"actual":0.4892481602410152,"recon":0.4892481602410152},
{"x":197,"actual":-1.5540376186631135,"recon":-1.5540376186631133},
{"x":198,"actual":-0.721852771459946,"recon":-0.7218527714599456}];
    const series = [{"name":"Actual","color":"#1f77b4","key":"actual","dash":""},{"name":"Reconstructed","color":"#ff7f0e","key":"recon","dash":"6,3"}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#bhd_line_60');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Historical Decomposition (cholesky)</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #fff;
    color: #333;
    padding: 20px;
}
.figure-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 16px;
    color: #222;
}
.figure-source {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 8px;
}
.panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
}
.panel {
    width: calc(100% - 16px);
    min-width: 300px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 12px;
}
.panel-title {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: #444;
}
.axis text { font-size: 11px; fill: #666; }
.axis line, .axis path { stroke: #ccc; }
.grid line { stroke: #f0f0f0; stroke-dasharray: 2,2; }
.grid .domain { stroke: none; }
.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
}
.legend { font-size: 11px; }
.legend rect { rx: 2; }
svg { overflow: visible; }
</style>
</head>
<body>
<div class="figure-title">Historical Decomposition (cholesky)</div>
<div class="panel-grid">
<div class="panel">
<div class="panel-title">Var 1 — Shock Contributions</div>
<div id="hd_bar_49"></div>
</div>
<div class="panel">
<div class="panel-title">Var 1 — Actual vs Decomposition</div>
<div id="hd_line_50"></div>
</div>
<div class="panel">
<div class="panel-title">Var 2 — Shock Contributions</div>
<div id="hd_bar_51"></div>
</div>
<div class="panel">
<div class="panel-title">Var 2 — Actual vs Decomposition</div>
<div id="hd_line_52"></div>
</div>
<div class="panel">
<div class="panel-title">Var 3 — Shock Contributions</div>
<div id="hd_bar_53"></div>
</div>
<div class="panel">
<div class="panel-title">Var 3 — Actual vs Decomposition</div>
<div id="hd_line_54"></div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// Shared utilities
const tooltip = d3.select('#tooltip');
function fmt(v) {
    if (v === null || v === undefined) return '';
    return Math.abs(v) >= 1000 ? v.toFixed(1) : (Math.abs(v) >= 1 ? v.toFixed(3) : v.toFixed(4));
}
function showTip(evt, html) {
    tooltip.html(html).style('opacity',1)
        .style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px');
}
function hideTip() { tooltip.style('opacity',0); }

(function() {
    const data = [{"x":1,"s1":-0.32993159690033247,"s2":0.0,"s3":0.0},
{"x":2,"s1":-0.1738766516578952,"s2":-0.112129508706787,"s3":-0.00047313481722768255},
{"x":3,"s1":1.0922866047958664,"s2":-0.20715257360105438,"s3":0.0196253087212432},
{"x":4,"s1":0.6394740433248886,"s2":-0.17108928676027757,"s3":0.05224456898376538},
{"x":5,"s1":-0.44727816646460716,"s2":-0.33465849767188427,"s3":-0.044119018947571496},
{"x":6,"s1":-1.3771745012353447,"s2":0.021370057556142626,"s3":-0.08215038336579723},
{"x":7,"s1":-2.381985190129525,"s2":0.3306204508183063,"s3":-0.03012363099904265},
{"x":8,"s1":-0.27885966865770095,"s2":0.23592709171275145,"s3":0.11924513369191936},
{"x":9,"s1":-1.0102772528729635,"s2":0.1300912257518125,"s3":0.08706406014000106},
{"x":10,"s1":0.7634862654409594,"s2":0.21491582100540726,"s3":-0.10601399029750169},
{"x":11,"s1":0.20343017746891762,"s2":0.3000302549015455,"s3":-0.03745412487907728},
{"x":12,"s1":-0.5018599460581026,"s2":0.16344615157543024,"s3":-0.024897014266695137},
{"x":13,"s1":0.35525047033940443,"s2":0.13748597505241492,"s3":0.05652001959758891},
{"x":14,"s1":1.3536567580975347,"s2":0.14325857717436333,"s3":-0.017569249679412317},
{"x":15,"s1":-0.22294659813424123,"s2":0.16627706043665214,"s3":-0.004286486457712895},
{"x":16,"s1":-1.3225316216993215,"s2":0.08997791659117584,"s3":-0.007909663245816646},
{"x":17,"s1":-0.12237599199411044,"s2":-0.12351798686705283,"s3":-0.0327276295208251},
{"x":18,"s1":-0.02497069330861154,"s2":-0.11082387035586819,"s3":0.07133574941020572},
{"x":19,"s1":-1.2043970523151835,"s2":-0.15205778102505427,"s3":0.005766315070459227},
{"x":20,"s1":-1.523086796842317,"s2":0.10751542124965188,"s3":-0.014753234613775342},
{"x":21,"s1":1.2052039394441159,"s2":0.08959121702854388,"s3":0.038298572040369086},
{"x":22,"s1":2.4383105675287067,"s2":-0.11358227252162585,"s3":-0.026326393529830478},
{"x":23,"s1":1.740841030197966,"s2":-0.188752489986945,"s3":-0.007574343852548989},
{"x":24,"s1":0.6936248589105941,"s2":-0.016285882478802752,"s3":0.0036322524155901303},
{"x":25,"s1":1.1252900135140134,"s2":-0.2050238296611697,"s3":0.011800314397450867},
{"x":26,"s1":0.4440798104940573,"s2":-0.16530210744643112,"s3":0.03750239569547793},
{"x":27,"s1":0.8634058745621335,"s2":0.2164663080821044,"s3":0.05583830770064173},
{"x":28,"s1":0.37776291404834195,"s2":0.2663045471627481,"s3":0.05193745977693926},
{"x":29,"s1":-0.018874903225612014,"s2":0.2827975087626627,"s3":-0.06052976241258512},
{"x":30,"s1":1.0335459880025037,"s2":0.2107265630646543,"s3":-0.09223206444443689},
{"x":31,"s1":1.800516341652325,"s2":0.15683680118089352,"s3":-0.004476880264819101},
{"x":32,"s1":0.8760272058688003,"s2":-0.021296507439723895,"s3":-0.021959649238120955},
{"x":33,"s1":-0.31488525700802683,"s2":-0.002038317780075752,"s3":-0.036565285216576274},
{"x":34,"s1":-0.23717600109682144,"s2":-0.21008333751260178,"s3":0.039656445332136886},
{"x":35,"s1":1.0844311132309628,"s2":-0.4072521055649118,"s3":-0.015173969751509078},
{"x":36,"s1":0.21481440850558214,"s2":-0.2453494664707445,"s3":-0.006954950038332549},
{"x":37,"s1":-0.791184469097326,"s2":-0.01579455127840117,"s3":0.06018922098013016},
{"x":38,"s1":-1.2014071309968255,"s2":0.3162794729310973,"s3":0.03850786054735806},
{"x":39,"s1":0.24282210612514643,"s2":-0.028661210863928237,"s3":0.062014024471990704},
{"x":40,"s1":0.6000026726390889,"s2":-0.15374132171671512,"s3":-0.09176622512662846},
{"x":41,"s1":2.1518464343994235,"s2":0.015023005839943716,"s3":-0.09364631308643365},
{"x":42,"s1":-0.11243724901597346,"s2":-0.03824226412848879,"s3":0.017567338970570452},
{"x":43,"s1":-0.30754539406806897,"s2":0.10892251548252657,"s3":0.05978562361365739},
{"x":44,"s1":-0.8686878669106725,"s2":0.01702319443481766,"s3":0.06867161238226271},
{"x":45,"s1":-0.4924493387140421,"s2":-0.34073228941840283,"s3":-0.035241487542463236},
{"x":46,"s1":0.22082118946129264,"s2":-0.3488765078426908,"s3":-0.032829657065124945},
{"x":47,"s1":-0.8646197937854089,"s2":-0.12851206471714954,"s3":0.02687985355374646},
{"x":48,"s1":-1.4849948248786249,"s2":0.0005318771712001858,"s3":-0.024477258800473776},
{"x":49,"s1":-0.38934372040483667,"s2":-0.23372613220338692,"s3":0.03548694949077097},
{"x":50,"s1":0.9143808616491137,"s2":-0.26884698258945683,"s3":0.022293022117609664},
{"x":51,"s1":-0.3399325984722317,"s2":-0.10526261179839061,"s3":-0.0013054118328498564},
{"x":52,"s1":1.063357264940641,"s2":0.0170930238503178,"s3":-0.05363242753712044},
{"x":53,"s1":0.3723131214207473,"s2":0.026490080968092515,"s3":-0.036345785318019436},
{"x":54,"s1":0.44950157645061395,"s2":-0.08725917614316892,"s3":0.04736882844950022},
{"x":55,"s1":-1.637759014009437,"s2":-0.11666313826765594,"s3":0.05336093103217073},
{"x":56,"s1":-0.9238193859925119,"s2":0.044291127544968334,"s3":0.004279514389085125},
{"x":57,"s1":1.094130319022155,"s2":0.2884443048376073,"s3":-0.03943507961053289},
{"x":58,"s1":-0.2801955384022194,"s2":0.3362484886649587,"s3":2.0380701841269355e-5},
{"x":59,"s1":1.3166500488283792,"s2":-0.06992393358704065,"s3":0.010693131668761138},
{"x":60,"s1":1.310259238325849,"s2":0.03388447735700211,"s3":-0.007649583890451739},
{"x":61,"s1":-0.5551106689824975,"s2":0.15756074251954907,"s3":-0.010345130127279474},
{"x":62,"s1":-1.6452516363399978,"s2":-0.08220833035413751,"s3":-0.02036075906677043},
{"x":63,"s1":1.043896970706289,"s2":-0.050646444047178434,"s3":-0.002780331833252856},
{"x":64,"s1":-1.1031077856256448,"s2":-0.043319944890048014,"s3":0.0052975000358044125},
{"x":65,"s1":0.6140617049526391,"s2":-0.017848682289055173,"s3":-0.022548379303468043},
{"x":66,"s1":-2.0245707376718025,"s2":-0.04219668920536379,"s3":-0.02623583698617017},
{"x":67,"s1":-0.18546818514075353,"s2":-0.25881877978713996,"s3":-0.014605442245880226},
{"x":68,"s1":-0.07936103820353002,"s2":-0.3946754155310797,"s3":-0.03818883197183073},
{"x":69,"s1":-0.9356207776585379,"s2":-0.16194368420079966,"s3":0.07865222910614723},
{"x":70,"s1":1.4065909764145663,"s2":-0.26928387457343317,"s3":0.09277475648713718},
{"x":71,"s1":0.7324042019002528,"s2":0.18583176427420176,"s3":0.04389054450372921},
{"x":72,"s1":-0.4825633467255773,"s2":0.41052558090917296,"s3":0.07213023105611113},
{"x":73,"s1":-1.0848848406440799,"s2":0.2717608691801449,"s3":-0.046332026625270306},
{"x":74,"s1":0.925435373740335,"s2":0.06628175284663845,"s3":-0.04481644662644147},
{"x":75,"s1":-1.6208863487123246,"s2":0.05332308367194718,"s3":0.004071169099178108},
{"x":76,"s1":-0.734854245764769,"s2":0.28380830564684906,"s3":0.02911974459658466},
{"x":77,"s1":0.09354142594145358,"s2":0.04610018255635282,"s3":-0.06256801519125839},
{"x":78,"s1":-0.6087357108910187,"s2":-0.1364882449553591,"s3":-0.014937282493165453},
{"x":79,"s1":0.4451283752627124,"s2":-0.006488337621764782,"s3":-0.033272515783543725},
{"x":80,"s1":-1.3816739998901717,"s2":-0.020786250616480893,"s3":0.029925428225977463},
{"x":81,"s1":-1.068106910543524,"s2":-0.1365078622065103,"s3":0.001967978756607095},
{"x":82,"s1":0.04565342583601406,"s2":-0.03894517535916344,"s3":-0.09989292646313197},
{"x":83,"s1":-0.6244650234326837,"s2":-0.14733750219239097,"s3":0.018267884360734676},
{"x":84,"s1":0.012836812985072173,"s2":-0.4544600528409672,"s3":0.06564673023268411},
{"x":85,"s1":-1.3854810803311775,"s2":-0.3476523697332184,"s3":0.03845615828198603},
{"x":86,"s1":0.7313532377091005,"s2":-0.14217625980953155,"s3":2.1780343758027237e-5},
{"x":87,"s1":-0.3949952633277574,"s2":0.1445171579026885,"s3":-0.10885335366968371},
{"x":88,"s1":-0.40568007102399606,"s2":0.1832667031772689,"s3":0.003773052657033204},
{"x":89,"s1":0.7220819988172067,"s2":0.2169411899644088,"s3":0.11493805451499649},
{"x":90,"s1":-0.10438168689656936,"s2":0.10733764837963312,"s3":0.028226464839022622},
{"x":91,"s1":-1.3894494978015834,"s2":-0.012875328995092987,"s3":-0.06632911580921602},
{"x":92,"s1":0.18928801701919348,"s2":0.07403779751909481,"s3":0.03172111828179019},
{"x":93,"s1":-1.2679426624890506,"s2":0.21726123817798973,"s3":0.021685858866549387},
{"x":94,"s1":0.9926355743092509,"s2":0.1180846569312522,"s3":-0.042177391329091075},
{"x":95,"s1":0.543433169022486,"s2":0.23759087046802135,"s3":-0.025437161933182538},
{"x":96,"s1":0.6030490900914034,"s2":0.19497804241471775,"s3":0.0882554896840952},
{"x":97,"s1":0.47755635700218096,"s2":-0.07499410699428449,"s3":-0.0022331256766827475},
{"x":98,"s1":0.19294957893385048,"s2":-0.15535671035575513,"s3":-0.0520316209832027},
{"x":99,"s1":1.4582114901094119,"s2":0.27286314418583785,"s3":0.009231873271285886},
{"x":100,"s1":-1.0918438595524438,"s2":0.0792115977241755,"s3":0.01370704372846114},
{"x":101,"s1":-0.21204333500538008,"s2":0.12529646541024358,"s3":-0.02554456513225203},
{"x":102,"s1":-1.8116494796570404,"s2":0.18719217049634992,"s3":0.029661370732073904},
{"x":103,"s1":-0.19063524572622859,"s2":0.13863966562569877,"s3":0.02194285930259933},
{"x":104,"s1":0.20176283740032083,"s2":0.051212898416568266,"s3":-0.006461206361957919},
{"x":105,"s1":1.3259442132970771,"s2":0.2153507658263709,"s3":0.020271459680137827},
{"x":106,"s1":0.034308340564414515,"s2":0.2163367734991304,"s3":0.05584998773132398},
{"x":107,"s1":1.9841360840782054,"s2":-0.1991587734861493,"s3":-0.023777194932104118},
{"x":108,"s1":-0.3793163686889275,"s2":-0.4136820443055776,"s3":-0.05339203957514563},
{"x":109,"s1":-0.43150711977944745,"s2":0.06069285930264457,"s3":-0.02512177980339384},
{"x":110,"s1":-0.4675723710755803,"s2":0.2376678189544615,"s3":-0.0106916720223531},
{"x":111,"s1":-0.8010695485015804,"s2":-0.03570369592597688,"s3":0.033712592001607436},
{"x":112,"s1":0.7596985012443098,"s2":0.21119922505293315,"s3":0.01647816520849301},
{"x":113,"s1":1.1819537892416272,"s2":0.13032654603344523,"s3":-0.03627839751926905},
{"x":114,"s1":0.6766815813004258,"s2":-0.11098241085855569,"s3":0.0755892882872196},
{"x":115,"s1":-0.2567779916066166,"s2":-0.07846683286889905,"s3":0.026578754207394792},
{"x":116,"s1":-1.83638255685159,"s2":0.03288085670275351,"s3":-0.02673714043123955},
{"x":117,"s1":-1.5016388432713696,"s2":-0.2139823538647525,"s3":-0.059413300275093076},
{"x":118,"s1":-0.1558411958008659,"s2":-0.11923841229658501,"s3":0.005049892286917874},
{"x":119,"s1":0.7334788393170718,"s2":-0.15077249823486139,"s3":-0.027038317415376125},
{"x":120,"s1":0.4996139395543959,"s2":-0.10999009825744724,"s3":-0.040938548726040275},
{"x":121,"s1":-0.30726779345542765,"s2":0.09200966030926055,"s3":0.01033194441855173},
{"x":122,"s1":-1.0491668647364525,"s2":0.12362652585695406,"s3":-0.03843281752534242},
{"x":123,"s1":0.25797956111221193,"s2":-0.027903360853524992,"s3":0.0008795893855841258},
{"x":124,"s1":0.06442239481498693,"s2":0.12531833748659452,"s3":-0.02051202056529286},
{"x":125,"s1":0.06508922318165622,"s2":0.09573526743286424,"s3":-0.009422340297396484},
{"x":126,"s1":-0.08319870466153283,"s2":-0.06009404739392474,"s3":0.029859708635346115},
{"x":127,"s1":0.40514912178360973,"s2":0.02208176830417731,"s3":0.05041732509514301},
{"x":128,"s1":-0.340713418548201,"s2":0.060905950980885186,"s3":0.010588729112683659},
{"x":129,"s1":0.6914360941316455,"s2":0.20172311122217262,"s3":-0.04237399301640419},
{"x":130,"s1":0.2702314162567017,"s2":0.09094539090808607,"s3":-0.04609086802193452},
{"x":131,"s1":-0.6387697031898966,"s2":0.02662581658101627,"s3":-0.04174617713142517},
{"x":132,"s1":-1.6673702325738795,"s2":0.11035435605530207,"s3":0.05342877976199047},
{"x":133,"s1":-0.8436016439261755,"s2":0.04269936969169068,"s3":-0.0153721720926941},
{"x":134,"s1":0.6330041479457589,"s2":0.0009467952122797314,"s3":-0.04868752775033044},
{"x":135,"s1":-1.2986828991336523,"s2":0.15638872791214778,"s3":0.07066200627489781},
{"x":136,"s1":1.1173789587252718,"s2":0.3180358784944921,"s3":0.03825556765459633},
{"x":137,"s1":-0.9704109313611553,"s2":0.19334443312515207,"s3":-0.053783734325618074},
{"x":138,"s1":-0.28834285921175995,"s2":-0.08110181570572506,"s3":-0.007147501425220176},
{"x":139,"s1":0.16745272131413377,"s2":-0.09287433663351875,"s3":0.05226761671900455},
{"x":140,"s1":-0.46026817272282483,"s2":0.14083236636569246,"s3":0.023959376301636207},
{"x":141,"s1":1.5582134762488389,"s2":0.05133900307360851,"s3":-0.056752261437730614},
{"x":142,"s1":0.42641400224447545,"s2":0.05845133089254299,"s3":0.029425593026410395},
{"x":143,"s1":0.3142652597523913,"s2":0.10882456564516965,"s3":-0.04293453616318038},
{"x":144,"s1":0.9846096116464336,"s2":0.2409772219864198,"s3":-0.11368441662883003},
{"x":145,"s1":0.886392756376388,"s2":-0.11766456809553909,"s3":-0.01663535779087828},
{"x":146,"s1":0.0625181228584485,"s2":-0.5367475469039392,"s3":0.10235822373136562},
{"x":147,"s1":-0.47197328001315275,"s2":-0.5542080224297538,"s3":0.02172295005432176},
{"x":148,"s1":-0.5734437172603507,"s2":-0.42170367916835716,"s3":-0.0184162011496919},
{"x":149,"s1":0.6121818956651316,"s2":-0.4484984535282501,"s3":0.02533256676001307},
{"x":150,"s1":-0.4611209941212238,"s2":-0.05649592061889846,"s3":0.0593447154255803},
{"x":151,"s1":0.15568357948689163,"s2":0.15395512790286242,"s3":-0.03585832336465044},
{"x":152,"s1":-0.919776684930648,"s2":-0.1525953193606548,"s3":0.009178687327588446},
{"x":153,"s1":-0.216527812059273,"s2":-0.17851909258968585,"s3":0.0248323619841802},
{"x":154,"s1":-1.1041392458455603,"s2":-0.24618483243801392,"s3":-0.024126049986381726},
{"x":155,"s1":-0.6748012205317767,"s2":-0.140042548253455,"s3":-0.09524016362243636},
{"x":156,"s1":0.5992062316379663,"s2":-0.1536709268221037,"s3":0.08214660563351661},
{"x":157,"s1":1.139510205872384,"s2":0.05118453430614253,"s3":0.08705150440607037},
{"x":158,"s1":-1.2634985825555467,"s2":-0.30644401835609714,"s3":-0.02619430833575872},
{"x":159,"s1":1.0751665589659738,"s2":-0.1679165276584674,"s3":-0.011592079864439761},
{"x":160,"s1":0.8437923039638155,"s2":0.05533622759352866,"s3":-0.01242609774635311},
{"x":161,"s1":-0.7233549218561304,"s2":-0.08101346427797024,"s3":-0.03589375302995736},
{"x":162,"s1":1.5416788115995244,"s2":-0.08073437070379215,"s3":-0.005682215528716884},
{"x":163,"s1":-1.0187574853156032,"s2":0.17289103799558667,"s3":-0.020857939664442635},
{"x":164,"s1":0.4534223092134805,"s2":0.2168753460420445,"s3":-0.04294927872367141},
{"x":165,"s1":0.8585656357749475,"s2":0.078212253346044,"s3":0.006952712680923884},
{"x":166,"s1":-0.21743887494918443,"s2":-0.14160651454746073,"s3":0.06594275317063222},
{"x":167,"s1":-1.0103979740365152,"s2":-0.05101589292199796,"s3":0.025251650607552394},
{"x":168,"s1":2.3980360271770436,"s2":0.08227404835349066,"s3":-0.05646367995697529},
{"x":169,"s1":-0.02184325778932319,"s2":-0.07871618007707637,"s3":-0.03144770088765204},
{"x":170,"s1":0.8601661920949322,"s2":0.08548184154675949,"s3":-0.01824856194279294},
{"x":171,"s1":-0.48139923667206486,"s2":0.16373223558460392,"s3":-0.03262035693802449},
{"x":172,"s1":-0.33365557704797416,"s2":0.2249424654665963,"s3":0.01961056451392411},
{"x":173,"s1":0.16994605052327516,"s2":0.34028081344972655,"s3":0.06170817563491139},
{"x":174,"s1":0.7512797073797586,"s2":-0.052064399895138364,"s3":0.03664310151873778},
{"x":175,"s1":-2.240796643696954,"s2":-0.4541277379097417,"s3":-0.02097824366527826},
{"x":176,"s1":-0.05323986137486816,"s2":-0.39578294634950967,"s3":-0.016735571516294196},
{"x":177,"s1":1.1835842993351822,"s2":0.09171884540900041,"s3":-0.014005773776823651},
{"x":178,"s1":2.0607959648851613,"s2":0.26530674996992715,"s3":0.016325461868817146},
{"x":179,"s1":0.4082981893308214,"s2":-0.07097491257456502,"s3":-0.02115374245096109},
{"x":180,"s1":1.1944815330147478,"s2":-0.28486275054552895,"s3":0.08409544620538306},
{"x":181,"s1":0.4014229039135612,"s2":-0.2113919244683843,"s3":0.030132933474921027},
{"x":182,"s1":1.4817892225157243,"s2":-0.16742455732574407,"s3":-0.03375710826871948},
{"x":183,"s1":0.372700627186501,"s2":0.08284264839638013,"s3":-0.05443625628186709},
{"x":184,"s1":0.2925689984202062,"s2":0.3472648177703471,"s3":-0.061599401905090764},
{"x":185,"s1":-0.2091565198939104,"s2":0.5441881118592564,"s3":0.06689930633029875},
{"x":186,"s1":-1.4092361856869637,"s2":0.41859906172894523,"s3":0.04033023699247138},
{"x":187,"s1":0.6535413363193984,"s2":0.1724044094708904,"s3":-0.056854174326763325},
{"x":188,"s1":0.48603876134748153,"s2":-0.2100276324354331,"s3":0.040879429234485336},
{"x":189,"s1":-1.8539915124772868,"s2":-0.19263462394843303,"s3":0.022378435402781154},
{"x":190,"s1":0.501083227692014,"s2":0.09343276981256979,"s3":0.004445109037909512},
{"x":191,"s1":0.6000284085886727,"s2":0.1613150883058591,"s3":-0.01134972211475044},
{"x":192,"s1":-1.024711020940157,"s2":-0.00031015812843779934,"s3":-0.05660333718929039},
{"x":193,"s1":-0.6561282990712147,"s2":-0.14063724381518083,"s3":0.021778626160935895},
{"x":194,"s1":-0.5272625902353989,"s2":-0.2554530178109733,"s3":0.006257981483584369},
{"x":195,"s1":1.9605291643671576,"s2":-0.13298222226704015,"s3":0.004110277277329844},
{"x":196,"s1":-0.8652454530395335,"s2":0.12981093786155068,"s3":-0.07651143969321379},
{"x":197,"s1":-1.6746490613191831,"s2":0.19452580167060063,"s3":-0.017078399060953476},
{"x":198,"s1":-0.2570567164216261,"s2":0.020395318358972212,"s3":0.0736845083672087}];
    const series = [{"name":"Shock 1","color":"#1f77b4","key":"s1","dash":""},{"name":"Shock 2","color":"#ff7f0e","key":"s2","dash":""},{"name":"Shock 3","color":"#2ca02c","key":"s3","dash":""}];
    const mode = 'stacked';

    const container = d3.select('#hd_bar_49');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Contribution') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Contribution');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"actual":-0.31498797116895605,"recon":-0.31498797116895605},
{"x":2,"actual":-0.31125240132442067,"recon":-0.31125240132442067},
{"x":3,"actual":0.8163067649323273,"recon":0.8163067649323273},
{"x":4,"actual":0.47673837983187795,"recon":0.47673837983187795},
{"x":5,"actual":-0.8595553820616212,"recon":-0.8595553820616212},
{"x":6,"actual":-1.4692882055065464,"recon":-1.4692882055065464},
{"x":7,"actual":-2.114334831130985,"recon":-2.114334831130985},
{"x":8,"actual":0.04378166203061088,"recon":0.04378166203061088},
{"x":9,"actual":-0.8253345499750688,"recon":-0.8253345499750688},
{"x":10,"actual":0.840288523245819,"recon":0.840288523245819},
{"x":11,"actual":0.4338858743048611,"recon":0.4338858743048611},
{"x":12,"actual":-0.3954398407537453,"recon":-0.3954398407537453},
{"x":13,"actual":0.517130881450359,"recon":0.517130881450359},
{"x":14,"actual":1.4472238915818758,"recon":1.4472238915818758},
{"x":15,"actual":-0.09307792119019635,"recon":-0.09307792119019635},
{"x":16,"actual":-1.2725855703776923,"recon":-1.2725855703776923},
{"x":17,"actual":-0.31074387308373413,"recon":-0.31074387308373413},
{"x":18,"actual":-0.09658102196264856,"recon":-0.09658102196264856},
{"x":19,"actual":-1.382810701683701,"recon":-1.382810701683701},
{"x":20,"actual":-1.4624467959172898,"recon":-1.4624467959172898},
{"x":21,"actual":1.3009715392603625,"recon":1.3009715392603625},
{"x":22,"actual":2.2662797122662086,"recon":2.2662797122662086},
{"x":23,"actual":1.512392007786763,"recon":1.512392007786763},
{"x":24,"actual":0.6488490404135202,"recon":0.6488490404135202},
{"x":25,"actual":0.8999443097509223,"recon":0.8999443097509223},
{"x":26,"actual":0.2841579102153428,"recon":0.2841579102153428},
{"x":27,"actual":1.1035883018237678,"recon":1.1035883018237678},
{"x":28,"actual":0.6638827324729892,"recon":0.6638827324729892},
{"x":29,"actual":0.17127065460959456,"recon":0.17127065460959456},
{"x":30,"actual":1.1199182981069984,"recon":1.1199182981069984},
{"x":31,"actual":1.9207540740525255,"recon":1.9207540740525255},
{"x":32,"actual":0.8006488606751957,"recon":0.8006488606751957},
{"x":33,"actual":-0.385611048520393,"recon":-0.385611048520393},
{"x":34,"actual":-0.4397250817930096,"recon":-0.4397250817930096},
{"x":35,"actual":0.6298828493988105,"recon":0.6298828493988105},
{"x":36,"actual":-0.06961219651922648,"recon":-0.06961219651922648},
{"x":37,"actual":-0.7789119879113274,"recon":-0.7789119879113274},
{"x":38,"actual":-0.8787419860341007,"recon":-0.8787419860341007},
{"x":39,"actual":0.2440527312174788,"recon":0.2440527312174788},
{"x":40,"actual":0.3223729372800154,"recon":0.3223729372800154},
{"x":41,"actual":2.041100938637203,"recon":2.041100938637203},
{"x":42,"actual":-0.16523436268962188,"recon":-0.16523436268962188},
{"x":43,"actual":-0.17095944348761516,"recon":-0.17095944348761516},
{"x":44,"actual":-0.8151152486093222,"recon":-0.8151152486093222},
{"x":45,"actual":-0.9005453041906385,"recon":-0.9005453041906385},
{"x":46,"actual":-0.19300716396225298,"recon":-0.19300716396225298},
{"x":47,"actual":-0.9983741934645419,"recon":-0.9983741934645419},
{"x":48,"actual":-1.5410623950236277,"recon":-1.5410623950236277},
{"x":49,"actual":-0.6197050916331831,"recon":-0.6197050916331831},
{"x":50,"actual":0.6357047126615359,"recon":0.6357047126615359},
{"x":51,"actual":-0.47862281061920225,"recon":-0.47862281061920225},
{"x":52,"actual":0.9946956727381081,"recon":0.9946956727381081},
{"x":53,"actual":0.3303352285550901,"recon":0.3303352285550901},
{"x":54,"actual":0.377489040241215,"recon":0.377489040241215},
{"x":55,"actual":-1.733183409760652,"recon":-1.733183409760652},
{"x":56,"actual":-0.9073709325741889,"recon":-0.9073709325741889},
{"x":57,"actual":1.3110173557334994,"recon":1.3110173557334994},
{"x":58,"actual":0.02395114244885036,"recon":0.02395114244885036},
{"x":59,"actual":1.2252970583943696,"recon":1.2252970583943696},
{"x":60,"actual":1.304371943276669,"recon":1.304371943276669},
{"x":61,"actual":-0.4400172451059574,"recon":-0.4400172451059574},
{"x":62,"actual":-1.7799429142766356,"recon":-1.7799429142766356},
{"x":63,"actual":0.9583480063101281,"recon":0.9583480063101281},
{"x":64,"actual":-1.1732524189956186,"recon":-1.1732524189956186},
{"x":65,"actual":0.5415424548443852,"recon":0.5415424548443852},
{"x":66,"actual":-2.1251254523790672,"recon":-2.1251254523790672},
{"x":67,"actual":-0.49101459568950384,"recon":-0.49101459568950384},
{"x":68,"actual":-0.5443474742221707,"recon":-0.5443474742221707},
{"x":69,"actual":-1.0510344212689204,"recon":-1.0510344212689204},
{"x":70,"actual":1.1979596698125403,"recon":1.1979596698125403},
{"x":71,"actual":0.9300043221624539,"recon":0.9300043221624539},
{"x":72,"actual":-0.032029723276023235,"recon":-0.032029723276023235},
{"x":73,"actual":-0.8915781866049347,"recon":-0.8915781866049347},
{"x":74,"actual":0.9147784914448018,"recon":0.9147784914448018},
{"x":75,"actual":-1.59561428445693,"recon":-1.59561428445693},
{"x":76,"actual":-0.454048384037065,"recon":-0.454048384037065},
{"x":77,"actual":0.04495140479081785,"recon":0.04495140479081785},
{"x":78,"actual":-0.7922834268552733,"recon":-0.7922834268552733},
{"x":79,"actual":0.3732453333416736,"recon":0.3732453333416736},
{"x":80,"actual":-1.4046570107964054,"recon":-1.4046570107964054},
{"x":81,"actual":-1.2347689825091572,"recon":-1.2347689825091572},
{"x":82,"actual":-0.12530686450201148,"recon":-0.12530686450201148},
{"x":83,"actual":-0.78565682978007,"recon":-0.78565682978007},
{"x":84,"actual":-0.4080986981389409,"recon":-0.4080986981389409},
{"x":85,"actual":-1.7267994802981395,"recon":-1.7267994802981395},
{"x":86,"actual":0.5570765697275968,"recon":0.5570765697275968},
{"x":87,"actual":-0.3914536476104827,"recon":-0.3914536476104827},
{"x":88,"actual":-0.250762503705424,"recon":-0.250762503705424},
{"x":89,"actual":1.0218390547808818,"recon":1.0218390547808818},
{"x":90,"actual":-0.000939762193643709,"recon":-0.0009397621936437089},
{"x":91,"actual":-1.5007761311216228,"recon":-1.5007761311216228},
{"x":92,"actual":0.26292474430434837,"recon":0.26292474430434837},
{"x":93,"actual":-1.0611177539602412,"recon":-1.0611177539602412},
{"x":94,"actual":1.0364206513956815,"recon":1.0364206513956815},
{"x":95,"actual":0.7234646890415947,"recon":0.7234646890415947},
{"x":96,"actual":0.8541604336744864,"recon":0.8541604336744864},
{"x":97,"actual":0.3682069358154837,"recon":0.3682069358154837},
{"x":98,"actual":-0.04656094092083756,"recon":-0.04656094092083756},
{"x":99,"actual":1.7081843190508057,"recon":1.7081843190508057},
{"x":100,"actual":-1.0310474066155366,"recon":-1.0310474066155366},
{"x":101,"actual":-0.14441362324311863,"recon":-0.14441362324311863},
{"x":102,"actual":-1.6269181269443471,"recon":-1.6269181269443471},
{"x":103,"actual":-0.06217490931366065,"recon":-0.06217490931366065},
{"x":104,"actual":0.21439234093920106,"recon":0.21439234093920106},
{"x":105,"actual":1.5294442502878554,"recon":1.5294442502878554},
{"x":106,"actual":0.27437291327913876,"recon":0.27437291327913876},
{"x":107,"actual":1.729077927144221,"recon":1.729077927144221},
{"x":108,"actual":-0.8785126410853809,"recon":-0.8785126410853809},
{"x":109,"actual":-0.4280582287959271,"recon":-0.4280582287959271},
{"x":110,"actual":-0.27271841265920194,"recon":-0.27271841265920194},
{"x":111,"actual":-0.8351828409416799,"recon":-0.8351828409416799},
{"x":112,"actual":0.9552537029900053,"recon":0.9552537029900053},
{"x":113,"actual":1.2438797492400726,"recon":1.2438797492400726},
{"x":114,"actual":0.6091662702133595,"recon":0.6091662702133595},
{"x":115,"actual":-0.3407882587838508,"recon":-0.3407882587838508},
{"x":116,"actual":-1.8623610290958061,"recon":-1.8623610290958061},
{"x":117,"actual":-1.8071566859269461,"recon":-1.8071566859269461},
{"x":118,"actual":-0.30215190432626304,"recon":-0.30215190432626304},
{"x":119,"actual":0.5235458351511042,"recon":0.5235458351511042},
{"x":120,"actual":0.3165631040551781,"recon":0.3165631040551781},
{"x":121,"actual":-0.2370483772433455,"recon":-0.2370483772433455},
{"x":122,"actual":-0.9960953449205703,"recon":-0.9960953449205703},
{"x":123,"actual":0.1988336011285409,"recon":0.1988336011285409},
{"x":124,"actual":0.13710652322055839,"recon":0.13710652322055839},
{"x":125,"actual":0.11927996180139382,"recon":0.11927996180139382},
{"x":126,"actual":-0.14555523193584155,"recon":-0.14555523193584155},
{"x":127,"actual":0.4455260266671999,"recon":0.4455260266671999},
{"x":128,"actual":-0.3013409269703624,"recon":-0.3013409269703624},
{"x":129,"actual":0.8186630238216842,"recon":0.8186630238216842},
{"x":130,"actual":0.28296375062712315,"recon":0.28296375062712315},
{"x":131,"actual":-0.6860122522560356,"recon":-0.6860122522560356},
{"x":132,"actual":-1.535709285272317,"recon":-1.535709285272317},
{"x":133,"actual":-0.848396634842909,"recon":-0.848396634842909},
{"x":134,"actual":0.5531412268919781,"recon":0.5531412268919781},
{"x":135,"actual":-1.1037543534623366,"recon":-1.1037543534623366},
{"x":136,"actual":1.4415482163586306,"recon":1.4415482163586306},
{"x":137,"actual":-0.8629724210773512,"recon":-0.8629724210773512},
{"x":138,"actual":-0.40871436485843515,"recon":-0.40871436485843515},
{"x":139,"actual":0.09472381288388941,"recon":0.09472381288388941},
{"x":140,"actual":-0.3275986185712264,"recon":-0.3275986185712264},
{"x":141,"actual":1.5206780293689868,"recon":1.5206780293689868},
{"x":142,"actual":0.4821687376476987,"recon":0.4821687376476987},
{"x":143,"actual":0.34803310071865035,"recon":0.34803310071865035},
{"x":144,"actual":1.0797802284882931,"recon":1.0797802284882931},
{"x":145,"actual":0.7199706419742407,"recon":0.7199706419742407},
{"x":146,"actual":-0.40399338882985514,"recon":-0.40399338882985514},
{"x":147,"actual":-1.036580540904315,"recon":-1.036580540904315},
{"x":148,"actual":-1.04568578609413,"recon":-1.04568578609413},
{"x":149,"actual":0.15689382038116473,"recon":0.15689382038116473},
{"x":150,"actual":-0.490394387830272,"recon":-0.490394387830272},
{"x":151,"actual":0.24165819550937345,"recon":0.24165819550937345},
{"x":152,"actual":-1.0953155054794443,"recon":-1.0953155054794443},
{"x":153,"actual":-0.40233673118050867,"recon":-0.40233673118050867},
{"x":154,"actual":-1.406572316785686,"recon":-1.406572316785686},
{"x":155,"actual":-0.9422061209233982,"recon":-0.9422061209233982},
{"x":156,"actual":0.4955597219336491,"recon":0.4955597219336491},
{"x":157,"actual":1.2456240560688676,"recon":1.2456240560688676},
{"x":158,"actual":-1.6282590977631333,"recon":-1.6282590977631333},
{"x":159,"actual":0.8635357629273366,"recon":0.8635357629273366},
{"x":160,"actual":0.854580245295261,"recon":0.854580245295261},
{"x":161,"actual":-0.8723843276797875,"recon":-0.8723843276797875},
{"x":162,"actual":1.4231400368512857,"recon":1.4231400368512857},
{"x":163,"actual":-0.8988465755001893,"recon":-0.8988465755001893},
{"x":164,"actual":0.5952261880161231,"recon":0.5952261880161231},
{"x":165,"actual":0.9116084132861851,"recon":0.9116084132861851},
{"x":166,"actual":-0.32522482484174287,"recon":-0.32522482484174287},
{"x":167,"actual":-1.0682844048666915,"recon":-1.0682844048666915},
{"x":168,"actual":2.39172420705783,"recon":2.39172420705783},
{"x":169,"actual":-0.16412932726978166,"recon":-0.16412932726978166},
{"x":170,"actual":0.8952772831831687,"recon":0.8952772831831687},
{"x":171,"actual":-0.38240954654121545,"recon":-0.38240954654121545},
{"x":172,"actual":-0.12122473558318383,"recon":-0.12122473558318383},
{"x":173,"actual":0.5398128510921829,"recon":0.5398128510921829},
{"x":174,"actual":0.7037362204876277,"recon":0.7037362204876277},
{"x":175,"actual":-2.7480248137877052,"recon":-2.7480248137877052},
{"x":176,"actual":-0.4978805677564023,"recon":-0.4978805677564023},
{"x":177,"actual":1.2291751824516288,"recon":1.2291751824516288},
{"x":178,"actual":2.310305988208175,"recon":2.310305988208175},
{"x":179,"actual":0.2840473457895652,"recon":0.2840473457895652},
{"x":180,"actual":0.9615920401588718,"recon":0.9615920401588718},
{"x":181,"actual":0.1880417244043678,"recon":0.1880417244043678},
{"x":182,"actual":1.2484853684055297,"recon":1.2484853684055297},
{"x":183,"actual":0.3689848307852841,"recon":0.3689848307852841},
{"x":184,"actual":0.5461122257697325,"recon":0.5461122257697325},
{"x":185,"actual":0.3698087097799145,"recon":0.3698087097799145},
{"x":186,"actual":-0.9824290754812778,"recon":-0.9824290754812778},
{"x":187,"actual":0.7369693829477952,"recon":0.7369693829477952},
{"x":188,"actual":0.2847683696308036,"recon":0.2847683696308036},
{"x":189,"actual":-2.056369889538669,"recon":-2.056369889538669},
{"x":190,"actual":0.5668389180267627,"recon":0.5668389180267627},
{"x":191,"actual":0.7178715862640512,"recon":0.7178715862640512},
{"x":192,"actual":-1.113746704773615,"recon":-1.113746704773615},
{"x":193,"actual":-0.8071091052411898,"recon":-0.8071091052411898},
{"x":194,"actual":-0.808579815078518,"recon":-0.808579815078518},
{"x":195,"actual":1.7995350308617175,"recon":1.7995350308617175},
{"x":196,"actual":-0.8440681433869269,"recon":-0.8440681433869269},
{"x":197,"actual":-1.529323847225266,"recon":-1.529323847225266},
{"x":198,"actual":-0.19509907821117517,"recon":-0.19509907821117517}];
    const series = [{"name":"Actual","color":"#1f77b4","key":"actual","dash":""},{"name":"Reconstructed","color":"#ff7f0e","key":"recon","dash":"6,3"}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#hd_line_50');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":-0.038810673086982876,"s2":-1.2317625165637347,"s3":0.0},
{"x":2,"s1":0.008516835047759599,"s2":-0.007117558641645844,"s3":0.04058763737096537},
{"x":3,"s1":0.13034678592506488,"s2":-1.7208040516191156,"s3":0.026089207338540657},
{"x":4,"s1":-0.03174904404511736,"s2":-0.5298844820952883,"s3":-0.2578142781403193},
{"x":5,"s1":-0.0660423102989079,"s2":1.4112855988503616,"s3":-0.004865389738905386},
{"x":6,"s1":-0.08278899599263656,"s2":1.0630122474524952,"s3":0.10971536441883849},
{"x":7,"s1":-0.17088816303612225,"s2":0.45374623594632274,"s3":0.3457132677120445},
{"x":8,"s1":0.11244320841638591,"s2":0.4945584406224775,"s3":-0.18625270815329725},
{"x":9,"s1":-0.2082370619777505,"s2":1.420155986339766,"s3":-0.3487859382262582},
{"x":10,"s1":0.14097879247247017,"s2":0.6323225642131286,"s3":0.18636788606857715},
{"x":11,"s1":-0.08223027647950028,"s2":0.47292170977996423,"s3":-0.08651538032917332},
{"x":12,"s1":-0.05422312585060202,"s2":0.5924808147025264,"s3":0.2869283089133722},
{"x":13,"s1":0.10490282196738962,"s2":0.44140443838597354,"s3":-0.2571176595569892},
{"x":14,"s1":0.11025789179956812,"s2":0.953300390222485,"s3":0.19245904909322387},
{"x":15,"s1":-0.13822141111868985,"s2":-0.8075473265275386,"s3":-0.117571068745749},
{"x":16,"s1":-0.07643706440543312,"s2":0.027076126137094963,"s3":0.06439988819726274},
{"x":17,"s1":0.10943034084736604,"s2":-1.1530577283556178,"s3":0.20192132815630184},
{"x":18,"s1":-0.05090115578776745,"s2":0.4361666362408818,"s3":-0.1985878618096885},
{"x":19,"s1":-0.16226959003595615,"s2":0.5124165587528843,"s3":0.04614342387010445},
{"x":20,"s1":-0.07379809950727709,"s2":-0.032841628959718296,"s3":0.02144203189106498},
{"x":21,"s1":0.2285943619248843,"s2":-1.241710988803678,"s3":-0.17036637911176236},
{"x":22,"s1":0.10473229846831197,"s2":0.22843529389969172,"s3":0.07593730325393255},
{"x":23,"s1":0.022644432797572767,"s2":-0.4525278060190029,"s3":-0.053934958636041835},
{"x":24,"s1":0.046180550291653286,"s2":-1.4699162065396565,"s3":0.04225048908100535},
{"x":25,"s1":0.1724369473396351,"s2":0.9464678325930678,"s3":0.0022140084323071354},
{"x":26,"s1":-0.002479212873370619,"s2":0.8008744754907446,"s3":-0.012986140807936756},
{"x":27,"s1":0.11052556567627889,"s2":1.3096233259209713,"s3":-0.11894590312859987},
{"x":28,"s1":-0.003083815468841003,"s2":0.6153839037600071,"s3":-0.339700903473679},
{"x":29,"s1":0.002939861455730609,"s2":1.0447854855051575,"s3":-0.05975500034709428},
{"x":30,"s1":0.14706578925074584,"s2":-0.24749571999709505,"s3":0.1283794505784151},
{"x":31,"s1":0.12316313558897343,"s2":0.11241561859830716,"s3":-0.05471780400032646},
{"x":32,"s1":-0.014915914729968173,"s2":-0.17961895290639449,"s3":0.08223354775176733},
{"x":33,"s1":-0.028731698984764277,"s2":-1.9933443171417524,"s3":0.19558425263888737},
{"x":34,"s1":0.055937392453753634,"s2":-0.7803669295341458,"s3":-0.10464945513729482},
{"x":35,"s1":0.14234672393715,"s2":-1.0257611310800532,"s3":0.15218822468382906},
{"x":36,"s1":-0.08725247225156024,"s2":1.7692344796651198,"s3":0.10621599083827445},
{"x":37,"s1":-0.07148860172372258,"s2":0.31830616284136976,"s3":-0.05210310339503477},
{"x":38,"s1":-0.04893733538360091,"s2":-1.1304155493937822,"s3":0.024765110443118743},
{"x":39,"s1":0.10358310573453916,"s2":0.387737748556962,"s3":-0.43569016736542215},
{"x":40,"s1":-0.01109636603396148,"s2":-0.40519987909259214,"s3":0.1300594196883017},
{"x":41,"s1":0.1964340960767768,"s2":0.25869135133569565,"s3":0.1521958543080858},
{"x":42,"s1":-0.17193927562210487,"s2":0.7727555859076636,"s3":0.1324219356783155},
{"x":43,"s1":0.06995525365625123,"s2":-1.2732379310938278,"s3":0.008532462384258303},
{"x":44,"s1":-0.054965413458630576,"s2":-1.485347286112215,"s3":-0.24407977149554186},
{"x":45,"s1":0.000567610321653473,"s2":-0.9310583006561677,"s3":0.05088734449261997},
{"x":46,"s1":0.027124150459086675,"s2":0.4555950069003234,"s3":0.03734586580234627},
{"x":47,"s1":-0.15094855250973094,"s2":-0.7546127679550441,"s3":-0.11900937119461437},
{"x":48,"s1":-0.09383932575738531,"s2":-1.251996901916351,"s3":0.16640001879682384},
{"x":49,"s1":0.05410879557661544,"s2":-0.5507841457285716,"s3":-0.1406758518020476},
{"x":50,"s1":0.07130255346881381,"s2":-0.006943366861942567,"s3":-0.013940359765615022},
{"x":51,"s1":-0.15340292163602812,"s2":0.240058964728474,"s3":-0.17798697182644022},
{"x":52,"s1":0.19054887165232323,"s2":-0.16309103144877876,"s3":0.10273325847554829},
{"x":53,"s1":-0.04955784798035603,"s2":-0.6871677539603395,"s3":0.13648016124595286},
{"x":54,"s1":0.05855800707735928,"s2":0.008230439305303698,"s3":-0.006927072641406015},
{"x":55,"s1":-0.20526368797849517,"s2":0.5500370756914273,"s3":-0.11524992538155887},
{"x":56,"s1":0.05693846929596214,"s2":2.1410729265946475,"s3":-0.10528300872142805},
{"x":57,"s1":0.14675083411085732,"s2":-0.3155706685803006,"s3":0.06849782744211502},
{"x":58,"s1":-0.18756851356289905,"s2":-0.4290496014542648,"s3":-0.03740394141695342},
{"x":59,"s1":0.21437796410749188,"s2":1.2418738669991476,"s3":-0.024118869079396123},
{"x":60,"s1":0.044123732046554426,"s2":-0.5074941485163054,"s3":-0.015211828564735776},
{"x":61,"s1":-0.13022981478466367,"s2":-0.12505351991887712,"s3":-0.015858961803080773},
{"x":62,"s1":-0.07708643186827135,"s2":-0.2433269311062719,"s3":0.060622193054330156},
{"x":63,"s1":0.25907835894242737,"s2":-0.01995697061870154,"s3":0.017905471705536913},
{"x":64,"s1":-0.2985689771377235,"s2":-0.13450115532397558,"s3":-0.02535078628683678},
{"x":65,"s1":0.19037942807785369,"s2":-0.21831078182773822,"s3":0.045660805421359},
{"x":66,"s1":-0.3211061545159912,"s2":-2.4260006257727404,"s3":0.06385177113800473},
{"x":67,"s1":0.16885290459944882,"s2":0.15560092465595465,"s3":0.023685386667327772},
{"x":68,"s1":-0.06806503903124898,"s2":-1.7833226583788728,"s3":0.33960317461213646},
{"x":69,"s1":-0.13454954973023012,"s2":0.2609375744550193,"s3":-0.06183042100379446},
{"x":70,"s1":0.24398905421077882,"s2":1.7696789477404833,"s3":-0.07470497949544182},
{"x":71,"s1":-0.07316717031629381,"s2":1.1870081119706974,"s3":-0.0717767647576408},
{"x":72,"s1":-0.07480850713824161,"s2":0.5917759733034171,"s3":-0.41871394678751933},
{"x":73,"s1":-0.03734895381140725,"s2":-0.46675287204236104,"s3":-0.010369702548485713},
{"x":74,"s1":0.19284390060860984,"s2":1.4018929896960288,"s3":-0.07417509617251984},
{"x":75,"s1":-0.3249333564369777,"s2":0.6039735191800915,"s3":0.0054930239282968965},
{"x":76,"s1":0.07978151059918756,"s2":-0.7800111612521127,"s3":-0.2755629205282289},
{"x":77,"s1":0.02317557709036028,"s2":-0.10874271085312587,"s3":0.17205840971128983},
{"x":78,"s1":-0.12876268548856018,"s2":0.2356901413037255,"s3":-0.14448092514744681},
{"x":79,"s1":0.10140762355086982,"s2":-0.6638362748550801,"s3":0.25679332440243735},
{"x":80,"s1":-0.22199843759186325,"s2":-0.3089637949455935,"s3":-0.16168593910233228},
{"x":81,"s1":0.00747102558985303,"s2":0.2241644258394842,"s3":-0.06591980162217172},
{"x":82,"s1":0.04887112390561208,"s2":-2.0069527456631278,"s3":0.32063594212054597},
{"x":83,"s1":-0.13742675465036888,"s2":-1.330034309887167,"s3":0.05628012415235039},
{"x":84,"s1":0.04642417909104922,"s2":-1.1284945227945968,"s3":0.016827003508994198},
{"x":85,"s1":-0.18552316354198808,"s2":0.635872247466303,"s3":-0.10599260944698874},
{"x":86,"s1":0.2022286774118592,"s2":0.52020430636803,"s3":-0.20374702586981694},
{"x":87,"s1":-0.16625471828688107,"s2":0.9566043025431912,"s3":0.33766951180824123},
{"x":88,"s1":0.00064675871956812,"s2":0.5706470514808941,"s3":0.12353235163335657},
{"x":89,"s1":0.1151575556734447,"s2":0.02711811757925706,"s3":-0.17810865668201176},
{"x":90,"s1":-0.09591006138138743,"s2":-0.23954680216456148,"s3":-0.17218231777982865},
{"x":91,"s1":-0.1304329784178861,"s2":1.2638646745449214,"s3":0.18938247109748327},
{"x":92,"s1":0.14971528573616338,"s2":0.08852987839790108,"s3":-0.163718866093399},
{"x":93,"s1":-0.22378698554576315,"s2":0.9798983343074497,"s3":-0.07910475056923648},
{"x":94,"s1":0.21800641036661375,"s2":0.8184853433822246,"s3":0.013582450105378327},
{"x":95,"s1":-0.07055628218000795,"s2":0.5230873730409977,"s3":0.21236083664275737},
{"x":96,"s1":0.05013114644304457,"s2":-1.8654763782003816,"s3":-0.3097031523699946},
{"x":97,"s1":0.03872210516361974,"s2":1.6846281835844719,"s3":-0.004890753419860386},
{"x":98,"s1":0.012247995277724957,"s2":0.12655984612465604,"s3":0.03799652527109301},
{"x":99,"s1":0.1790843269743057,"s2":0.4028932078459154,"s3":-0.01689505470159559},
{"x":100,"s1":-0.24461187238440246,"s2":0.6475493275851549,"s3":-0.0806081513795228},
{"x":101,"s1":0.1311031148205215,"s2":0.8227881509996671,"s3":0.1335979266457592},
{"x":102,"s1":-0.2220674297039838,"s2":-0.061384874157130016,"s3":-0.10254846424384713},
{"x":103,"s1":0.11269484580745134,"s2":0.591397290671423,"s3":-0.03236272765369801},
{"x":104,"s1":-0.03639754144278596,"s2":1.3006224276150269,"s3":0.002795181577149818},
{"x":105,"s1":0.1105236032555644,"s2":-0.08852348442525047,"s3":0.004154700494644438},
{"x":106,"s1":-0.10360225809645877,"s2":-2.1676933166292947,"s3":-0.2597644459898968},
{"x":107,"s1":0.28956919688101274,"s2":-0.5157313648571968,"s3":-0.04384705536796344},
{"x":108,"s1":-0.2014494128218246,"s2":1.8733293887937472,"s3":-0.004196766678700274},
{"x":109,"s1":0.06131036364986414,"s2":-0.8206210080826098,"s3":0.042550812677440264},
{"x":110,"s1":-0.010602809443275137,"s2":0.8833283310417893,"s3":0.10476511989262502},
{"x":111,"s1":-0.07792632122331045,"s2":0.825999291068229,"s3":-0.060199960737654136},
{"x":112,"s1":0.13319817885398827,"s2":-0.20530381036770878,"s3":-0.07206176277525415},
{"x":113,"s1":0.03528773291571404,"s2":-0.9241622834377112,"s3":0.23846366501491148},
{"x":114,"s1":-0.0014916788486996372,"s2":0.8820419944603195,"s3":-0.2516452028922069},
{"x":115,"s1":-0.030637495423216303,"s2":-1.1565921120596083,"s3":-0.04960370154654386},
{"x":116,"s1":-0.15154867344844491,"s2":-0.3433805322128195,"s3":-0.15850066146851727},
{"x":117,"s1":-0.020409215232980553,"s2":-0.5258351329298271,"s3":0.1771946258804611},
{"x":118,"s1":0.033005770960111605,"s2":-0.6671973857540912,"s3":-0.14445435420003927},
{"x":119,"s1":0.0161172039708681,"s2":0.07340493330029733,"s3":0.1075468433921519},
{"x":120,"s1":-0.027155255588032435,"s2":0.9440381911117367,"s3":0.10765030708928543},
{"x":121,"s1":-0.04724765036133179,"s2":-0.40277211608701363,"s3":-0.03536600892811881},
{"x":122,"s1":-0.06483214537185933,"s2":0.32404456776057355,"s3":0.20975245852073637},
{"x":123,"s1":0.11503092293946128,"s2":0.8460464764606893,"s3":-0.029567050593140715},
{"x":124,"s1":-0.06344111252105578,"s2":-0.5504730966667675,"s3":0.1830587776655224},
{"x":125,"s1":-0.0005997792979068083,"s2":0.2586411133405366,"s3":0.10849898604154586},
{"x":126,"s1":-0.007801708751024085,"s2":-0.15179602643097379,"s3":0.10524810135144919},
{"x":127,"s1":0.05971170012764538,"s2":0.9091414984664198,"s3":-0.08962615118379176},
{"x":128,"s1":-0.07875737470386017,"s2":0.5629798078853882,"s3":-0.06653339255936971},
{"x":129,"s1":0.12637185681996263,"s2":-0.14742478913999796,"s3":0.015797035329732374},
{"x":130,"s1":-0.037845801850989465,"s2":0.5145148832873676,"s3":0.061156641554178014},
{"x":131,"s1":-0.07527317604507049,"s2":0.29479380581729786,"s3":0.2740702052334817},
{"x":132,"s1":-0.12084071754888834,"s2":-0.13670522772998672,"s3":-0.16009035768788638},
{"x":133,"s1":0.024071310131444652,"s2":0.23652076499598657,"s3":0.11434228208149995},
{"x":134,"s1":0.07169613861036708,"s2":1.3051955040031387,"s3":0.24928925800639612},
{"x":135,"s1":-0.26241935885984324,"s2":1.0597689268732904,"s3":-0.10125673479577502},
{"x":136,"s1":0.2642206666855952,"s2":0.022029616112160654,"s3":-0.10947528443049125},
{"x":137,"s1":-0.2537210074256397,"s2":-1.0312142388533263,"s3":0.1275450650281298},
{"x":138,"s1":0.08132119864595114,"s2":0.8991636283746587,"s3":0.0768027334670024},
{"x":139,"s1":0.019619056612027938,"s2":0.014924191160601518,"s3":-0.07474822298980695},
{"x":140,"s1":-0.091992009199231,"s2":0.409907126106775,"s3":-0.1576324423058711},
{"x":141,"s1":0.2267112727923911,"s2":-0.09962797710660516,"s3":0.20658147990122966},
{"x":142,"s1":-0.10165198988542652,"s2":1.3330694555854157,"s3":-0.2645035674487837},
{"x":143,"s1":0.05760409139792228,"s2":0.21148580337597495,"s3":0.03244079974728163},
{"x":144,"s1":0.12468606339498489,"s2":-1.8407306277613782,"s3":0.2604153869681616},
{"x":145,"s1":0.034313717198614244,"s2":-2.506128932447046,"s3":0.30424261148183807},
{"x":146,"s1":-0.029530099775961192,"s2":-1.2483846349496337,"s3":-0.15425853975951215},
{"x":147,"s1":-0.01416386554697721,"s2":-2.07268529522864,"s3":0.052192799674683286},
{"x":148,"s1":-0.014308949719309141,"s2":-1.0141497968985027,"s3":0.04688398009089429},
{"x":149,"s1":0.10140085884875845,"s2":1.4637552992760614,"s3":0.04727748228866418},
{"x":150,"s1":-0.13838501303709716,"s2":-0.9255789162782188,"s3":-0.2580714349367782},
{"x":151,"s1":0.07740271840526051,"s2":-0.1673772858648183,"s3":0.14916724195077422},
{"x":152,"s1":-0.13159147724863862,"s2":-1.5163764309555527,"s3":-0.12131453697580478},
{"x":153,"s1":0.05610980332221614,"s2":0.094050863605921,"s3":-0.07981768095216067},
{"x":154,"s1":-0.146751030906083,"s2":-1.5380289972469146,"s3":-0.16236419127617951},
{"x":155,"s1":-0.0019694308659305004,"s2":1.1041948980859413,"s3":0.4478193215605362},
{"x":156,"s1":0.08329256207678233,"s2":-1.2906845575818664,"s3":-0.19054943670507668},
{"x":157,"s1":0.04225895931604215,"s2":-1.1483409030667724,"s3":-0.14748820903584703},
{"x":158,"s1":-0.23072145535787653,"s2":0.44090927078427145,"s3":-0.043307528684451896},
{"x":159,"s1":0.2934090824296199,"s2":-0.0902058438576046,"s3":-0.07773577625510457},
{"x":160,"s1":-0.03253997615559455,"s2":-0.8008324104083755,"s3":-0.06220315624364714},
{"x":161,"s1":-0.13332643471626565,"s2":0.6051990241243498,"s3":0.06818402253598457},
{"x":162,"s1":0.29202262739189083,"s2":0.8791223603689368,"s3":-0.0494542281928424},
{"x":163,"s1":-0.2738401329825291,"s2":0.6763102269671543,"s3":0.031303245279198165},
{"x":164,"s1":0.1941472315383417,"s2":-0.48027270561257157,"s3":0.15670423310112624},
{"x":165,"s1":0.037988266917247326,"s2":-0.7325462036340107,"s3":0.1369405538897065},
{"x":166,"s1":-0.0957198481647536,"s2":0.8600014772737945,"s3":-0.09411321785976381},
{"x":167,"s1":-0.060195665674301395,"s2":-0.6017575895445694,"s3":-0.12948355461383335},
{"x":168,"s1":0.373214301287861,"s2":0.1264882832481017,"s3":0.08766504665521554},
{"x":169,"s1":-0.25846605158570324,"s2":0.7922689521451103,"s3":0.017898093916233617},
{"x":170,"s1":0.18723955522196362,"s2":0.315202639065332,"s3":0.060087355095315924},
{"x":171,"s1":-0.10233088199210268,"s2":1.7978328352357094,"s3":0.1850809684082168},
{"x":172,"s1":0.036203416852289595,"s2":0.40540236867287377,"s3":0.10455474773850766},
{"x":173,"s1":0.03656652153867828,"s2":-1.523306523348055,"s3":-0.04134962281273032},
{"x":174,"s1":0.0528160442697873,"s2":-2.196457308800662,"s3":-0.1170538847215064},
{"x":175,"s1":-0.32704768767520614,"s2":-0.11144300910686888,"s3":0.011986723602948147},
{"x":176,"s1":0.22431969443737082,"s2":1.4431098638569855,"s3":-0.030156688834323184},
{"x":177,"s1":0.06229729051867745,"s2":0.22431495027447065,"s3":0.08220716912814273},
{"x":178,"s1":0.1079006450442196,"s2":-1.369302473293946,"s3":-0.10522710601875598},
{"x":179,"s1":-0.08370304664435121,"s2":-0.6054142014102534,"s3":0.2724249360186435},
{"x":180,"s1":0.2061874521473367,"s2":-1.0378403662847644,"s3":-0.28928521028714194},
{"x":181,"s1":-0.017491408057759696,"s2":0.11733783916069372,"s3":-0.06133038446282126},
{"x":182,"s1":0.18777885747580095,"s2":0.8019070137680284,"s3":-0.14828610878525972},
{"x":183,"s1":-0.05918809483473527,"s2":2.303521569011167,"s3":0.031344617885702794},
{"x":184,"s1":0.06477153454019481,"s2":1.6415125236150014,"s3":0.2741997984067582},
{"x":185,"s1":-0.01920399819961568,"s2":1.319261126503786,"s3":-0.13125218768889768},
{"x":186,"s1":-0.13345684152677093,"s2":-0.6838601250102346,"s3":-0.11327962631912662},
{"x":187,"s1":0.19309884216532391,"s2":-1.1678508702067203,"s3":0.20933998462599654},
{"x":188,"s1":-0.060883715436714086,"s2":0.14293755956780596,"s3":-0.15515251793500037},
{"x":189,"s1":-0.2512302429608119,"s2":0.8896827110919907,"s3":0.021060610776570624},
{"x":190,"s1":0.2516560338131124,"s2":0.09210658389048991,"s3":-0.12441700104758553},
{"x":191,"s1":-0.041599521347414535,"s2":-0.27768884373125935,"s3":-0.06973435746572319},
{"x":192,"s1":-0.17695720459697736,"s2":-1.0264898644879255,"s3":0.17310972862565427},
{"x":193,"s1":0.04476473804398607,"s2":-0.8792733040954567,"s3":-0.09285062459301402},
{"x":194,"s1":-0.03662254490568531,"s2":0.27424410921213055,"s3":0.06777113316521642},
{"x":195,"s1":0.236399992916715,"s2":1.0044476120963277,"s3":-0.2000476711690675},
{"x":196,"s1":-0.3030902223157414,"s2":0.23581661173087673,"s3":0.27457042915027613},
{"x":197,"s1":-0.045310399505272984,"s2":-0.32497827276979163,"s3":0.12193775788541411},
{"x":198,"s1":0.10716418560088646,"s2":0.4379966940254928,"s3":-0.1737833746138548}];
    const series = [{"name":"Shock 1","color":"#1f77b4","key":"s1","dash":""},{"name":"Shock 2","color":"#ff7f0e","key":"s2","dash":""},{"name":"Shock 3","color":"#2ca02c","key":"s3","dash":""}];
    const mode = 'stacked';

    const container = d3.select('#hd_bar_51');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Contribution') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Contribution');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"actual":-1.7848438316990334,"recon":-1.7848438316990334},
{"x":2,"actual":-0.16623470009258495,"recon":-0.16623470009258495},
{"x":3,"actual":-1.7454483988406397,"recon":-1.7454483988406397},
{"x":4,"actual":-0.9803110100097213,"recon":-0.9803110100097213},
{"x":5,"actual":1.1688617265928365,"recon":1.1688617265928365},
{"x":6,"actual":0.920524806288261,"recon":0.920524806288261},
{"x":7,"actual":0.46045426114762456,"recon":0.46045426114762456},
{"x":8,"actual":0.2532955371650841,"recon":0.2532955371650841},
{"x":9,"actual":0.6955520555713279,"recon":0.6955520555713279},
{"x":10,"actual":0.7920467708084655,"recon":0.7920467708084655},
{"x":11,"actual":0.13656616954154815,"recon":0.13656616954154815},
{"x":12,"actual":0.6575938744608941,"recon":0.6575938744608941},
{"x":13,"actual":0.12159897817506596,"recon":0.12159897817506596},
{"x":14,"actual":1.0884252178081695,"recon":1.0884252178081695},
{"x":15,"actual":-1.230932314669837,"recon":-1.230932314669837},
{"x":16,"actual":-0.15255327957932407,"recon":-0.15255327957932407},
{"x":17,"actual":-1.009298164384915,"recon":-1.009298164384915},
{"x":18,"actual":0.019085504616061625,"recon":0.01908550461606162},
{"x":19,"actual":0.22869825992060117,"recon":0.22869825992060117},
{"x":20,"actual":-0.252789829512057,"recon":-0.252789829512057},
{"x":21,"actual":-1.3510751357600943,"recon":-1.3510751357600943},
{"x":22,"actual":0.24151276661396912,"recon":0.24151276661396912},
{"x":23,"actual":-0.651410461185863,"recon":-0.651410461185863},
{"x":24,"actual":-1.5490772966474802,"recon":-1.5490772966474802},
{"x":25,"actual":0.9535266589138557,"recon":0.9535266589138557},
{"x":26,"actual":0.6178169923894877,"recon":0.6178169923894877},
{"x":27,"actual":1.1336108590501817,"recon":1.1336108590501817},
{"x":28,"actual":0.10500705539472267,"recon":0.10500705539472266},
{"x":29,"actual":0.8203782171901547,"recon":0.8203782171901547},
{"x":30,"actual":-0.13964260959101713,"recon":-0.13964260959101713},
{"x":31,"actual":0.013268820764113454,"recon":0.013268820764113454},
{"x":32,"actual":-0.27989344930747645,"recon":-0.27989344930747645},
{"x":33,"actual":-1.9940838929105538,"recon":-1.9940838929105538},
{"x":34,"actual":-0.9966711216406117,"recon":-0.9966711216406117},
{"x":35,"actual":-0.8988183118819917,"recon":-0.8988183118819917},
{"x":36,"actual":1.620605868828917,"recon":1.620605868828917},
{"x":37,"actual":0.027122328299694905,"recon":0.02712232829969491},
{"x":38,"actual":-1.3221799037571815,"recon":-1.3221799037571815},
{"x":39,"actual":-0.11196144249683862,"recon":-0.11196144249683862},
{"x":40,"actual":-0.4538289548611695,"recon":-0.4538289548611695},
{"x":41,"actual":0.4397291722976407,"recon":0.4397291722976407},
{"x":42,"actual":0.5656461165409565,"recon":0.5656461165409565},
{"x":43,"actual":-1.362342344476236,"recon":-1.362342344476236},
{"x":44,"actual":-1.951984600489305,"recon":-1.951984600489305},
{"x":45,"actual":-1.0471954752648118,"recon":-1.0471954752648118},
{"x":46,"actual":0.35247289373883844,"recon":0.35247289373883844},
{"x":47,"actual":-1.1921628210823072,"recon":-1.1921628210823072},
{"x":48,"actual":-1.3470283382998303,"recon":-1.3470283382998303},
{"x":49,"actual":-0.8049433313769216,"recon":-0.8049433313769216},
{"x":50,"actual":-0.11717330258166145,"recon":-0.11717330258166145},
{"x":51,"actual":-0.2589230581569121,"recon":-0.2589230581569121},
{"x":52,"actual":-0.03740103074382494,"recon":-0.03740103074382495},
{"x":53,"actual":-0.76783757011766,"recon":-0.76783757011766},
{"x":54,"actual":-0.10773075568166078,"recon":-0.10773075568166077},
{"x":55,"actual":0.06193133290845583,"recon":0.061931332908455816},
{"x":56,"actual":1.9251362577462645,"recon":1.9251362577462645},
{"x":57,"actual":-0.2679141364502461,"recon":-0.2679141364502461},
{"x":58,"actual":-0.8216141858570349,"recon":-0.8216141858570349},
{"x":59,"actual":1.2645408326043261,"recon":1.2645408326043261},
{"x":60,"actual":-0.646174374457404,"recon":-0.646174374457404},
{"x":61,"actual":-0.43873442592953926,"recon":-0.43873442592953926},
{"x":62,"actual":-0.4273832993431308,"recon":-0.4273832993431308},
{"x":63,"actual":0.08943473060634503,"recon":0.08943473060634505},
{"x":64,"actual":-0.6260130481714535,"recon":-0.6260130481714535},
{"x":65,"actual":-0.1498626777514433,"recon":-0.1498626777514433},
{"x":66,"actual":-2.850847138573644,"recon":-2.850847138573644},
{"x":67,"actual":0.1805470864998137,"recon":0.1805470864998137},
{"x":68,"actual":-1.679376652220903,"recon":-1.679376652220903},
{"x":69,"actual":-0.10303452570192292,"recon":-0.10303452570192292},
{"x":70,"actual":1.771370893032902,"recon":1.771370893032902},
{"x":71,"actual":0.8744720474738453,"recon":0.8744720474738453},
{"x":72,"actual":-0.06933861004526162,"recon":-0.06933861004526162},
{"x":73,"actual":-0.682063657825172,"recon":-0.682063657825172},
{"x":74,"actual":1.3529696647092015,"recon":1.3529696647092015},
{"x":75,"actual":0.11694105724849299,"recon":0.11694105724849299},
{"x":76,"actual":-1.1433847006040716,"recon":-1.1433847006040716},
{"x":77,"actual":-0.08110085347439343,"recon":-0.08110085347439344},
{"x":78,"actual":-0.20514559875519925,"recon":-0.20514559875519925},
{"x":79,"actual":-0.4732274563246907,"recon":-0.4732274563246907},
{"x":80,"actual":-0.8602403010627068,"recon":-0.8602403010627068},
{"x":81,"actual":-0.0018764796157523514,"recon":-0.0018764796157523522},
{"x":82,"actual":-1.8050378090598873,"recon":-1.8050378090598873},
{"x":83,"actual":-1.5787730698081026,"recon":-1.5787730698081026},
{"x":84,"actual":-1.2328354696174704,"recon":-1.2328354696174704},
{"x":85,"actual":0.1767643450544082,"recon":0.1767643450544082},
{"x":86,"actual":0.3510938284871542,"recon":0.3510938284871542},
{"x":87,"actual":0.9604269666416337,"recon":0.9604269666416337},
{"x":88,"actual":0.5272340324109009,"recon":0.5272340324109009},
{"x":89,"actual":-0.2034251128522277,"recon":-0.2034251128522277},
{"x":90,"actual":-0.6752313107486952,"recon":-0.6752313107486952},
{"x":91,"actual":1.1552220378016005,"recon":1.1552220378016005},
{"x":92,"actual":-0.09306583138225231,"recon":-0.09306583138225233},
{"x":93,"actual":0.5094144687695322,"recon":0.5094144687695322},
{"x":94,"actual":0.8824820744312988,"recon":0.8824820744312988},
{"x":95,"actual":0.49729979808082914,"recon":0.49729979808082914},
{"x":96,"actual":-2.29264051355025,"recon":-2.29264051355025},
{"x":97,"actual":1.5508674059053131,"recon":1.5508674059053131},
{"x":98,"actual":0.009212237250556251,"recon":0.009212237250556254},
{"x":99,"actual":0.3974903506957078,"recon":0.3974903506957078},
{"x":100,"actual":0.15473717439831194,"recon":0.15473717439831194},
{"x":101,"actual":0.9198970630430301,"recon":0.9198970630430301},
{"x":102,"actual":-0.5535928975278788,"recon":-0.5535928975278788},
{"x":103,"actual":0.5041372794022583,"recon":0.5041372794022583},
{"x":104,"actual":1.0994279383264725,"recon":1.0994279383264725},
{"x":105,"actual":-0.1414373100979593,"recon":-0.1414373100979593},
{"x":106,"actual":-2.6986521501385687,"recon":-2.6986521501385687},
{"x":107,"actual":-0.43760135276706574,"recon":-0.43760135276706574},
{"x":108,"actual":1.5000910798703055,"recon":1.5000910798703055},
{"x":109,"actual":-0.8843519611782232,"recon":-0.8843519611782232},
{"x":110,"actual":0.8098985120682209,"recon":0.8098985120682209},
{"x":111,"actual":0.5202808796843466,"recon":0.5202808796843466},
{"x":112,"actual":-0.31175952371189236,"recon":-0.31175952371189236},
{"x":113,"actual":-0.8180030149300034,"recon":-0.8180030149300034},
{"x":114,"actual":0.4613129832964952,"recon":0.4613129832964952},
{"x":115,"actual":-1.4044254384522865,"recon":-1.4044254384522865},
{"x":116,"actual":-0.8210219965526997,"recon":-0.8210219965526997},
{"x":117,"actual":-0.5366418517052646,"recon":-0.5366418517052646},
{"x":118,"actual":-0.9462380984169368,"recon":-0.9462380984169368},
{"x":119,"actual":0.029476851240399612,"recon":0.029476851240399615},
{"x":120,"actual":0.8569411131900718,"recon":0.8569411131900718},
{"x":121,"actual":-0.6529779047993821,"recon":-0.6529779047993821},
{"x":122,"actual":0.30137275148653303,"recon":0.30137275148653303},
{"x":123,"actual":0.7639182193840923,"recon":0.7639182193840923},
{"x":124,"actual":-0.5984475609452182,"recon":-0.5984475609452182},
{"x":125,"actual":0.19894819066125766,"recon":0.19894819066125766},
{"x":126,"actual":-0.2219417632534665,"recon":-0.2219417632534665},
{"x":127,"actual":0.7116349179873552,"recon":0.7116349179873552},
{"x":128,"actual":0.25009691119924055,"recon":0.25009691119924055},
{"x":129,"actual":-0.1728480264132206,"recon":-0.1728480264132206},
{"x":130,"actual":0.37023359356763874,"recon":0.37023359356763874},
{"x":131,"actual":0.32599870558279154,"recon":0.32599870558279154},
{"x":132,"actual":-0.5852284323896791,"recon":-0.5852284323896791},
{"x":133,"actual":0.2073422277860134,"recon":0.2073422277860134},
{"x":134,"actual":1.4585887711969836,"recon":1.4585887711969836},
{"x":135,"actual":0.5285007037947543,"recon":0.5285007037947543},
{"x":136,"actual":0.009182868944347033,"recon":0.009182868944347028},
{"x":137,"actual":-1.324982310673754,"recon":-1.324982310673754},
{"x":138,"actual":0.8896954310646944,"recon":0.8896954310646944},
{"x":139,"actual":-0.20779710464009524,"recon":-0.2077971046400952},
{"x":140,"actual":-0.007309454821244967,"recon":-0.007309454821244954},
{"x":141,"actual":0.16607264616409795,"recon":0.16607264616409795},
{"x":142,"actual":0.799321768828288,"recon":0.799321768828288},
{"x":143,"actual":0.1339385650982611,"recon":0.1339385650982611},
{"x":144,"actual":-1.6232213068211496,"recon":-1.6232213068211496},
{"x":145,"actual":-2.335164733189512,"recon":-2.335164733189512},
{"x":146,"actual":-1.5997654039080251,"recon":-1.5997654039080251},
{"x":147,"actual":-2.2022484905238517,"recon":-2.2022484905238517},
{"x":148,"actual":-1.1491668959498356,"recon":-1.1491668959498356},
{"x":149,"actual":1.4448415109905657,"recon":1.4448415109905657},
{"x":150,"actual":-1.4896274936750118,"recon":-1.4896274936750118},
{"x":151,"actual":-0.10839945493170138,"recon":-0.10839945493170138},
{"x":152,"actual":-1.936874574602914,"recon":-1.936874574602914},
{"x":153,"actual":-0.09724914344694126,"recon":-0.09724914344694126},
{"x":154,"actual":-2.0147363488520953,"recon":-2.0147363488520953},
{"x":155,"actual":1.3824526593576294,"recon":1.3824526593576294},
{"x":156,"actual":-1.5655335616330786,"recon":-1.5655335616330786},
{"x":157,"actual":-1.4211622822094951,"recon":-1.4211622822094951},
{"x":158,"actual":-0.0007118426809745056,"recon":-0.0007118426809745171},
{"x":159,"actual":-0.04212466710600698,"recon":-0.042124667106006985},
{"x":160,"actual":-1.0631676722305348,"recon":-1.0631676722305348},
{"x":161,"actual":0.3724644825211509,"recon":0.3724644825211509},
{"x":162,"actual":0.9540986301450674,"recon":0.9540986301450674},
{"x":163,"actual":0.2661812098409057,"recon":0.2661812098409057},
{"x":164,"actual":-0.29701337039602127,"recon":-0.29701337039602127},
{"x":165,"actual":-0.7252095122499744,"recon":-0.7252095122499744},
{"x":166,"actual":0.5025762818263592,"recon":0.5025762818263592},
{"x":167,"actual":-0.9590289392556218,"recon":-0.9590289392556218},
{"x":168,"actual":0.41977550176826056,"recon":0.41977550176826056},
{"x":169,"actual":0.38410886505272296,"recon":0.38410886505272296},
{"x":170,"actual":0.3949374199596939,"recon":0.3949374199596939},
{"x":171,"actual":1.7129907922289054,"recon":1.7129907922289054},
{"x":172,"actual":0.3785684038407532,"recon":0.3785684038407532},
{"x":173,"actual":-1.6956817540450246,"recon":-1.6956817540450246},
{"x":174,"actual":-2.428287278675299,"recon":-2.428287278675299},
{"x":175,"actual":-0.5940961026020448,"recon":-0.5940961026020448},
{"x":176,"actual":1.4696807400371157,"recon":1.4696807400371157},
{"x":177,"actual":0.2012272804983731,"recon":0.2012272804983731},
{"x":178,"actual":-1.5342210636913995,"recon":-1.5342210636913995},
{"x":179,"actual":-0.5842844414588794,"recon":-0.5842844414588794},
{"x":180,"actual":-1.2885302538474879,"recon":-1.2885302538474879},
{"x":181,"actual":-0.12907608278280486,"recon":-0.12907608278280486},
{"x":182,"actual":0.673807633035652,"recon":0.673807633035652},
{"x":183,"actual":2.1080859626392168,"recon":2.1080859626392168},
{"x":184,"actual":1.8128917271390366,"recon":1.8128917271390366},
{"x":185,"actual":1.0012128111923548,"recon":1.0012128111923548},
{"x":186,"actual":-1.0981887222790498,"recon":-1.0981887222790498},
{"x":187,"actual":-0.9330041728383178,"recon":-0.9330041728383178},
{"x":188,"actual":-0.2406908032268262,"recon":-0.2406908032268262},
{"x":189,"actual":0.4919209494848318,"recon":0.4919209494848318},
{"x":190,"actual":0.05175348723309896,"recon":0.05175348723309897},
{"x":191,"actual":-0.5566148519673147,"recon":-0.5566148519673147},
{"x":192,"actual":-1.197929469882166,"recon":-1.197929469882166},
{"x":193,"actual":-1.0949513200674024,"recon":-1.0949513200674024},
{"x":194,"actual":0.1378005680487438,"recon":0.1378005680487438},
{"x":195,"actual":0.8732078044210568,"recon":0.8732078044210568},
{"x":196,"actual":0.039704689142493844,"recon":0.03970468914249384},
{"x":197,"actual":-0.41594304381256814,"recon":-0.41594304381256814},
{"x":198,"actual":0.20378537558960677,"recon":0.20378537558960677}];
    const series = [{"name":"Actual","color":"#1f77b4","key":"actual","dash":""},{"name":"Reconstructed","color":"#ff7f0e","key":"recon","dash":"6,3"}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#hd_line_52');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":-0.0268433157437129,"s2":-0.031018296787199383,"s3":0.5480736539820562},
{"x":2,"s1":-0.011400271474695701,"s2":-0.0012979770727082757,"s3":1.3206657517277045},
{"x":3,"s1":0.08503044934369687,"s2":0.009343776730739453,"s3":-0.9381858163888787},
{"x":4,"s1":0.03847415857635055,"s2":-0.014820791007107918,"s3":-1.2123443750358736},
{"x":5,"s1":-0.024538513302856942,"s2":0.10700964204039709,"s3":-1.028070531079725},
{"x":6,"s1":-0.09204797365668328,"s2":0.05010753940815685,"s3":2.3293625001228384},
{"x":7,"s1":-0.18800858724723776,"s2":-0.05039981710220647,"s3":1.2451547368156082},
{"x":8,"s1":-0.02892805480344883,"s2":-0.03347326256286639,"s3":-1.5754662055885476},
{"x":9,"s1":-0.12464006433914364,"s2":0.018707247124989702,"s3":0.2614363621094202},
{"x":10,"s1":0.0566334240904884,"s2":-0.002128888121362678,"s3":-1.4079631402310508},
{"x":11,"s1":-0.0025357583637942707,"s2":-0.047281012884431976,"s3":1.4266610038860574},
{"x":12,"s1":-0.033636387992932656,"s2":-0.010639483410448155,"s3":-1.4002705472149468},
{"x":13,"s1":0.0419701763488023,"s2":-0.006424270448342916,"s3":0.6503919269205347},
{"x":14,"s1":0.09928993112791402,"s2":0.0003503383051547136,"s3":-0.9122209129791312},
{"x":15,"s1":-0.027069661497126408,"s2":-0.03741961498757731,"s3":-0.5756566352601734},
{"x":16,"s1":-0.08156684990129637,"s2":-0.039815510841659116,"s3":1.4224897597687762},
{"x":17,"s1":0.004096957231196194,"s2":0.0064470909925893735,"s3":-0.42475073739144864},
{"x":18,"s1":-0.025816073222107837,"s2":0.010034786463144795,"s3":0.44460729711329927},
{"x":19,"s1":-0.10688976946695954,"s2":0.061784508905420074,"s3":0.9456162916465256},
{"x":20,"s1":-0.11251189533846347,"s2":-0.019347165195218924,"s3":-0.529812664164226},
{"x":21,"s1":0.09236893427738589,"s2":-0.05468744775910273,"s3":0.47587745387281755},
{"x":22,"s1":0.15791843111797774,"s2":0.006428348844706071,"s3":-0.09144721377826995},
{"x":23,"s1":0.1348683676940611,"s2":0.04267240049055229,"s3":0.5509497159638329},
{"x":24,"s1":0.09038703613051317,"s2":-0.04733594265795622,"s3":1.0026346796386505},
{"x":25,"s1":0.12487664251041479,"s2":0.040240315829356145,"s3":1.7915390542910061},
{"x":26,"s1":0.04180101582986674,"s2":0.08383068463215003,"s3":1.9531775441431976},
{"x":27,"s1":0.08365966689245984,"s2":-0.00761900339347124,"s3":-0.46070513430033355},
{"x":28,"s1":0.034312304286676594,"s2":-0.019474416713390903,"s3":-0.8912531428243877},
{"x":29,"s1":0.009294491393902746,"s2":-0.028097916882819794,"s3":-0.058540676140874444},
{"x":30,"s1":0.09340982965211317,"s2":-0.03011829359103403,"s3":-1.2454074429562165},
{"x":31,"s1":0.13782876800343996,"s2":-0.040015211369844275,"s3":-1.0747461124191073},
{"x":32,"s1":0.07168105653746693,"s2":0.007507249702182073,"s3":0.31534957007250775},
{"x":33,"s1":0.0010330785114252132,"s2":-0.05362812103626889,"s3":-1.28372009277521},
{"x":34,"s1":0.004817727460034577,"s2":-0.013816553217100926,"s3":-0.06254754131386114},
{"x":35,"s1":0.08598692754516679,"s2":0.058811871467073396,"s3":0.867975431758063},
{"x":36,"s1":0.0005392548037080211,"s2":0.07643267326584796,"s3":0.7644175808334177},
{"x":37,"s1":-0.049875466815861934,"s2":0.05065226415220755,"s3":2.0594442554074144},
{"x":38,"s1":-0.08149844218886831,"s2":-0.10555040066352288,"s3":-1.948638231297405},
{"x":39,"s1":0.016523080103384033,"s2":-0.0061728587148123255,"s3":-0.9343665375925163},
{"x":40,"s1":0.022511351376038515,"s2":0.040643499409844554,"s3":-0.3484926917304116},
{"x":41,"s1":0.1690729624597156,"s2":-0.009829569862529749,"s3":0.7247884135347981},
{"x":42,"s1":-0.013648703120717129,"s2":0.035695659943018807,"s3":1.3520078935437732},
{"x":43,"s1":0.013721965611999386,"s2":-0.04222935941660746,"s3":-0.5920886892086525},
{"x":44,"s1":-0.060214265162495055,"s2":-0.07204129616642625,"s3":0.16247845877724923},
{"x":45,"s1":-0.04240843856826101,"s2":0.030054218045543486,"s3":0.53546160048295},
{"x":46,"s1":0.0055700797672131675,"s2":0.07501532322696294,"s3":-0.657968557930126},
{"x":47,"s1":-0.0838309823083573,"s2":0.019454332703834985,"s3":1.3290904647264097},
{"x":48,"s1":-0.11079168921525002,"s2":-0.054131172527967786,"s3":0.20386502761513986},
{"x":49,"s1":-0.030724652223096997,"s2":0.015724124542379883,"s3":0.6516638426024416},
{"x":50,"s1":0.04931908270616453,"s2":0.05308302194648829,"s3":-1.1314070353521881},
{"x":51,"s1":-0.04777427873062324,"s2":0.02843683988241769,"s3":-0.41326290436098845},
{"x":52,"s1":0.1049989263251267,"s2":-0.00553985498756366,"s3":0.6832463982713586},
{"x":53,"s1":0.022160202675484797,"s2":-0.028773833416294737,"s3":0.9279876571943155},
{"x":54,"s1":0.04738606693045522,"s2":0.006423989832977215,"s3":0.39443213495938345},
{"x":55,"s1":-0.12567716770486498,"s2":0.04351596392049514,"s3":-0.3486886841408924},
{"x":56,"s1":-0.05406224330807559,"s2":0.05377449569459552,"s3":0.4317257477104056},
{"x":57,"s1":0.071581979658353,"s2":-0.030479197755098483,"s3":0.0901596419419124},
{"x":58,"s1":-0.05600553082472899,"s2":-0.10272384172503879,"s3":-0.009589955863688689},
{"x":59,"s1":0.1248808993703366,"s2":0.04547935222735399,"s3":-0.15821296596034284},
{"x":60,"s1":0.09924627212208256,"s2":0.009632151876785086,"s3":-0.51129597067635},
{"x":61,"s1":-0.037716392997205785,"s2":-0.05670414809210479,"s3":-0.14849080270554818},
{"x":62,"s1":-0.10183141953280277,"s2":0.015096725725438881,"s3":-0.21459601693328434},
{"x":63,"s1":0.09425842061792683,"s2":0.006100262497369281,"s3":-0.77556531667735},
{"x":64,"s1":-0.1305126235138117,"s2":0.006586240423642035,"s3":-0.8179555907414976},
{"x":65,"s1":0.06770414326867234,"s2":-0.005066047269490526,"s3":-0.8807703027980347},
{"x":66,"s1":-0.17899871161628023,"s2":-0.05590205577708299,"s3":-1.5538892443943488},
{"x":67,"s1":0.0052534287873807015,"s2":0.010939747434996509,"s3":1.5223517549191283},
{"x":68,"s1":-0.033011597888510553,"s2":0.0587649029609739,"s3":1.2769861963585472},
{"x":69,"s1":-0.08923783258494569,"s2":-0.002460952432280625,"s3":1.8379343160328856},
{"x":70,"s1":0.12315639124193827,"s2":0.11780288480162857,"s3":2.8307009021596143},
{"x":71,"s1":0.03390457033643937,"s2":0.0196483037066228,"s3":-0.015294586205572237},
{"x":72,"s1":-0.02731742748239357,"s2":-0.062078032988706684,"s3":0.8809444258803409},
{"x":73,"s1":-0.0638730412426234,"s2":-0.061756395693282104,"s3":0.521610828523712},
{"x":74,"s1":0.07844523042699213,"s2":0.012156128215713252,"s3":1.245447952423588},
{"x":75,"s1":-0.16146112618230354,"s2":0.038552189036067476,"s3":-1.2764952049235714},
{"x":76,"s1":-0.03662692142410198,"s2":-0.07801951745333588,"s3":0.5390739284004367},
{"x":77,"s1":-0.005323530324496116,"s2":-0.02947233483950703,"s3":-1.4846590588022888},
{"x":78,"s1":-0.07120712562045525,"s2":0.04109604360536613,"s3":0.9971460203371105},
{"x":79,"s1":0.041220883085586676,"s2":-0.01085612080044691,"s3":-0.9197098009207887},
{"x":80,"s1":-0.12329419119357936,"s2":-0.019347376949611726,"s3":-2.168062585351621},
{"x":81,"s1":-0.07105137191548555,"s2":0.033493332280226114,"s3":0.21252802550831512},
{"x":82,"s1":-0.006396764752691416,"s2":-0.03696366851082515,"s3":0.24788722158086207},
{"x":83,"s1":-0.07577728168597339,"s2":-0.045796317521436716,"s3":0.7580184223120334},
{"x":84,"s1":0.003643906193205705,"s2":0.0556873859485412,"s3":0.09005341651744056},
{"x":85,"s1":-0.12003035376172604,"s2":0.07172807964174172,"s3":-2.326906347131529},
{"x":86,"s1":0.06862028244886281,"s2":0.059065038023036136,"s3":0.46365461541809194},
{"x":87,"s1":-0.05942168288321527,"s2":-0.005086488601170613,"s3":1.5664176484588124},
{"x":88,"s1":-0.0247786795062,"s2":-0.008774372065710204,"s3":0.5210674540043589},
{"x":89,"s1":0.06185704856505684,"s2":-0.03908571969813145,"s3":-0.7003574168559518},
{"x":90,"s1":-0.023489717252066757,"s2":-0.029440570628324548,"s3":1.5032438416851883},
{"x":91,"s1":-0.10242983414840957,"s2":0.03195926878437595,"s3":0.10530065774972812},
{"x":92,"s1":0.029791844885018227,"s2":0.01463211006879208,"s3":-0.3256176359390224},
{"x":93,"s1":-0.12847369439507106,"s2":-0.02914254209893301,"s3":-0.291440804858492},
{"x":94,"s1":0.08703318825324236,"s2":0.017647356928849146,"s3":2.171910290727316},
{"x":95,"s1":0.01899214794546611,"s2":-0.02633978754151706,"s3":-0.45862388326024084},
{"x":96,"s1":0.05452453614069585,"s2":-0.08092172072246458,"s3":-0.02492475131008767},
{"x":97,"s1":0.04960855995953947,"s2":0.019864222144120102,"s3":0.3290037748653697},
{"x":98,"s1":0.02309113333505881,"s2":0.0859346153550617,"s3":0.24794093731630254},
{"x":99,"s1":0.12625663630047845,"s2":-0.06120167416945246,"s3":-0.49522286754789924},
{"x":100,"s1":-0.09685587985924572,"s2":0.009216325786909046,"s3":1.041196153689368},
{"x":101,"s1":0.015093633626628434,"s2":0.005930175508932978,"s3":0.25570860582545923},
{"x":102,"s1":-0.1562669402807309,"s2":-0.02789911836791617,"s3":0.3987827292222246},
{"x":103,"s1":-0.011913598691219631,"s2":-0.01963653718983809,"s3":0.8743409387582812},
{"x":104,"s1":-0.01105075199366758,"s2":0.03703325362291743,"s3":1.7140782196818074},
{"x":105,"s1":0.09495121804577493,"s2":-0.02508601725951065,"s3":-0.1470915401256783},
{"x":106,"s1":-0.0027028695479764777,"s2":-0.11005788576906896,"s3":-0.19457203975091567},
{"x":107,"s1":0.18469646323599156,"s2":-0.010135646625276735,"s3":-0.4674579225738363},
{"x":108,"s1":-0.04036680798255984,"s2":0.14128870267342986,"s3":-0.38655739138548884},
{"x":109,"s1":-0.00247340922299879,"s2":0.0029166071700869652,"s3":0.5751885073324201},
{"x":110,"s1":-0.031276525243798044,"s2":-0.06159822912587691,"s3":0.07206580529712565},
{"x":111,"s1":-0.07347155614866636,"s2":0.055838128615714466,"s3":-0.6101296791360604},
{"x":112,"s1":0.05839663771802757,"s2":-0.04001826471618828,"s3":2.18534252892887},
{"x":113,"s1":0.07560167184130792,"s2":-0.059311301971650514,"s3":0.20075722500486093},
{"x":114,"s1":0.054480254566716825,"s2":0.031329287962443136,"s3":0.512382667820929},
{"x":115,"s1":-0.0021325832936021213,"s2":0.012468416490068145,"s3":-1.1074340398554618},
{"x":116,"s1":-0.131301583097652,"s2":-0.04764511911061818,"s3":0.5449483826095645},
{"x":117,"s1":-0.11004350936383424,"s2":0.03481383491570391,"s3":-1.4046310096390648},
{"x":118,"s1":-0.03277125190234529,"s2":-0.0018357039982601555,"s3":-0.8361135668428666},
{"x":119,"s1":0.02770134272274928,"s2":0.02231029471496494,"s3":-0.5020665747686822},
{"x":120,"s1":0.027772560242484323,"s2":0.051567311795659466,"s3":-1.724232248266273},
{"x":121,"s1":-0.014559902738447579,"s2":-0.013354521264335789,"s3":-0.3628871353764252},
{"x":122,"s1":-0.06999063400025186,"s2":-0.033601952112689876,"s3":-1.679632779404479},
{"x":123,"s1":0.026039969410457692,"s2":0.03891636068792643,"s3":-0.6467377778564263},
{"x":124,"s1":-0.01664632960355004,"s2":-0.025767069927495726,"s3":-0.26781875897332413},
{"x":125,"s1":0.003803308874109553,"s2":-0.03043413183941375,"s3":0.6814248497733835},
{"x":126,"s1":-0.0029486396478895375,"s2":0.020468690370817062,"s3":-0.06435624954232273},
{"x":127,"s1":0.035222975392194024,"s2":0.012799286153108592,"s3":-0.7453564113741101},
{"x":128,"s1":-0.032386075532564534,"s2":0.021012989058770807,"s3":-1.1278498841938653},
{"x":129,"s1":0.06493933599996955,"s2":-0.04187323727134029,"s3":-1.4897457354116066},
{"x":130,"s1":0.012951235625821915,"s2":-0.011245558084416116,"s3":0.6337782423863387},
{"x":131,"s1":-0.045500814711013145,"s2":0.015481227767663244,"s3":-1.5892656440286441},
{"x":132,"s1":-0.12214950870386197,"s2":-0.024242073359035256,"s3":-0.9954959422162586},
{"x":133,"s1":-0.06459775689849842,"s2":-0.006725788878205177,"s3":1.051377225479238},
{"x":134,"s1":0.027736991376476616,"s2":0.03965524173393057,"s3":0.04795361363566252},
{"x":135,"s1":-0.13200088325449477,"s2":0.018249439139863714,"s3":-0.9469713460537598},
{"x":136,"s1":0.1108161342350171,"s2":-0.05436397949905887,"s3":0.10959054087847646},
{"x":137,"s1":-0.10344477671115508,"s2":-0.07074852055714244,"s3":0.8101873841600173},
{"x":138,"s1":-0.0047287751275287854,"s2":0.022752796695647413,"s3":0.44873734308773255},
{"x":139,"s1":0.007869743091003956,"s2":0.04703480633712136,"s3":-0.9802154701667591},
{"x":140,"s1":-0.049592041368509636,"s2":-0.02798899914004033,"s3":1.2299880864338082},
{"x":141,"s1":0.13287238408821483,"s2":-0.003952355257749171,"s3":-1.807995282204217},
{"x":142,"s1":0.016174340710058303,"s2":0.016917597293959002,"s3":-2.309470684023147},
{"x":143,"s1":0.044586966282785856,"s2":0.011078723839188807,"s3":-1.1948500408769953},
{"x":144,"s1":0.09286219506209037,"s2":-0.10262587900295499,"s3":1.044676664318869},
{"x":145,"s1":0.06871889407729749,"s2":-0.07362189866610917,"s3":-0.6445089398248648},
{"x":146,"s1":0.013473379945897014,"s2":0.04682549873628413,"s3":0.04087495492218913},
{"x":147,"s1":-0.020509249692497396,"s2":0.0541330025936513,"s3":0.4906495613378054},
{"x":148,"s1":-0.03896534987070553,"s2":0.02315257558045971,"s3":1.44357734585562},
{"x":149,"s1":0.04530674345668606,"s2":0.1205949776626383,"s3":-0.7267613651536508},
{"x":150,"s1":-0.05478715659741755,"s2":0.0187218842877741,"s3":1.288313292550712},
{"x":151,"s1":0.024234111191307847,"s2":-0.07098597033751727,"s3":0.35322197686361106},
{"x":152,"s1":-0.079104650122906,"s2":-0.0003886414228619808,"s3":-0.023614825157087693},
{"x":153,"s1":-0.010522646104969986,"s2":0.009634846116276003,"s3":-2.0437845166025936},
{"x":154,"s1":-0.10158650015708372,"s2":0.02524694070286222,"s3":2.386380945180861},
{"x":155,"s1":-0.05388703507173833,"s2":0.021701609545663286,"s3":0.8525810508572328},
{"x":156,"s1":0.03708996898330852,"s2":0.03221456185381535,"s3":0.4184466092719424},
{"x":157,"s1":0.07217328957832374,"s2":-0.07783188207356294,"s3":0.5915953073369841},
{"x":158,"s1":-0.1041167923620996,"s2":0.06338297117843901,"s3":0.05600007898636961},
{"x":159,"s1":0.12100588263137199,"s2":0.04812006616061811,"s3":-0.5443505846285334},
{"x":160,"s1":0.04459128738733179,"s2":-0.040818207066265565,"s3":-0.010778113762001683},
{"x":161,"s1":-0.05742026379044806,"s2":0.01662692609843809,"s3":-0.9034151370444017},
{"x":162,"s1":0.15188279449022185,"s2":0.0572116613416953,"s3":-1.1770251254632658},
{"x":163,"s1":-0.10406680701862518,"s2":-0.008251243205397826,"s3":-0.28282571098464154},
{"x":164,"s1":0.06442055446210544,"s2":-0.05006332454524455,"s3":0.8880279018695522},
{"x":165,"s1":0.05825605412937494,"s2":-0.04703608420059813,"s3":0.20981913415093872},
{"x":166,"s1":-0.024878436793959475,"s2":0.0429503963541403,"s3":-1.0010170763426849},
{"x":167,"s1":-0.06343565994533211,"s2":0.017997408415367858,"s3":-0.49874603323905675},
{"x":168,"s1":0.2041698123775699,"s2":-0.03473105852278579,"s3":-1.068409081566443},
{"x":169,"s1":-0.04065860379545419,"s2":0.04488708129385005,"s3":-1.2840734848548678},
{"x":170,"s1":0.10326907109558282,"s2":0.004110208810588261,"s3":-0.13555842793516185},
{"x":171,"s1":-0.03262948062990866,"s2":0.01107400459202055,"s3":0.6869494253351149},
{"x":172,"s1":-0.012898654673105235,"s2":-0.0014547418292244856,"s3":0.6223076207248464},
{"x":173,"s1":0.011903109785393568,"s2":-0.11375328988253652,"s3":-0.18151272371757948},
{"x":174,"s1":0.050420601577218165,"s2":-0.07310512715356554,"s3":0.07441815670476505},
{"x":175,"s1":-0.18705391783633152,"s2":0.06292373455200367,"s3":-0.3786880392545151},
{"x":176,"s1":0.028077819685828002,"s2":0.1308943469431173,"s3":0.44416583518343905},
{"x":177,"s1":0.06460190103971673,"s2":0.00944577009180902,"s3":-0.7635279616518542},
{"x":178,"s1":0.14417112911685312,"s2":-0.09929596114031933,"s3":2.4978921471254925},
{"x":179,"s1":0.03810036089375576,"s2":-0.026530298871119497,"s3":0.2345055773922172},
{"x":180,"s1":0.13420257127260057,"s2":0.03375884222977865,"s3":0.514068359339938},
{"x":181,"s1":0.037781974693299004,"s2":0.02828556036370862,"s3":-0.9484315459245091},
{"x":182,"s1":0.1341045008045008,"s2":0.0628367280157326,"s3":-1.1553246206806933},
{"x":183,"s1":0.02861342107491512,"s2":0.05241255977945308,"s3":1.3059909016907403},
{"x":184,"s1":0.04432896767240135,"s2":0.007587691832590402,"s3":0.08170516128437125},
{"x":185,"s1":-0.007171041822626487,"s2":-0.06378111236751142,"s3":-0.8489574746365017},
{"x":186,"s1":-0.10904272814552385,"s2":-0.08475611971461103,"s3":1.4147297926278526},
{"x":187,"s1":0.06162926991897015,"s2":-0.08289931526375775,"s3":0.014118845706862695},
{"x":188,"s1":0.009793223567134053,"s2":0.03478249115175607,"s3":0.8368141065894202},
{"x":189,"s1":-0.1512900241230038,"s2":0.07458092239637444,"s3":-0.1395344569267215},
{"x":190,"s1":0.06984300089154175,"s2":-0.0037363099300135177,"s3":-0.9259471089265559},
{"x":191,"s1":0.017122468102738212,"s2":-0.04661004064593727,"s3":0.6588774687591107},
{"x":192,"s1":-0.09098313289131951,"s2":-0.029973654300220833,"s3":-0.47005240741318355},
{"x":193,"s1":-0.0299203275111824,"s2":-0.009988880788749757,"s3":0.34176824786670706},
{"x":194,"s1":-0.05054711332525672,"s2":0.050291858295523746,"s3":-2.228658042639732},
{"x":195,"s1":0.14690328998740992,"s2":0.06264071902442228,"s3":-0.13603479850265426},
{"x":196,"s1":-0.09722226072341655,"s2":-0.006465936311198422,"s3":0.5722610824423159},
{"x":197,"s1":-0.09858646301108648,"s2":-0.05230591540794884,"s3":-1.4238205150773924},
{"x":198,"s1":-0.009566831651049565,"s2":0.000957039977033167,"s3":-0.7339182546192439}];
    const series = [{"name":"Shock 1","color":"#1f77b4","key":"s1","dash":""},{"name":"Shock 2","color":"#ff7f0e","key":"s2","dash":""},{"name":"Shock 3","color":"#2ca02c","key":"s3","dash":""}];
    const mode = 'stacked';

    const container = d3.select('#hd_bar_53');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Contribution') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Contribution');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"actual":0.6040781375558437,"recon":0.6040781375558437},
{"x":2,"actual":1.323975871605075,"recon":1.323975871605075},
{"x":3,"actual":-0.8041415779212032,"recon":-0.8041415779212032},
{"x":4,"actual":-1.1655099115971852,"recon":-1.1655099115971852},
{"x":5,"actual":-0.9246227347782955,"recon":-0.9246227347782955},
{"x":6,"actual":2.3076541548609963,"recon":2.3076541548609963},
{"x":7,"actual":1.0275525442743354,"recon":1.0275525442743354},
{"x":8,"actual":-1.6171073899977824,"recon":-1.6171073899977824},
{"x":9,"actual":0.17619718957134095,"recon":0.17619718957134095},
{"x":10,"actual":-1.3327935030351896,"recon":-1.3327935030351896},
{"x":11,"actual":1.3975173413848279,"recon":1.3975173413848279},
{"x":12,"actual":-1.4238698713905256,"recon":-1.4238698713905256},
{"x":13,"actual":0.7066139156590852,"recon":0.7066139156590852},
{"x":14,"actual":-0.7919054131663745,"recon":-0.7919054131663745},
{"x":15,"actual":-0.6194707428946498,"recon":-0.6194707428946498},
{"x":16,"actual":1.32178266536062,"recon":1.32178266536062},
{"x":17,"actual":-0.3935313962819023,"recon":-0.3935313962819023},
{"x":18,"actual":0.44950129001214406,"recon":0.44950129001214406},
{"x":19,"actual":0.9211863042765286,"recon":0.9211863042765286},
{"x":20,"actual":-0.6409964508362196,"recon":-0.6409964508362196},
{"x":21,"actual":0.5342342153530135,"recon":0.5342342153530135},
{"x":22,"actual":0.09357484119899823,"recon":0.09357484119899823},
{"x":23,"actual":0.7491657589973484,"recon":0.7491657589973484},
{"x":24,"actual":1.0663610479200738,"recon":1.0663610479200738},
{"x":25,"actual":1.977331287458031,"recon":1.977331287458031},
{"x":26,"actual":2.0994845194414373,"recon":2.0994845194414373},
{"x":27,"actual":-0.36398919596652585,"recon":-0.36398919596652585},
{"x":28,"actual":-0.855739980417965,"recon":-0.855739980417965},
{"x":29,"actual":-0.05666882679673377,"recon":-0.05666882679673377},
{"x":30,"actual":-1.1614406320618373,"recon":-1.1614406320618373},
{"x":31,"actual":-0.9562572809521593,"recon":-0.9562572809521593},
{"x":32,"actual":0.4152131511454801,"recon":0.4152131511454801},
{"x":33,"actual":-1.315639860466744,"recon":-1.315639860466744},
{"x":34,"actual":-0.05087109223761541,"recon":-0.05087109223761541},
{"x":35,"actual":1.0334495056036175,"recon":1.0334495056036175},
{"x":36,"actual":0.8620647837362881,"recon":0.8620647837362881},
{"x":37,"actual":2.0808963275770727,"recon":2.0808963275770727},
{"x":38,"actual":-2.115011799316482,"recon":-2.115011799316482},
{"x":39,"actual":-0.9033410413706305,"recon":-0.9033410413706305},
{"x":40,"actual":-0.2646625661112143,"recon":-0.2646625661112143},
{"x":41,"actual":0.9047070809652977,"recon":0.9047070809652977},
{"x":42,"actual":1.3947301251993889,"recon":1.3947301251993889},
{"x":43,"actual":-0.5999208081799463,"recon":-0.5999208081799463},
{"x":44,"actual":0.05089817228164207,"recon":0.05089817228164207},
{"x":45,"actual":0.5437826547935463,"recon":0.5437826547935463},
{"x":46,"actual":-0.5567078801026357,"recon":-0.5567078801026357},
{"x":47,"actual":1.2853890899552018,"recon":1.2853890899552018},
{"x":48,"actual":0.059617440705236356,"recon":0.059617440705236356},
{"x":49,"actual":0.6573385897550387,"recon":0.6573385897550387},
{"x":50,"actual":-1.0083296558662211,"recon":-1.0083296558662211},
{"x":51,"actual":-0.4119250683758798,"recon":-0.4119250683758798},
{"x":52,"actual":0.8033807444422357,"recon":0.8033807444422357},
{"x":53,"actual":0.9420493012868197,"recon":0.9420493012868197},
{"x":54,"actual":0.46891746655613004,"recon":0.46891746655613004},
{"x":55,"actual":-0.4101746130919481,"recon":-0.4101746130919481},
{"x":56,"actual":0.4521132749302398,"recon":0.4521132749302398},
{"x":57,"actual":0.1519376986784811,"recon":0.1519376986784811},
{"x":58,"actual":-0.1476440535801423,"recon":-0.1476440535801423},
{"x":59,"actual":0.03282256047066197,"recon":0.03282256047066197},
{"x":60,"actual":-0.38174227184416837,"recon":-0.38174227184416837},
{"x":61,"actual":-0.22223606896154458,"recon":-0.22223606896154458},
{"x":62,"actual":-0.2806554359073341,"recon":-0.2806554359073341},
{"x":63,"actual":-0.6545313587287397,"recon":-0.6545313587287397},
{"x":64,"actual":-0.921206698998353,"recon":-0.921206698998353},
{"x":65,"actual":-0.7974569319655386,"recon":-0.7974569319655386},
{"x":66,"actual":-1.7681147369543984,"recon":-1.7681147369543984},
{"x":67,"actual":1.5592202059748197,"recon":1.5592202059748197},
{"x":68,"actual":1.3234147762643247,"recon":1.3234147762643247},
{"x":69,"actual":1.7669108058489738,"recon":1.7669108058489738},
{"x":70,"actual":3.092335453036495,"recon":3.092335453036495},
{"x":71,"actual":0.0589335626708041,"recon":0.0589335626708041},
{"x":72,"actual":0.8122242402425549,"recon":0.8122242402425549},
{"x":73,"actual":0.4166566664211206,"recon":0.4166566664211206},
{"x":74,"actual":1.3567245858996066,"recon":1.3567245858996066},
{"x":75,"actual":-1.3787288672364928,"recon":-1.3787288672364928},
{"x":76,"actual":0.44510276435631296,"recon":0.44510276435631296},
{"x":77,"actual":-1.498779649132977,"recon":-1.498779649132977},
{"x":78,"actual":0.9877102131553351,"recon":0.9877102131553351},
{"x":79,"actual":-0.8686697638023346,"recon":-0.8686697638023346},
{"x":80,"actual":-2.2900288786614977,"recon":-2.2900288786614977},
{"x":81,"actual":0.19564526070636978,"recon":0.19564526070636978},
{"x":82,"actual":0.2252020631506597,"recon":0.2252020631506597},
{"x":83,"actual":0.6571200979379376,"recon":0.6571200979379376},
{"x":84,"actual":0.1700599834925016,"recon":0.1700599834925016},
{"x":85,"actual":-2.3545333464182,"recon":-2.3545333464182},
{"x":86,"actual":0.612015210723305,"recon":0.612015210723305},
{"x":87,"actual":1.5225847518077407,"recon":1.5225847518077407},
{"x":88,"actual":0.5081896772657628,"recon":0.5081896772657628},
{"x":89,"actual":-0.6569108131557121,"recon":-0.6569108131557121},
{"x":90,"actual":1.4709888286381116,"recon":1.4709888286381116},
{"x":91,"actual":0.05550536721900871,"recon":0.05550536721900871},
{"x":92,"actual":-0.2605184061518979,"recon":-0.2605184061518979},
{"x":93,"actual":-0.4283817665191817,"recon":-0.4283817665191817},
{"x":94,"actual":2.2972661107427217,"recon":2.2972661107427217},
{"x":95,"actual":-0.4452962480229775,"recon":-0.4452962480229775},
{"x":96,"actual":-0.030646661058542215,"recon":-0.030646661058542215},
{"x":97,"actual":0.41915183180234333,"recon":0.41915183180234333},
{"x":98,"actual":0.3776419608397371,"recon":0.3776419608397371},
{"x":99,"actual":-0.40949263058355917,"recon":-0.40949263058355917},
{"x":100,"actual":0.9742318744503455,"recon":0.9742318744503455},
{"x":101,"actual":0.2974076897943349,"recon":0.2974076897943349},
{"x":102,"actual":0.23529194540689172,"recon":0.23529194540689172},
{"x":103,"actual":0.8634660777105375,"recon":0.8634660777105375},
{"x":104,"actual":1.7607359961443714,"recon":1.7607359961443714},
{"x":105,"actual":-0.05655106450609967,"recon":-0.05655106450609967},
{"x":106,"actual":-0.2866575202346469,"recon":-0.2866575202346469},
{"x":107,"actual":-0.27222183112980736,"recon":-0.27222183112980736},
{"x":108,"actual":-0.2649602218613045,"recon":-0.2649602218613045},
{"x":109,"actual":0.5963069801128221,"recon":0.5963069801128221},
{"x":110,"actual":-0.00013367423923507028,"recon":-0.00013367423923506955},
{"x":111,"actual":-0.6070878318356983,"recon":-0.6070878318356983},
{"x":112,"actual":2.224396176764023,"recon":2.224396176764023},
{"x":113,"actual":0.23772286970783252,"recon":0.23772286970783252},
{"x":114,"actual":0.6188674851834027,"recon":0.6188674851834027},
{"x":115,"actual":-1.076422931825682,"recon":-1.076422931825682},
{"x":116,"actual":0.3866769552346083,"recon":0.3866769552346083},
{"x":117,"actual":-1.459185409253881,"recon":-1.459185409253881},
{"x":118,"actual":-0.8500452479101577,"recon":-0.8500452479101577},
{"x":119,"actual":-0.4313796624976538,"recon":-0.4313796624976538},
{"x":120,"actual":-1.624217101394816,"recon":-1.624217101394816},
{"x":121,"actual":-0.37012628454589436,"recon":-0.37012628454589436},
{"x":122,"actual":-1.7625500906841063,"recon":-1.7625500906841063},
{"x":123,"actual":-0.5611061729247279,"recon":-0.5611061729247279},
{"x":124,"actual":-0.2895568836710555,"recon":-0.2895568836710555},
{"x":125,"actual":0.6754693016413936,"recon":0.6754693016413936},
{"x":126,"actual":-0.026160923986081,"recon":-0.026160923986081},
{"x":127,"actual":-0.6766588749954937,"recon":-0.6766588749954937},
{"x":128,"actual":-1.1185476958343452,"recon":-1.1185476958343452},
{"x":129,"actual":-1.4460043618496627,"recon":-1.4460043618496627},
{"x":130,"actual":0.6561591947610586,"recon":0.6561591947610586},
{"x":131,"actual":-1.5986099561386793,"recon":-1.5986099561386793},
{"x":132,"actual":-1.1212122494458416,"recon":-1.1212122494458416},
{"x":133,"actual":1.0007289545358482,"recon":1.0007289545358482},
{"x":134,"actual":0.13602112157938387,"recon":0.13602112157938387},
{"x":135,"actual":-1.0400475153350763,"recon":-1.0400475153350763},
{"x":136,"actual":0.18671797044774888,"recon":0.18671797044774888},
{"x":137,"actual":0.6566693617250339,"recon":0.6566693617250339},
{"x":138,"actual":0.48743663948916544,"recon":0.48743663948916544},
{"x":139,"actual":-0.90463564590532,"recon":-0.90463564590532},
{"x":140,"actual":1.1730823207585723,"recon":1.1730823207585723},
{"x":141,"actual":-1.6583999785404366,"recon":-1.6583999785404366},
{"x":142,"actual":-2.2557034711858157,"recon":-2.2557034711858157},
{"x":143,"actual":-1.1185090759217067,"recon":-1.1185090759217067},
{"x":144,"actual":1.0555882552113194,"recon":1.0555882552113194},
{"x":145,"actual":-0.628736669580362,"recon":-0.628736669580362},
{"x":146,"actual":0.12184910843768444,"recon":0.12184910843768444},
{"x":147,"actual":0.5449485890722736,"recon":0.5449485890722736},
{"x":148,"actual":1.4484398463986885,"recon":1.4484398463986885},
{"x":149,"actual":-0.5401843692010122,"recon":-0.5401843692010122},
{"x":150,"actual":1.2729232950743827,"recon":1.2729232950743827},
{"x":151,"actual":0.3271453925507159,"recon":0.3271453925507159},
{"x":152,"actual":-0.08243284186954149,"recon":-0.08243284186954149},
{"x":153,"actual":-2.023997041757974,"recon":-2.023997041757974},
{"x":154,"actual":2.330716660559953,"recon":2.330716660559953},
{"x":155,"actual":0.841070900164472,"recon":0.841070900164472},
{"x":156,"actual":0.5084264149423802,"recon":0.5084264149423802},
{"x":157,"actual":0.606611989675059,"recon":0.606611989675059},
{"x":158,"actual":0.03594153263602316,"recon":0.03594153263602316},
{"x":159,"actual":-0.3545493610032292,"recon":-0.3545493610032292},
{"x":160,"actual":0.013670241392378725,"recon":0.013670241392378726},
{"x":161,"actual":-0.9235331999030975,"recon":-0.9235331999030975},
{"x":162,"actual":-0.9472553947980346,"recon":-0.9472553947980346},
{"x":163,"actual":-0.3744684863753504,"recon":-0.3744684863753504},
{"x":164,"actual":0.9230604066197271,"recon":0.9230604066197271},
{"x":165,"actual":0.24171437891302974,"recon":0.24171437891302974},
{"x":166,"actual":-0.9622698419491902,"recon":-0.9622698419491902},
{"x":167,"actual":-0.5235090099357067,"recon":-0.5235090099357067},
{"x":168,"actual":-0.8782950528783456,"recon":-0.8782950528783456},
{"x":169,"actual":-1.259169732523158,"recon":-1.259169732523158},
{"x":170,"actual":-0.007503873195676641,"recon":-0.007503873195676643},
{"x":171,"actual":0.6860692241305412,"recon":0.6860692241305412},
{"x":172,"actual":0.6286294990558308,"recon":0.6286294990558308},
{"x":173,"actual":-0.2626876289814083,"recon":-0.2626876289814083},
{"x":174,"actual":0.07240890596173186,"recon":0.07240890596173186},
{"x":175,"actual":-0.4821429477055285,"recon":-0.4821429477055285},
{"x":176,"actual":0.6238132766456986,"recon":0.6238132766456986},
{"x":177,"actual":-0.6688050156870146,"recon":-0.6688050156870146},
{"x":178,"actual":2.5634425899353412,"recon":2.5634425899353412},
{"x":179,"actual":0.26675091424816766,"recon":0.26675091424816766},
{"x":180,"actual":0.7027050476756311,"recon":0.7027050476756311},
{"x":181,"actual":-0.8616887360341875,"recon":-0.8616887360341875},
{"x":182,"actual":-0.9377081170271454,"recon":-0.9377081170271454},
{"x":183,"actual":1.4076921573784222,"recon":1.4076921573784222},
{"x":184,"actual":0.15429709562267718,"recon":0.15429709562267718},
{"x":185,"actual":-0.8992343539933253,"recon":-0.8992343539933253},
{"x":186,"actual":1.241606219601032,"recon":1.241606219601032},
{"x":187,"actual":0.01352407519538925,"recon":0.01352407519538925},
{"x":188,"actual":0.9020650961416244,"recon":0.9020650961416244},
{"x":189,"actual":-0.1955682838200366,"recon":-0.1955682838200366},
{"x":190,"actual":-0.8391651431317134,"recon":-0.8391651431317134},
{"x":191,"actual":0.6500651710492259,"recon":0.6500651710492259},
{"x":192,"actual":-0.5703339197714097,"recon":-0.5703339197714097},
{"x":193,"actual":0.32253431440008906,"recon":0.32253431440008906},
{"x":194,"actual":-2.2082380228361496,"recon":-2.2082380228361496},
{"x":195,"actual":0.09418448534249216,"recon":0.09418448534249216},
{"x":196,"actual":0.4892481602410152,"recon":0.4892481602410152},
{"x":197,"actual":-1.5540376186631135,"recon":-1.5540376186631135},
{"x":198,"actual":-0.721852771459946,"recon":-0.721852771459946}];
    const series = [{"name":"Actual","color":"#1f77b4","key":"actual","dash":""},{"name":"Reconstructed","color":"#ff7f0e","key":"recon","dash":"6,3"}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#hd_line_54');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

</script>
</body>
</html>
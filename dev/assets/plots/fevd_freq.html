<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Forecast Error Variance Decomposition</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #fff;
    color: #333;
    padding: 20px;
}
.figure-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 16px;
    color: #222;
}
.figure-source {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 8px;
}
.panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
}
.panel {
    width: calc(33% - 16px);
    min-width: 300px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 12px;
}
.panel-title {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: #444;
}
.axis text { font-size: 11px; fill: #666; }
.axis line, .axis path { stroke: #ccc; }
.grid line { stroke: #f0f0f0; stroke-dasharray: 2,2; }
.grid .domain { stroke: none; }
.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
}
.legend { font-size: 11px; }
.legend rect { rx: 2; }
svg { overflow: visible; }
</style>
</head>
<body>
<div class="figure-title">Forecast Error Variance Decomposition</div>
<div class="panel-grid">
<div class="panel">
<div class="panel-title">y1</div>
<div id="fevd_40"></div>
</div>
<div class="panel">
<div class="panel-title">y2</div>
<div id="fevd_41"></div>
</div>
<div class="panel">
<div class="panel-title">y3</div>
<div id="fevd_42"></div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// Shared utilities
const tooltip = d3.select('#tooltip');
function fmt(v) {
    if (v === null || v === undefined) return '';
    return Math.abs(v) >= 1000 ? v.toFixed(1) : (Math.abs(v) >= 1 ? v.toFixed(3) : v.toFixed(4));
}
function showTip(evt, html) {
    tooltip.html(html).style('opacity',1)
        .style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px');
}
function hideTip() { tooltip.style('opacity',0); }

(function() {
    const data = [{"x":1,"s1":1.0,"s2":0.0,"s3":0.0},
{"x":2,"s1":0.980606459788011,"s2":0.006631181534014497,"s3":0.0127623586779745},
{"x":3,"s1":0.9461549649192289,"s2":0.041221896344165065,"s3":0.012623138736605923},
{"x":4,"s1":0.9291511928709711,"s2":0.058435346777905496,"s3":0.01241346035112343},
{"x":5,"s1":0.9264147190986761,"s2":0.061070578507946775,"s3":0.012514702393377139},
{"x":6,"s1":0.9261217915866483,"s2":0.06117259696539705,"s3":0.012705611447954682},
{"x":7,"s1":0.9260652378406289,"s2":0.06117010496666537,"s3":0.012764657192705763},
{"x":8,"s1":0.9260082603732172,"s2":0.06116557305679438,"s3":0.012826166569988452},
{"x":9,"s1":0.9260072908507712,"s2":0.061164026104114644,"s3":0.012828683045114073},
{"x":10,"s1":0.9259941578998556,"s2":0.06116709878640116,"s3":0.012838743313743153},
{"x":11,"s1":0.92598670913239,"s2":0.06116974460685661,"s3":0.01284354626075337},
{"x":12,"s1":0.9259856317650591,"s2":0.06117006670625228,"s3":0.012844301528688576},
{"x":13,"s1":0.9259841149449336,"s2":0.06116996553198895,"s3":0.01284591952307741},
{"x":14,"s1":0.9259840685239994,"s2":0.06116996031262426,"s3":0.0128459711633764},
{"x":15,"s1":0.925983785449365,"s2":0.06116995794291169,"s3":0.012846256607723488},
{"x":16,"s1":0.9259836668016915,"s2":0.061169959329787776,"s3":0.012846373868520626},
{"x":17,"s1":0.925983653739804,"s2":0.061169958424560376,"s3":0.012846387835635686},
{"x":18,"s1":0.9259836100139449,"s2":0.06116995672339281,"s3":0.012846433262662285},
{"x":19,"s1":0.9259836082685687,"s2":0.06116995660932742,"s3":0.012846435122103884},
{"x":20,"s1":0.9259836009959919,"s2":0.0611699565301267,"s3":0.01284644247388136}];
    const series = [{"name":"y1","color":"#1f77b4","key":"s1","dash":""},{"name":"y2","color":"#ff7f0e","key":"s2","dash":""},{"name":"y3","color":"#2ca02c","key":"s3","dash":""}];

    const container = d3.select('#fevd_40');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":0.3623832100075916,"s2":0.6376167899924085,"s3":0.0},
{"x":2,"s1":0.37707682520361624,"s2":0.6158253107966924,"s3":0.0070978639996912936},
{"x":3,"s1":0.3714900402373981,"s2":0.6204109222203692,"s3":0.008099037542232655},
{"x":4,"s1":0.371666836272763,"s2":0.6201837329152545,"s3":0.008149430811982458},
{"x":5,"s1":0.3677180301956846,"s2":0.6233535949521688,"s3":0.00892837485214652},
{"x":6,"s1":0.36765151255632966,"s2":0.6232495393616286,"s3":0.0090989480820417},
{"x":7,"s1":0.36764126019600274,"s2":0.6232198577219945,"s3":0.009138882082002817},
{"x":8,"s1":0.3676131877940158,"s2":0.6231779599154699,"s3":0.009208852290514248},
{"x":9,"s1":0.36760296850547447,"s2":0.6231774776025183,"s3":0.009219553892007362},
{"x":10,"s1":0.367596293478373,"s2":0.623167088652517,"s3":0.009236617869109912},
{"x":11,"s1":0.36759296969229094,"s2":0.6231645225955309,"s3":0.009242507712178046},
{"x":12,"s1":0.36759272146225375,"s2":0.623164114666961,"s3":0.009243163870785354},
{"x":13,"s1":0.3675919584019444,"s2":0.6231630079378359,"s3":0.009245033660219705},
{"x":14,"s1":0.3675918915366001,"s2":0.6231629094351123,"s3":0.009245199028287432},
{"x":15,"s1":0.367591779701801,"s2":0.6231626579912977,"s3":0.009245562306901293},
{"x":16,"s1":0.3675917023301609,"s2":0.6231625581288903,"s3":0.00924573954094873},
{"x":17,"s1":0.3675916975369821,"s2":0.6231625508398155,"s3":0.00924575162320234},
{"x":18,"s1":0.36759167582466823,"s2":0.6231625147294203,"s3":0.009245809445911463},
{"x":19,"s1":0.3675916743514447,"s2":0.6231625118541839,"s3":0.009245813794371399},
{"x":20,"s1":0.36759167154130895,"s2":0.6231625062003525,"s3":0.009245822258338497}];
    const series = [{"name":"y1","color":"#1f77b4","key":"s1","dash":""},{"name":"y2","color":"#ff7f0e","key":"s2","dash":""},{"name":"y3","color":"#2ca02c","key":"s3","dash":""}];

    const container = d3.select('#fevd_41');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":0.010145491916899877,"s2":0.006964046133739463,"s3":0.9828904619493606},
{"x":2,"s1":0.009191149618742633,"s2":0.009292330281916094,"s3":0.9815165200993413},
{"x":3,"s1":0.008981081149512824,"s2":0.015402879414432634,"s3":0.9756160394360546},
{"x":4,"s1":0.009485914329482904,"s2":0.01536355198102577,"s3":0.9751505336894913},
{"x":5,"s1":0.010844858402930554,"s2":0.016200532442777207,"s3":0.9729546091542922},
{"x":6,"s1":0.010780014015591727,"s2":0.016267692063848076,"s3":0.9729522939205602},
{"x":7,"s1":0.010844234220324099,"s2":0.016252798620178654,"s3":0.9729029671594972},
{"x":8,"s1":0.01085309558209108,"s2":0.01631800377563289,"s3":0.9728289006422761},
{"x":9,"s1":0.01085788508058047,"s2":0.016328431902413534,"s3":0.972813683017006},
{"x":10,"s1":0.01087259085175991,"s2":0.016334336799473357,"s3":0.9727930723487667},
{"x":11,"s1":0.010871115760517512,"s2":0.01633698177778131,"s3":0.9727919024617012},
{"x":12,"s1":0.010873009211995306,"s2":0.016336819873465934,"s3":0.9727901709145388},
{"x":13,"s1":0.010873121165293,"s2":0.016337855021504435,"s3":0.9727890238132025},
{"x":14,"s1":0.0108732665873986,"s2":0.016338105358706796,"s3":0.9727886280538947},
{"x":15,"s1":0.010873521244338083,"s2":0.01633822783701463,"s3":0.9727882509186473},
{"x":16,"s1":0.010873478353318422,"s2":0.016338345965870946,"s3":0.9727881756808107},
{"x":17,"s1":0.010873533178164916,"s2":0.016338343661206876,"s3":0.9727881231606282},
{"x":18,"s1":0.010873537254099636,"s2":0.016338371885025103,"s3":0.9727880908608753},
{"x":19,"s1":0.01087354021019596,"s2":0.016338379032478197,"s3":0.9727880807573258},
{"x":20,"s1":0.010873547041728403,"s2":0.016338381185518988,"s3":0.9727880717727526}];
    const series = [{"name":"y1","color":"#1f77b4","key":"s1","dash":""},{"name":"y2","color":"#ff7f0e","key":"s2","dash":""},{"name":"y3","color":"#2ca02c","key":"s3","dash":""}];

    const container = d3.select('#fevd_42');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

</script>
</body>
</html>
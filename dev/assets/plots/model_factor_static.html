<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Static Factor Model (r=3)</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #fff;
    color: #333;
    padding: 20px;
}
.figure-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 16px;
    color: #222;
}
.figure-source {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 8px;
}
.panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
}
.panel {
    width: calc(100% - 16px);
    min-width: 300px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 12px;
}
.panel-title {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: #444;
}
.axis text { font-size: 11px; fill: #666; }
.axis line, .axis path { stroke: #ccc; }
.grid line { stroke: #f0f0f0; stroke-dasharray: 2,2; }
.grid .domain { stroke: none; }
.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
}
.legend { font-size: 11px; }
.legend rect { rx: 2; }
svg { overflow: visible; }
</style>
</head>
<body>
<div class="figure-title">Static Factor Model (r=3)</div>
<div class="panel-grid">
<div class="panel">
<div class="panel-title">Scree Plot</div>
<div id="fm_scree_87"></div>
</div>
<div class="panel">
<div class="panel-title">Extracted Factors</div>
<div id="fm_fac_88"></div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// Shared utilities
const tooltip = d3.select('#tooltip');
function fmt(v) {
    if (v === null || v === undefined) return '';
    return Math.abs(v) >= 1000 ? v.toFixed(1) : (Math.abs(v) >= 1 ? v.toFixed(3) : v.toFixed(4));
}
function showTip(evt, html) {
    tooltip.html(html).style('opacity',1)
        .style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px');
}
function hideTip() { tooltip.style('opacity',0); }

(function() {
    const data = [{"x":"PC 1","eig":1.576475077312052},
{"x":"PC 2","eig":1.4259749077906076},
{"x":"PC 3","eig":1.3932991882833246},
{"x":"PC 4","eig":1.3156745770615563},
{"x":"PC 5","eig":1.2842463069058043},
{"x":"PC 6","eig":1.19412567367326},
{"x":"PC 7","eig":1.148115119440333},
{"x":"PC 8","eig":1.0882397606097087},
{"x":"PC 9","eig":1.035675308868355},
{"x":"PC 10","eig":0.9970448393431481}];
    const series = [{"name":"Eigenvalue","color":"#1f77b4","key":"eig","dash":""}];
    const mode = 'grouped';

    const container = d3.select('#fm_scree_87');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('');
    if('Eigenvalue') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Eigenvalue');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"v1":-0.2622060817443547,"v2":1.0446631520186114,"v3":1.7803668688083993},
{"x":2,"v1":0.4155355914375159,"v2":1.100632444091191,"v3":-0.2846763095336019},
{"x":3,"v1":0.3640939331133902,"v2":0.05414255282382048,"v3":1.4253652727497705},
{"x":4,"v1":0.7160891479938803,"v2":-1.3142344498164162,"v3":1.359604539941944},
{"x":5,"v1":-0.008687848469682338,"v2":-0.2820548387167232,"v3":-0.16666682844637187},
{"x":6,"v1":-1.5225874611321026,"v2":-2.4002938359239696,"v3":-0.32676120718822604},
{"x":7,"v1":0.6635719686297081,"v2":2.7342284067640974,"v3":-1.3851091306569194},
{"x":8,"v1":-0.4051755540291174,"v2":0.16985148350887025,"v3":0.7450304785506133},
{"x":9,"v1":1.5577882127429141,"v2":-1.9886598656422094,"v3":0.12256480282995263},
{"x":10,"v1":-1.457429188841369,"v2":1.5558678936025283,"v3":-0.3522472367955602},
{"x":11,"v1":-1.236920844166306,"v2":0.8151035315771348,"v3":1.0478614502489767},
{"x":12,"v1":-0.8141688093521456,"v2":-0.21328918448408662,"v3":-1.519199960820938},
{"x":13,"v1":1.8056826713478893,"v2":0.1644550595863941,"v3":-1.468081589325438},
{"x":14,"v1":-1.2970505812002735,"v2":0.26710640491108484,"v3":-0.6940482699996663},
{"x":15,"v1":-0.06614762772602897,"v2":0.2804339395255965,"v3":0.19235340635085363},
{"x":16,"v1":-1.4027953034379737,"v2":0.26756660324445325,"v3":-0.6338725986798065},
{"x":17,"v1":-1.497219012406259,"v2":1.8895672067116331,"v3":0.38438453127421823},
{"x":18,"v1":-0.2819877829112916,"v2":0.2825372257734669,"v3":3.4806119781957436},
{"x":19,"v1":-2.5969567155445383,"v2":0.16536457220676576,"v3":-0.4411492819908746},
{"x":20,"v1":-0.6812698545061483,"v2":-1.4172316822183963,"v3":1.34521533227519},
{"x":21,"v1":0.2518708600997043,"v2":0.15612029252789605,"v3":-1.887133778053931},
{"x":22,"v1":1.0771031645811766,"v2":1.578689574682296,"v3":-0.5250691794955483},
{"x":23,"v1":0.5931021027872618,"v2":-0.5101343770072345,"v3":0.7460969109380411},
{"x":24,"v1":0.5726838886598794,"v2":0.7849069060097003,"v3":-2.4848059542952745},
{"x":25,"v1":0.22861192445745268,"v2":2.448196872892416,"v3":-1.4043102892368728},
{"x":26,"v1":1.8565807432544066,"v2":0.3665971913231846,"v3":-1.051839093708235},
{"x":27,"v1":-1.8229064153204375,"v2":-0.16228749839931567,"v3":-1.85119779158885},
{"x":28,"v1":0.8620699891755398,"v2":-1.9402224976808784,"v3":-0.0082498306396111},
{"x":29,"v1":-1.195294223192811,"v2":-0.8620455026938618,"v3":1.7392853452378054},
{"x":30,"v1":-1.8843836046586804,"v2":-0.4382723466167394,"v3":0.2702903005735807},
{"x":31,"v1":0.5672929798001003,"v2":0.8439435071286475,"v3":1.5786201001765265},
{"x":32,"v1":-0.04049519514094008,"v2":1.3237187752844575,"v3":-0.20020030853010956},
{"x":33,"v1":-0.6760860729079282,"v2":-0.37340458493791645,"v3":-0.27980127740246924},
{"x":34,"v1":-0.00045558153853713447,"v2":-1.1879972305089421,"v3":3.3530399301284497},
{"x":35,"v1":0.6985723548187903,"v2":0.5500128762677847,"v3":0.6427184224980718},
{"x":36,"v1":-1.3239290201891265,"v2":0.44686213911921174,"v3":-0.13846205168646464},
{"x":37,"v1":2.1840150791656114,"v2":0.2005931368921444,"v3":-0.3289788465081916},
{"x":38,"v1":-0.3372314313407249,"v2":-1.6706310788644785,"v3":-1.5418541574540692},
{"x":39,"v1":-0.200216911357873,"v2":-1.6152476009141856,"v3":-1.4659971155169917},
{"x":40,"v1":0.9945606928967368,"v2":-0.759801235307073,"v3":1.5664351898358917},
{"x":41,"v1":1.1276343205343968,"v2":1.2594331284987037,"v3":-0.38527400205172524},
{"x":42,"v1":-2.288255164757613,"v2":0.17526676656207377,"v3":-0.8628494090271817},
{"x":43,"v1":0.005052849609666013,"v2":0.8421813816098027,"v3":-0.18540795189570658},
{"x":44,"v1":0.10159742549006945,"v2":-1.175056480695221,"v3":-0.827237034910538},
{"x":45,"v1":1.337735384578597,"v2":-0.48821111648209925,"v3":-0.6587280313461483},
{"x":46,"v1":0.2727503395365319,"v2":0.254552528877619,"v3":1.763916404994411},
{"x":47,"v1":-0.6193582120112525,"v2":-0.11878568088689948,"v3":0.818792010709369},
{"x":48,"v1":1.3880933278058498,"v2":2.235052165535558,"v3":-0.5235569958864961},
{"x":49,"v1":1.9946173881159062,"v2":0.9200507775667138,"v3":-0.04927624339560793},
{"x":50,"v1":1.9730592351305927,"v2":-0.7181939193324538,"v3":-0.387168442410853},
{"x":51,"v1":-1.4179511672412581,"v2":0.19477489695500894,"v3":0.2431029296779055},
{"x":52,"v1":1.180300732632909,"v2":0.47616000514652035,"v3":-0.7028128281454666},
{"x":53,"v1":-0.5305859871348443,"v2":-1.6535783217088071,"v3":-0.033088532144917304},
{"x":54,"v1":-1.4218949616865963,"v2":-0.5454210358346528,"v3":0.8012558694026086},
{"x":55,"v1":-0.7090034412551142,"v2":-0.2450842896853053,"v3":-0.7977836578423395},
{"x":56,"v1":-0.8456648906617945,"v2":0.3042854208565117,"v3":-0.35944518368110956},
{"x":57,"v1":-0.41582950666101964,"v2":0.8241681167974045,"v3":-0.3224470024623054},
{"x":58,"v1":1.4108567725536139,"v2":-0.23277585057572572,"v3":0.16438842722815172},
{"x":59,"v1":1.7250762844543086,"v2":1.2405636169246792,"v3":-1.7327006788321955},
{"x":60,"v1":-1.6674848578531756,"v2":0.9928078044937543,"v3":-0.4208794511363361},
{"x":61,"v1":0.668566870665311,"v2":0.6248969157724762,"v3":-2.535572988861115},
{"x":62,"v1":-1.452648979161923,"v2":-1.7194513674687235,"v3":0.36557881745594634},
{"x":63,"v1":0.8877110075553512,"v2":-0.8835122015522785,"v3":-1.0034004295334238},
{"x":64,"v1":0.7493465411090502,"v2":0.8168637246638168,"v3":1.2969427018922524},
{"x":65,"v1":-0.09280662821392907,"v2":1.9085768303512878,"v3":-1.366279736048661},
{"x":66,"v1":0.45408233949627314,"v2":1.0857666024966146,"v3":1.3058832396481965},
{"x":67,"v1":-0.5097450714528721,"v2":-2.0520878088039662,"v3":-0.4748028137843826},
{"x":68,"v1":-0.44520386762402175,"v2":-1.460272483884979,"v3":0.8691100860844698},
{"x":69,"v1":-1.0777696943989454,"v2":-1.5809967918205154,"v3":-0.1701042660223515},
{"x":70,"v1":1.6638150992754048,"v2":-0.7215922060368998,"v3":1.6612926039698312},
{"x":71,"v1":0.4373376217721142,"v2":-0.20125139992964916,"v3":0.7226270525681858},
{"x":72,"v1":-1.074444388299883,"v2":-1.327295323684849,"v3":0.6194034918757932},
{"x":73,"v1":-0.27301855144226866,"v2":-0.6337013950477806,"v3":-0.9324124958674705},
{"x":74,"v1":0.17730839750569308,"v2":-0.17143656156138667,"v3":-0.7041450685769384},
{"x":75,"v1":-0.3598908747130626,"v2":0.11603266315691192,"v3":-1.3123710345955097},
{"x":76,"v1":0.07728831381193439,"v2":1.1570005666882808,"v3":-0.9818435030402323},
{"x":77,"v1":0.903486012660632,"v2":0.5142970993055541,"v3":-0.8177726457777181},
{"x":78,"v1":-1.8067374399722127,"v2":1.6308232740694446,"v3":1.8545758041134617},
{"x":79,"v1":0.051809271509749164,"v2":0.9236062189282264,"v3":0.6770077474857563},
{"x":80,"v1":0.49837050363698177,"v2":-0.41235508871018717,"v3":-0.21995521464646572},
{"x":81,"v1":0.04869636358380921,"v2":0.5295069913497581,"v3":-0.8561770310668781},
{"x":82,"v1":1.6126959881597622,"v2":-1.6557447364980755,"v3":0.31734405807581956},
{"x":83,"v1":2.11408683524013,"v2":0.32231949347189087,"v3":-2.412127403887498},
{"x":84,"v1":-0.6083027304120422,"v2":-0.05742850583648352,"v3":1.658017842979191},
{"x":85,"v1":-0.7047151996724229,"v2":1.4213602202743827,"v3":0.5673153733011431},
{"x":86,"v1":0.2838530485043929,"v2":0.49394588239008197,"v3":-0.3472457798893597},
{"x":87,"v1":-1.6673880511638943,"v2":-0.9456139032506794,"v3":0.5110334087936602},
{"x":88,"v1":0.9169398913851842,"v2":-0.5884755932925863,"v3":0.1657835441840857},
{"x":89,"v1":0.11628187771281331,"v2":0.7589006435360247,"v3":-0.12651144298540928},
{"x":90,"v1":-0.12826677440285617,"v2":0.031738983852103775,"v3":1.3036437052374852},
{"x":91,"v1":0.41854881282749606,"v2":-0.5358991482019089,"v3":-1.7055947712392623},
{"x":92,"v1":-0.9307752496297212,"v2":-0.09307045822929028,"v3":0.33453278757631344},
{"x":93,"v1":-0.20234593705807036,"v2":-1.2267886701263575,"v3":-0.8233539379698219},
{"x":94,"v1":0.5827226952960933,"v2":-1.8348576300777044,"v3":-1.3975044199150388},
{"x":95,"v1":0.5375897759074951,"v2":-0.043746071434543225,"v3":-1.7110257341494304},
{"x":96,"v1":0.8312576364126785,"v2":-0.857519370737987,"v3":1.2041866198084512},
{"x":97,"v1":0.6590350260877742,"v2":-1.858082061294072,"v3":-0.8523607476197509},
{"x":98,"v1":-0.4323052068994948,"v2":-1.2716610251185163,"v3":0.6210999128326484},
{"x":99,"v1":2.4561508047504437,"v2":0.9286539574279807,"v3":2.249300562171126},
{"x":100,"v1":1.0602081957389478,"v2":0.8223560307174719,"v3":-1.0988592234976426},
{"x":101,"v1":1.3021680267261189,"v2":2.4529276130927724,"v3":0.897999145903796},
{"x":102,"v1":-1.462409794850906,"v2":1.6636469138844963,"v3":-0.9932190552324501},
{"x":103,"v1":1.8185427147955742,"v2":-0.43254880991966166,"v3":0.8950157000828077},
{"x":104,"v1":1.4374461093598245,"v2":1.7794461019621255,"v3":1.9268997186760901},
{"x":105,"v1":-0.9043963085893486,"v2":0.6326666821366781,"v3":-0.68478313143274},
{"x":106,"v1":-0.2432189349696872,"v2":0.7416671741246554,"v3":-2.122332603821774},
{"x":107,"v1":-1.177743726562841,"v2":-1.4119632905174353,"v3":-0.9590782070866071},
{"x":108,"v1":-2.9853847654153456,"v2":-2.015182146503996,"v3":-0.9771897162397054},
{"x":109,"v1":-3.072646186963298,"v2":-0.31006191758205165,"v3":-0.4908499355305138},
{"x":110,"v1":-0.18203425710480212,"v2":0.9364788508208186,"v3":-2.001165725392565},
{"x":111,"v1":-0.0009715084372381391,"v2":0.0737839210663456,"v3":-0.5734909495666},
{"x":112,"v1":0.6816923030235023,"v2":-1.156174034993355,"v3":1.013477832327352},
{"x":113,"v1":-1.2757470714643755,"v2":-1.0814446960751045,"v3":1.2697427395676424},
{"x":114,"v1":2.0727131015507836,"v2":0.07353912944704283,"v3":1.8182188799304144},
{"x":115,"v1":2.7149226337245147,"v2":1.785862729407715,"v3":0.07469129193772361},
{"x":116,"v1":-2.2090987062848164,"v2":-0.8326500259539478,"v3":-1.128263348129485},
{"x":117,"v1":-0.5568905618693,"v2":1.8099851851187296,"v3":-0.023280883695070143},
{"x":118,"v1":1.0133994711998908,"v2":-0.7414955159951439,"v3":0.7883367029070203},
{"x":119,"v1":-1.9875314048060673,"v2":1.5638375655520385,"v3":-0.8417996486946572},
{"x":120,"v1":2.1200898412366604,"v2":-1.1511897752307643,"v3":-2.0320152535342784},
{"x":121,"v1":-0.8548707679436696,"v2":2.4362036512021334,"v3":0.1590185824977729},
{"x":122,"v1":-1.5614161403275715,"v2":0.04839392181227621,"v3":0.5242196974387003},
{"x":123,"v1":0.7440648058225169,"v2":0.9138516078515833,"v3":1.110966232860291},
{"x":124,"v1":-1.7015919869051161,"v2":1.4093545840432278,"v3":0.7496030493583412},
{"x":125,"v1":-0.3314115760454644,"v2":-2.110929031650543,"v3":-0.6469438713638154},
{"x":126,"v1":-0.30377109454468126,"v2":-0.9209251510969716,"v3":0.6550955235232429},
{"x":127,"v1":-1.4345770259859485,"v2":0.5294692527459257,"v3":0.6767698186365214},
{"x":128,"v1":0.8063800274046979,"v2":1.7188019364231126,"v3":1.8809701927949019},
{"x":129,"v1":-0.3702839726066834,"v2":2.47290654786252,"v3":0.10484860683420896},
{"x":130,"v1":0.36411824007401167,"v2":-2.011936023988063,"v3":-0.5520506024754024},
{"x":131,"v1":0.05412910802324568,"v2":0.9716029024510305,"v3":1.3539011713417577},
{"x":132,"v1":0.39646811396137566,"v2":-1.2926279868363364,"v3":2.451262894515841},
{"x":133,"v1":-0.3410321481122018,"v2":0.08723965282125296,"v3":-1.6373057969519391},
{"x":134,"v1":0.3935136405096219,"v2":-1.1127719436184875,"v3":1.222255601062163},
{"x":135,"v1":-0.9782497156256011,"v2":0.7908574291824233,"v3":-0.833713451284788},
{"x":136,"v1":1.4871811924633282,"v2":-0.18837645099380654,"v3":0.11468063486636981},
{"x":137,"v1":1.5514065688943828,"v2":-1.50471840660886,"v3":-0.844045798858549},
{"x":138,"v1":-0.8282239598225173,"v2":1.1655506133039029,"v3":0.7893201634196703},
{"x":139,"v1":-0.5953772327537175,"v2":-1.459170037456631,"v3":-0.1209794661639014},
{"x":140,"v1":1.2063982880135529,"v2":0.25239177720657735,"v3":0.3134295772526309},
{"x":141,"v1":-1.5073109666301279,"v2":0.003228121737703349,"v3":-0.1368704486549902},
{"x":142,"v1":0.40807269416671976,"v2":2.0126436230812934,"v3":1.874902790223195},
{"x":143,"v1":-1.0439139897345668,"v2":-0.0445465844544581,"v3":1.4430845834824324},
{"x":144,"v1":-0.19757205510883025,"v2":1.5240063955638885,"v3":0.40085700511845834},
{"x":145,"v1":0.6130013831758894,"v2":2.748656268723327,"v3":-0.8323697576686363},
{"x":146,"v1":-0.3215337586177797,"v2":-0.35565772912075155,"v3":-2.5513979919555525},
{"x":147,"v1":-0.5095670661027596,"v2":-1.9201527183348714,"v3":-0.16877951432140897},
{"x":148,"v1":-1.4854304788131292,"v2":-0.4730376819956417,"v3":-0.7406094461377672},
{"x":149,"v1":-0.49170363444398124,"v2":-1.1097846261381725,"v3":1.1519805787109594},
{"x":150,"v1":-1.3310669781553652,"v2":0.4692137347985261,"v3":1.380964867699595},
{"x":151,"v1":-1.9919431126414093,"v2":-0.9505439323319917,"v3":0.155951217934452},
{"x":152,"v1":-1.6570230679603681,"v2":0.010114685782424434,"v3":0.8323733794731331},
{"x":153,"v1":0.32814933302926796,"v2":-0.011550264032238704,"v3":-0.2848441323335587},
{"x":154,"v1":2.033370833743499,"v2":-3.955816187753577,"v3":1.1402187434848545},
{"x":155,"v1":0.27249920769843006,"v2":-0.3871593820710406,"v3":-1.2689156864504234},
{"x":156,"v1":0.13265956364888634,"v2":-3.8275852179793675,"v3":0.22362692477253904},
{"x":157,"v1":0.5759262732369667,"v2":-1.7429074102149957,"v3":0.021481327159414254},
{"x":158,"v1":-0.9010741437713631,"v2":0.18977321063006194,"v3":1.8250183767643056},
{"x":159,"v1":3.2318046481568663,"v2":0.6334261638398192,"v3":0.41610420592370223},
{"x":160,"v1":-1.6570929187314754,"v2":-1.556124308646377,"v3":0.46760949094288706},
{"x":161,"v1":-1.3321416012786846,"v2":-0.7611793334255964,"v3":-0.5027342326063087},
{"x":162,"v1":0.8096290378521523,"v2":-0.9997237758297207,"v3":-0.31579912737886634},
{"x":163,"v1":2.862510725533854,"v2":0.30336197719454083,"v3":0.4141182554250641},
{"x":164,"v1":0.9940324679111507,"v2":0.41149293282890803,"v3":1.7337831885338808},
{"x":165,"v1":-0.7723067230453524,"v2":0.6440144082837861,"v3":-0.14148950460689613},
{"x":166,"v1":0.668868083325017,"v2":-0.3619822531140425,"v3":-0.12914706802321918},
{"x":167,"v1":-1.3924772484178964,"v2":0.799499091634313,"v3":0.44389975338511223},
{"x":168,"v1":-0.27043583378067565,"v2":-0.6685257877338652,"v3":-1.7459330017586034},
{"x":169,"v1":-0.5208388419037535,"v2":0.24845128405686706,"v3":-2.3287536829265223},
{"x":170,"v1":0.4542372986544077,"v2":0.07912700773972775,"v3":0.00632846688859473},
{"x":171,"v1":0.4596330329238637,"v2":2.0598017217038125,"v3":1.2065171614170491},
{"x":172,"v1":-1.1117305613517003,"v2":0.6853684021863129,"v3":-0.31991739524079627},
{"x":173,"v1":-0.9861427998092468,"v2":0.21421666973472242,"v3":0.2497401741053848},
{"x":174,"v1":0.05862984065199171,"v2":0.33742772448086134,"v3":-0.5717753816504246},
{"x":175,"v1":-0.19845661730286981,"v2":0.8427723806126626,"v3":-3.8566720687990697},
{"x":176,"v1":-0.16984000955399625,"v2":1.2900240273687353,"v3":1.2117571705391483},
{"x":177,"v1":0.2693881999344369,"v2":-0.11492392047155445,"v3":-1.8016615357380203},
{"x":178,"v1":0.9313889605276437,"v2":0.27624006466384177,"v3":1.0982520811476697},
{"x":179,"v1":1.0646597341737756,"v2":-0.22519899500296564,"v3":-2.2289859509668704},
{"x":180,"v1":1.9844937664774154,"v2":-1.3197939382683956,"v3":0.8547083455742543},
{"x":181,"v1":0.03770368697440985,"v2":-0.5434735440554711,"v3":2.07650008126864},
{"x":182,"v1":0.7115418404302108,"v2":0.32985156813479183,"v3":-0.21079221295149014},
{"x":183,"v1":2.7763564207854494,"v2":-1.07936863724376,"v3":0.1986629971362798},
{"x":184,"v1":-3.395119951177207,"v2":0.797748122850661,"v3":1.2037889160480306},
{"x":185,"v1":-0.8321053346786327,"v2":0.2121655365063184,"v3":2.366610873556921},
{"x":186,"v1":-0.9655311097150652,"v2":0.7684778460822685,"v3":-1.8601085066839957},
{"x":187,"v1":-0.9713902552497887,"v2":-0.9527117185682189,"v3":-1.031197256030719},
{"x":188,"v1":0.895739349618196,"v2":2.5328257534342247,"v3":0.16999296135475245},
{"x":189,"v1":2.025623280890984,"v2":0.2892290858964542,"v3":0.7871343506558025},
{"x":190,"v1":-0.9103800736048966,"v2":0.46501905623874057,"v3":0.1744268294952228},
{"x":191,"v1":-1.671511473343689,"v2":1.687747084687866,"v3":1.348755261238876},
{"x":192,"v1":-2.933730089438745,"v2":-0.9447346763659078,"v3":0.30956792975102576},
{"x":193,"v1":1.045384728677884,"v2":-0.5776827751260483,"v3":-1.5965418573573793},
{"x":194,"v1":1.5870864262236999,"v2":0.7503759954776099,"v3":-0.3542759451226336},
{"x":195,"v1":0.4546150986970991,"v2":-0.9680392635216053,"v3":-0.21450561752055614},
{"x":196,"v1":1.0855169358453298,"v2":-0.3355736360381456,"v3":0.15083943057613525},
{"x":197,"v1":0.1778828725524715,"v2":0.5215128324353279,"v3":-0.0610740477550446},
{"x":198,"v1":-0.08347815313712698,"v2":-2.5334357847057323,"v3":0.7643766840272461},
{"x":199,"v1":4.059618715498349,"v2":-1.48100781074724,"v3":-0.3652072319261829},
{"x":200,"v1":0.35787472657678626,"v2":0.6367584671860936,"v3":0.8500162454875164}];
    const series = [{"name":"Factor 1","color":"#1f77b4","key":"v1","dash":""},{"name":"Factor 2","color":"#ff7f0e","key":"v2","dash":""},{"name":"Factor 3","color":"#2ca02c","key":"v3","dash":""}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#fm_fac_88');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Factor Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Factor Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

</script>
</body>
</html>
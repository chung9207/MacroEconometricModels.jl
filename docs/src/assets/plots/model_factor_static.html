<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Static Factor Model (r=3)</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #fff;
    color: #333;
    padding: 20px;
}
.figure-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 16px;
    color: #222;
}
.figure-source {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 8px;
}
.panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
}
.panel {
    width: calc(100% - 16px);
    min-width: 300px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 12px;
}
.panel-title {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: #444;
}
.axis text { font-size: 11px; fill: #666; }
.axis line, .axis path { stroke: #ccc; }
.grid line { stroke: #f0f0f0; stroke-dasharray: 2,2; }
.grid .domain { stroke: none; }
.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
}
.legend { font-size: 11px; }
.legend rect { rx: 2; }
svg { overflow: visible; }
</style>
</head>
<body>
<div class="figure-title">Static Factor Model (r=3)</div>
<div class="panel-grid">
<div class="panel">
<div class="panel-title">Scree Plot</div>
<div id="fm_scree_87"></div>
</div>
<div class="panel">
<div class="panel-title">Extracted Factors</div>
<div id="fm_fac_88"></div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// Shared utilities
const tooltip = d3.select('#tooltip');
function fmt(v) {
    if (v === null || v === undefined) return '';
    return Math.abs(v) >= 1000 ? v.toFixed(1) : (Math.abs(v) >= 1 ? v.toFixed(3) : v.toFixed(4));
}
function showTip(evt, html) {
    tooltip.html(html).style('opacity',1)
        .style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px');
}
function hideTip() { tooltip.style('opacity',0); }

(function() {
    const data = [{"x":"PC 1","eig":8.365046217508862},
{"x":"PC 2","eig":2.3756259084519646},
{"x":"PC 3","eig":1.9870997391087302},
{"x":"PC 4","eig":1.8949066945906174},
{"x":"PC 5","eig":1.3256027602971816},
{"x":"PC 6","eig":0.8861626295369834},
{"x":"PC 7","eig":0.7702678108210369},
{"x":"PC 8","eig":0.5768910515422919},
{"x":"PC 9","eig":0.5266734006841975},
{"x":"PC 10","eig":0.42520221404026004}];
    const series = [{"name":"Eigenvalue","color":"#1f77b4","key":"eig","dash":""}];
    const mode = 'grouped';

    const container = d3.select('#fm_scree_87');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleBand().domain(data.map(d=>d.x)).range([0,w]).padding(0.15);

    let yMin = 0, yMax = 0;
    if(mode === 'stacked') {
        const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetDiverging);
        const stacked = stack(data);
        stacked.forEach(layer => layer.forEach(d => {
            yMin = Math.min(yMin, d[0], d[1]);
            yMax = Math.max(yMax, d[0], d[1]);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.layer').data(stacked).join('g').attr('class','layer')
            .attr('fill', (d,i) => series[i].color)
            .selectAll('rect').data(d => d).join('rect')
            .attr('x', d => x(d.data.x))
            .attr('y', d => y(Math.max(d[0], d[1])))
            .attr('height', d => Math.abs(y(d[0]) - y(d[1])))
            .attr('width', x.bandwidth());

        // Zero line
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    } else {
        // Grouped
        data.forEach(d => keys.forEach(k => {
            yMin = Math.min(yMin, d[k]||0);
            yMax = Math.max(yMax, d[k]||0);
        }));
        const yPad = (yMax - yMin) * 0.08 || 1;
        const y = d3.scaleLinear().domain([yMin - yPad, yMax + yPad]).range([h, 0]);
        const x1 = d3.scaleBand().domain(keys).range([0, x.bandwidth()]).padding(0.05);

        g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
        g.selectAll('.group').data(data).join('g').attr('class','group')
            .attr('transform', d => 'translate('+x(d.x)+',0)')
            .selectAll('rect').data(d => keys.map(k => ({key:k, val:d[k]||0})))
            .join('rect')
            .attr('x', d => x1(d.key))
            .attr('y', d => y(Math.max(0, d.val)))
            .attr('height', d => Math.abs(y(0) - y(d.val)))
            .attr('width', x1.bandwidth())
            .attr('fill', d => series.find(s=>s.key===d.key).color);

        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(0)).attr('y2',y(0))
            .attr('stroke','#333').attr('stroke-width',0.8);

        g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) =>
                i % Math.max(1,Math.floor(data.length/8)) === 0)));
        g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    }

    if('') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('');
    if('Eigenvalue') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Eigenvalue');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
            gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color);
            gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
        });
    }

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const bands = x.domain();
            const idx = Math.min(Math.floor(mx / (w / bands.length)), bands.length-1);
            const d = data[Math.max(0,idx)];
            if(!d) return;
            let html = '<b>'+d.x+'</b>';
            series.forEach(s => { if(d[s.key]!==undefined) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"v1":0.623226513605741,"v2":0.022207264414540354,"v3":-0.5359646864629493},
{"x":2,"v1":-1.2253403368213378,"v2":-0.23883799647129283,"v3":0.4777290928496244},
{"x":3,"v1":-2.106365664052602,"v2":0.39927510160261426,"v3":-0.2532978740370576},
{"x":4,"v1":-0.9647531016705804,"v2":-0.11113212817881257,"v3":-0.45695709492241204},
{"x":5,"v1":-2.681564860274315,"v2":-0.3063204703214469,"v3":-0.6659131264052652},
{"x":6,"v1":-2.3998746138557245,"v2":-0.3599404639878803,"v3":-1.5630893567278565},
{"x":7,"v1":-1.0370113084396568,"v2":-0.31043369450031405,"v3":3.319813008948566},
{"x":8,"v1":-6.258254022815913,"v2":1.5994880073181388,"v3":0.015706219901874204},
{"x":9,"v1":-1.0984299019353672,"v2":-0.9949644476334459,"v3":0.8451912567548017},
{"x":10,"v1":-2.2382222977390827,"v2":-1.925297946147413,"v3":-1.3588265853120918},
{"x":11,"v1":1.4969949207347908,"v2":1.5685979136893737,"v3":-1.7021319412078177},
{"x":12,"v1":-1.3830426433802019,"v2":0.13147554964621924,"v3":-1.0630843018831302},
{"x":13,"v1":-0.6521669425974803,"v2":-2.0883681834662142,"v3":0.18877003074628804},
{"x":14,"v1":-2.558660081120834,"v2":1.079859085158613,"v3":1.615531597776082},
{"x":15,"v1":2.2723754217389645,"v2":-0.8569632664890756,"v3":0.11663192502276988},
{"x":16,"v1":-0.2618841278527229,"v2":-0.3087628206632706,"v3":-0.13260315156428826},
{"x":17,"v1":1.62308166705983,"v2":-0.16681002979137838,"v3":-1.1079329555926265},
{"x":18,"v1":-0.9263294169489262,"v2":0.8020581103144618,"v3":-1.4453437066879722},
{"x":19,"v1":1.419871727725522,"v2":-0.5178089703084539,"v3":3.154703666278751},
{"x":20,"v1":-1.9886522237836899,"v2":-1.0377579007823077,"v3":-1.9485050830522004},
{"x":21,"v1":-0.2408085505131468,"v2":0.21749157568894661,"v3":0.6638630110058036},
{"x":22,"v1":-1.5573285136157597,"v2":-0.9497463003924271,"v3":-0.561987553807012},
{"x":23,"v1":-1.3831443716326968,"v2":-1.658167047058633,"v3":1.7741212266391864},
{"x":24,"v1":4.677669173474084,"v2":2.4024189032270034,"v3":-1.7928088890596854},
{"x":25,"v1":1.0917290102163848,"v2":1.1314527803710897,"v3":-1.7412682129527082},
{"x":26,"v1":0.3716154373202856,"v2":-1.030329341118067,"v3":0.9819954174678608},
{"x":27,"v1":5.576409602779242,"v2":0.6545196265690383,"v3":0.6093668534317479},
{"x":28,"v1":0.8572308275230172,"v2":0.35642189292552645,"v3":-0.06633471253545797},
{"x":29,"v1":7.82580826917818,"v2":-2.3106156456867577,"v3":0.6881257265264547},
{"x":30,"v1":-4.893280376088749,"v2":0.5097183755669495,"v3":-1.668766946199772},
{"x":31,"v1":2.9948905651821995,"v2":0.506997462290682,"v3":0.3728402125483986},
{"x":32,"v1":2.787549664459805,"v2":0.7706512519944088,"v3":-0.713436821820006},
{"x":33,"v1":-0.30328176408860524,"v2":0.5466765946652005,"v3":-0.061553644930444705},
{"x":34,"v1":-1.716180324494717,"v2":3.2254574154509097,"v3":-4.052550026209139},
{"x":35,"v1":4.597897680293172,"v2":-4.577351262648337,"v3":1.7135913182997229},
{"x":36,"v1":-4.708587576497689,"v2":0.1167035469660744,"v3":3.5962099985890204},
{"x":37,"v1":-1.7713435565583313,"v2":1.84892480323984,"v3":-0.7169757281549679},
{"x":38,"v1":3.3842119498661116,"v2":-0.009522447863654276,"v3":-0.7848107095506598},
{"x":39,"v1":-0.2043437194873269,"v2":1.1426812776199227,"v3":1.1085075411620724},
{"x":40,"v1":-1.0674571175962095,"v2":0.714460553532608,"v3":-0.7683001984216675},
{"x":41,"v1":2.7007047744127006,"v2":-0.8110103002612346,"v3":-0.08638610792476746},
{"x":42,"v1":-0.41505389804806303,"v2":0.8341138927396831,"v3":1.3464533721269194},
{"x":43,"v1":1.6202099277841273,"v2":2.6224674035787072,"v3":-0.9417192637587344},
{"x":44,"v1":5.641788196335662,"v2":1.1172032052071694,"v3":2.1611550942468623},
{"x":45,"v1":8.79692229971109,"v2":0.27758304875874373,"v3":-0.4743855340592633},
{"x":46,"v1":5.756870491669637,"v2":0.7434048991487381,"v3":-0.1929472040714065},
{"x":47,"v1":3.4347626227951835,"v2":4.266522556430091,"v3":1.1933964347983534},
{"x":48,"v1":4.905491537492451,"v2":-2.122978589862237,"v3":0.02183220648467914},
{"x":49,"v1":3.758078001574299,"v2":0.24651534191145552,"v3":-1.9588418081895311},
{"x":50,"v1":-0.5752018589076598,"v2":-0.8868587104287987,"v3":1.532334221860369},
{"x":51,"v1":-3.4879929220642842,"v2":1.7694687901515753,"v3":-1.115450527826931},
{"x":52,"v1":-3.546540141071071,"v2":1.3894004715025177,"v3":-0.3567926272565035},
{"x":53,"v1":-0.7595267297251856,"v2":-1.086651080263608,"v3":2.2750356369819857},
{"x":54,"v1":1.5829536092467287,"v2":0.8908565134750653,"v3":0.3300212981591788},
{"x":55,"v1":-4.032439241562584,"v2":1.5151802798350649,"v3":0.19411633279799717},
{"x":56,"v1":2.0789007806664324,"v2":0.8273032409733854,"v3":1.369119085360016},
{"x":57,"v1":1.8763913066861055,"v2":0.7064261671277642,"v3":-1.249512650096322},
{"x":58,"v1":3.9973674195010167,"v2":-2.546329802219114,"v3":1.7879913005821075},
{"x":59,"v1":4.337835023476617,"v2":-3.176585887957163,"v3":-2.029377042184804},
{"x":60,"v1":-3.594943045708318,"v2":1.0498262554699753,"v3":0.3720507532194027},
{"x":61,"v1":-3.681987369354094,"v2":0.6221043393115434,"v3":0.9227374542934552},
{"x":62,"v1":-2.4194855636892276,"v2":0.9014675541165472,"v3":-0.6172605609166952},
{"x":63,"v1":-1.2791553727946672,"v2":0.17635196552577173,"v3":0.19832963246754748},
{"x":64,"v1":0.8175252923614091,"v2":-1.6543658575553815,"v3":0.6696241242788609},
{"x":65,"v1":-3.910875976098895,"v2":1.0211737597108559,"v3":-0.04249185951267898},
{"x":66,"v1":4.077540830776502,"v2":1.7528548110930158,"v3":-1.5858660583277695},
{"x":67,"v1":0.19039784978216925,"v2":-1.2618283319592265,"v3":0.9924693693841448},
{"x":68,"v1":-2.666089985756369,"v2":1.9433658363634774,"v3":-0.367607681323496},
{"x":69,"v1":-0.6118155732644717,"v2":0.020341897792297847,"v3":0.41209371803862327},
{"x":70,"v1":-0.5141710352048259,"v2":-4.620475814430527,"v3":-4.7461359528510885},
{"x":71,"v1":-1.1314585143819595,"v2":3.8965022852981357,"v3":5.022205741131171},
{"x":72,"v1":-0.4178613349626286,"v2":0.12385798035778076,"v3":-0.3213369852990059},
{"x":73,"v1":2.0423093480386836,"v2":2.5562844686261657,"v3":0.42095141648877993},
{"x":74,"v1":-0.997769165339266,"v2":-2.291850223322141,"v3":-0.9085416512382193},
{"x":75,"v1":2.8521020913987147,"v2":-1.4252310828420995,"v3":1.7994040191066927},
{"x":76,"v1":0.9559845457797432,"v2":1.15314307227688,"v3":-0.8721768474479519},
{"x":77,"v1":-0.5733465311033132,"v2":0.8085633123388376,"v3":-2.1524593442540536},
{"x":78,"v1":2.2187520268619645,"v2":0.10600500124777844,"v3":-0.28509262729599816},
{"x":79,"v1":-2.312095614468592,"v2":0.011171432433491644,"v3":1.161823580121911},
{"x":80,"v1":-3.0073352010637664,"v2":0.5157978234393348,"v3":1.8558672535199547},
{"x":81,"v1":-1.0477907722232267,"v2":-0.6545550109450605,"v3":0.36707134600811075},
{"x":82,"v1":-2.397505917281537,"v2":-4.266226229006225,"v3":-3.264503812974233},
{"x":83,"v1":0.4193244509387707,"v2":4.8623892011747,"v3":1.4559470683191291},
{"x":84,"v1":0.5830998844084101,"v2":-1.2391561514798302,"v3":-0.8929287064006085},
{"x":85,"v1":-4.624308607181066,"v2":-0.8642415015424844,"v3":0.6567835389634122},
{"x":86,"v1":-2.0793786388199647,"v2":-1.1694341242234958,"v3":0.7068659435610773},
{"x":87,"v1":-1.2780509927834776,"v2":0.7896543335377015,"v3":0.4163649330007566},
{"x":88,"v1":-1.5874737993516999,"v2":0.792895927894272,"v3":-1.0062623470034275},
{"x":89,"v1":0.4249183819475995,"v2":-0.24670348339620388,"v3":1.47541229330773},
{"x":90,"v1":-3.317808071179425,"v2":-0.5443116965783008,"v3":-0.5730769156247436},
{"x":91,"v1":0.05745051408391952,"v2":-1.1329451035302005,"v3":1.1711923430927842},
{"x":92,"v1":-3.811769751327787,"v2":-0.2180102869358654,"v3":-1.4518526548927346},
{"x":93,"v1":-2.239030238001217,"v2":-0.5137775860924924,"v3":1.7329396232646288},
{"x":94,"v1":-4.0878192909900415,"v2":0.19917034692047472,"v3":-0.027410236587857004},
{"x":95,"v1":0.5985607223375473,"v2":-0.5757268030436999,"v3":0.7061880399425362},
{"x":96,"v1":2.0520100466332187,"v2":2.0111887657236656,"v3":-0.45934161932600315},
{"x":97,"v1":0.17500900232333425,"v2":-0.45180670629263214,"v3":-0.10697304088397135},
{"x":98,"v1":3.0761438643544,"v2":0.3476199432976864,"v3":0.6228760105255227},
{"x":99,"v1":-1.1616008156709257,"v2":0.5756722946996858,"v3":-1.4107594754475787},
{"x":100,"v1":-1.194194432058013,"v2":-0.7173018479289398,"v3":-0.9076697377050469},
{"x":101,"v1":4.5556526638754615,"v2":0.952696725126923,"v3":-0.5809445341121188},
{"x":102,"v1":-5.897873152377788,"v2":1.2205040956562212,"v3":-0.9429393993308295},
{"x":103,"v1":-1.6950251136098677,"v2":-0.7908188987334234,"v3":1.5091147751622287},
{"x":104,"v1":3.143171746790248,"v2":-0.40129377753154755,"v3":1.6887680355186305},
{"x":105,"v1":-0.04827815113606417,"v2":-0.3133311304996229,"v3":-1.8112858642377765},
{"x":106,"v1":-0.7253888914947534,"v2":0.020703177151641827,"v3":-0.5701559564585581},
{"x":107,"v1":5.606102680851445,"v2":0.14684426339603993,"v3":0.7418953086394215},
{"x":108,"v1":-6.767299860323234,"v2":-0.2645272815787878,"v3":-1.2778438955844151},
{"x":109,"v1":2.798852536192718,"v2":-0.9929977362231645,"v3":-0.8546924720234955},
{"x":110,"v1":-4.749706579811992,"v2":0.22440923810060281,"v3":1.220349668023318},
{"x":111,"v1":-2.1639527966937484,"v2":-0.6083338160545941,"v3":0.5008967797685906},
{"x":112,"v1":-2.994433962656992,"v2":0.29740585012350756,"v3":0.43250960466146465},
{"x":113,"v1":0.700347957828198,"v2":-0.8268728534346822,"v3":2.200022170060749},
{"x":114,"v1":-0.4222773834251594,"v2":-0.8142367542501863,"v3":0.43921140956512317},
{"x":115,"v1":-2.6199996250869084,"v2":0.7035258466146419,"v3":-0.7818744503570538},
{"x":116,"v1":1.8194899099274657,"v2":-0.8851036643854036,"v3":-0.010364382739942704},
{"x":117,"v1":-3.9468841095603513,"v2":1.3729829301054817,"v3":-1.131913380998307},
{"x":118,"v1":-2.232478531399434,"v2":-0.29499987382782306,"v3":0.9735611710665563},
{"x":119,"v1":0.6358422366246609,"v2":-1.4251865753498636,"v3":-0.4054317588614571},
{"x":120,"v1":-5.183071987452059,"v2":-0.857535606486206,"v3":0.945614416692904},
{"x":121,"v1":-2.74465457014192,"v2":-0.37382006879518176,"v3":0.6687784021457751},
{"x":122,"v1":1.9444658721287813,"v2":0.4465785806494184,"v3":0.6360038352334468},
{"x":123,"v1":-1.9002875823070644,"v2":0.8416468430224613,"v3":-0.042756788597756334},
{"x":124,"v1":-1.5828429592590414,"v2":-2.0565911386611315,"v3":1.205278998240349},
{"x":125,"v1":-2.861204408277899,"v2":0.07140530305588991,"v3":-2.1677468909596853},
{"x":126,"v1":-4.3346824742556125,"v2":-0.19159633471096582,"v3":0.2522068438905452},
{"x":127,"v1":-3.0924915503119568,"v2":0.1994954780206187,"v3":-0.08705514076674387},
{"x":128,"v1":-3.6542361329463007,"v2":2.211448526315823,"v3":-2.2816527372954516},
{"x":129,"v1":-3.065482029489212,"v2":-1.053381907262163,"v3":0.7495708070506876},
{"x":130,"v1":-0.12029728228798117,"v2":-1.5554925955231835,"v3":0.44409862706320147},
{"x":131,"v1":-1.4946001279479442,"v2":-0.9352925202518061,"v3":0.4741939097750775},
{"x":132,"v1":0.5769712845870817,"v2":-0.7518397985383636,"v3":-1.2649046093025822},
{"x":133,"v1":1.4706371637366464,"v2":-0.200085283980209,"v3":-1.634958118631106},
{"x":134,"v1":-0.7361470055346835,"v2":-0.25457797445724856,"v3":-1.2687522506020494},
{"x":135,"v1":-1.3221233312331209,"v2":-0.12655613323698212,"v3":-0.8788860950595477},
{"x":136,"v1":5.08984072719892,"v2":-1.0417631507337675,"v3":-2.5457964128029986},
{"x":137,"v1":4.400734420888816,"v2":0.36115868100124876,"v3":-0.6422435420904723},
{"x":138,"v1":-11.264160982073616,"v2":1.6732978797562894,"v3":2.3436948814864746},
{"x":139,"v1":1.9708593666160392,"v2":-1.2229824213095073,"v3":-0.07660946511873504},
{"x":140,"v1":-2.477974753120794,"v2":-0.4570804789213117,"v3":0.504595891883988},
{"x":141,"v1":1.4491903825712635,"v2":-2.381229619733607,"v3":1.4395396343195639},
{"x":142,"v1":-1.2283698585850171,"v2":-1.1402055552647092,"v3":0.1937850646041543},
{"x":143,"v1":-1.0467562186572226,"v2":1.8355420670142781,"v3":-1.9881173836904271},
{"x":144,"v1":-2.626873855761004,"v2":-1.6617517401214377,"v3":0.5852822697838949},
{"x":145,"v1":0.9863442349729425,"v2":0.41247637010013527,"v3":-0.524919175338786},
{"x":146,"v1":0.08779510902879284,"v2":-0.3635923150076062,"v3":1.1432841417041122},
{"x":147,"v1":-2.7560355117632436,"v2":0.0858916562972308,"v3":-0.45114514126467803},
{"x":148,"v1":2.6007844502522364,"v2":-1.4201245938896794,"v3":0.6890869723064764},
{"x":149,"v1":-0.6683964912157584,"v2":-0.7405743283391074,"v3":0.9276462656805241},
{"x":150,"v1":-2.024287545416565,"v2":0.296253435736432,"v3":-1.2881013435861806},
{"x":151,"v1":3.9652698107690227,"v2":-0.8412859642677705,"v3":0.2983381593072294},
{"x":152,"v1":-5.726479189779339,"v2":0.6001922709360448,"v3":-0.28266964766061997},
{"x":153,"v1":-0.8368398905771925,"v2":-2.163919366132885,"v3":0.19446813529898507},
{"x":154,"v1":-2.865913734731374,"v2":-0.8435331782099885,"v3":-3.1393002358815094},
{"x":155,"v1":2.140271808685788,"v2":-1.8903364583854143,"v3":2.1155115355190026},
{"x":156,"v1":-0.3491874195476601,"v2":0.5574407681005608,"v3":-2.711443149009578},
{"x":157,"v1":-0.747443375426328,"v2":-2.7917805235596758,"v3":1.9160803744098924},
{"x":158,"v1":-1.8294413989373401,"v2":2.0637320980754033,"v3":-0.682848782168611},
{"x":159,"v1":0.6420343184899496,"v2":0.7863221631820491,"v3":-0.9286554875109583},
{"x":160,"v1":0.7750778367684933,"v2":-0.13019482424686885,"v3":-0.40074339145674115},
{"x":161,"v1":2.17924325483997,"v2":-0.009066870800978276,"v3":0.35070517735875695},
{"x":162,"v1":3.602594756984895,"v2":-0.5568321714821529,"v3":-0.9190574903748039},
{"x":163,"v1":-2.1048970341218394,"v2":0.14706183476393012,"v3":-1.7571121867164323},
{"x":164,"v1":4.112465920317569,"v2":-0.3372205064430499,"v3":0.9033013315173715},
{"x":165,"v1":2.0571216282775486,"v2":2.1990710745571835,"v3":-1.5420425645794675},
{"x":166,"v1":2.7576677056826786,"v2":1.7651281763486888,"v3":-3.0806239926662844},
{"x":167,"v1":3.54654915302043,"v2":-1.0852963934271855,"v3":-0.46470589527079886},
{"x":168,"v1":4.477043903405357,"v2":-0.7340048602017177,"v3":0.7511167952314718},
{"x":169,"v1":2.790089955254533,"v2":1.130076867945937,"v3":1.2549650954735543},
{"x":170,"v1":3.455641244845195,"v2":1.3183285105206797,"v3":-0.5220079314256977},
{"x":171,"v1":3.5713967089487784,"v2":0.24143568892135917,"v3":0.1956283050953868},
{"x":172,"v1":4.246671046242928,"v2":1.7982977431642468,"v3":-0.3704919771805456},
{"x":173,"v1":4.298691232370712,"v2":-0.10944645975248023,"v3":0.39655941559059954},
{"x":174,"v1":2.509002423385052,"v2":0.5118586009489459,"v3":-1.2575565108959301},
{"x":175,"v1":4.811646976090017,"v2":1.935513686569531,"v3":2.7652047793719237},
{"x":176,"v1":1.518442009725492,"v2":-3.275463997820892,"v3":-4.69352453872189},
{"x":177,"v1":4.081650632992647,"v2":1.6462381125439016,"v3":2.102989329867523},
{"x":178,"v1":1.1964578386655462,"v2":1.7748962069135208,"v3":0.8650052215918869},
{"x":179,"v1":-2.3432682848178907,"v2":0.6412656061669231,"v3":-0.36949487554334326},
{"x":180,"v1":1.6104592936969242,"v2":-0.9542272569219886,"v3":1.349942795199716},
{"x":181,"v1":-2.0710269784196775,"v2":1.9242847670172374,"v3":-0.06484858622743021},
{"x":182,"v1":-0.7514699423350816,"v2":-1.1318573253445003,"v3":0.7280915680159793},
{"x":183,"v1":-0.7502079972990792,"v2":0.8600153707457024,"v3":0.9843985962368006},
{"x":184,"v1":-3.410244553751582,"v2":0.4108323041511866,"v3":0.03232876237977694},
{"x":185,"v1":1.424559155893135,"v2":0.3339095109226614,"v3":-0.02456741890853288},
{"x":186,"v1":1.2963133430841276,"v2":-0.9790917874013781,"v3":1.194598448804591},
{"x":187,"v1":1.4760192703314268,"v2":2.4031667265752787,"v3":0.9972542447239117},
{"x":188,"v1":2.223990667270588,"v2":0.9005441804039972,"v3":-1.4346823905002113},
{"x":189,"v1":-2.164902484660602,"v2":-0.1456732535124598,"v3":0.4089709783191502},
{"x":190,"v1":4.763196406521466,"v2":-1.2255037793126151,"v3":-0.020003335808475655},
{"x":191,"v1":-3.27833048436644,"v2":2.2267532245011785,"v3":0.044477858368720896},
{"x":192,"v1":1.4894831899713277,"v2":3.4245508450875413,"v3":-0.18889601848873683},
{"x":193,"v1":1.269011942567048,"v2":-1.0080660855369608,"v3":0.21292318742449143},
{"x":194,"v1":4.487247054887177,"v2":-1.1071921451327424,"v3":-0.1550290539417072},
{"x":195,"v1":0.9166871730074262,"v2":-0.7129507256823401,"v3":-0.5979059784950713},
{"x":196,"v1":-0.5567459729022484,"v2":-1.3193281216995671,"v3":0.44027740167810764},
{"x":197,"v1":-1.5627917260781505,"v2":1.2844656303740887,"v3":-0.7304122342197609},
{"x":198,"v1":2.878232534235172,"v2":-1.3314894495589797,"v3":-0.9014506469571026},
{"x":199,"v1":-2.833140875972874,"v2":0.8386533249850802,"v3":1.6087693618312582},
{"x":200,"v1":1.1101403243673784,"v2":-1.4487934504506887,"v3":1.1983422085637845},
{"x":201,"v1":-3.131978017417194,"v2":-0.19473212425255843,"v3":-0.4087447117645673},
{"x":202,"v1":1.258464199856579,"v2":0.6740811256942933,"v3":-0.22222241366742287},
{"x":203,"v1":0.8584505611498542,"v2":1.4269657829686004,"v3":-0.3045574999371825},
{"x":204,"v1":-2.45159418844531,"v2":0.45873547489415595,"v3":-0.01725812443251369},
{"x":205,"v1":2.1693983152998837,"v2":-3.797123292980864,"v3":1.4282127464333163},
{"x":206,"v1":-0.28533438004310646,"v2":1.6713451306146834,"v3":-0.383559935829814},
{"x":207,"v1":-2.444589296504727,"v2":-0.7905966137206055,"v3":-1.0271727264732096},
{"x":208,"v1":5.490011576108922,"v2":-0.10384330308851268,"v3":1.8205104239494723},
{"x":209,"v1":-3.2327665812006776,"v2":-1.4085664884128817,"v3":-0.15569594154444016},
{"x":210,"v1":-0.1833339728462342,"v2":-0.3476367613985203,"v3":0.5639167085530894},
{"x":211,"v1":0.37119378257686925,"v2":-0.3912200118145199,"v3":-1.4384071476757916},
{"x":212,"v1":-3.4335292304464633,"v2":0.36143944357718333,"v3":0.5736681799648369},
{"x":213,"v1":1.2079502826288735,"v2":0.7708620015782303,"v3":0.4322694967294627},
{"x":214,"v1":-4.298744631645445,"v2":-5.194031682064914,"v3":-4.101083530453482},
{"x":215,"v1":-0.2398916683523215,"v2":5.66345022655151,"v3":4.063629461770795},
{"x":216,"v1":-2.977820213492681,"v2":-0.30972967316920846,"v3":0.8243386117678676},
{"x":217,"v1":2.828205788107924,"v2":0.1973540947292226,"v3":-1.0588262267102462},
{"x":218,"v1":-0.5901814834715148,"v2":-1.0163720370131244,"v3":-0.493597526124461},
{"x":219,"v1":0.45218612056607826,"v2":1.4277051197799806,"v3":-0.009297773045121803},
{"x":220,"v1":-1.4497995112151727,"v2":-0.37800920957172973,"v3":-2.8617423162177005},
{"x":221,"v1":2.958951327502552,"v2":-0.730945447055034,"v3":-1.2543792788219514},
{"x":222,"v1":-0.9487030247311398,"v2":2.145458523656828,"v3":1.6988703223208497},
{"x":223,"v1":8.38689780179703,"v2":4.677763370979352,"v3":-1.6575950197341969},
{"x":224,"v1":-5.252096532723632,"v2":-0.9391483752243623,"v3":1.82765525990101},
{"x":225,"v1":-3.546401505334004,"v2":-3.429080258212798,"v3":1.3562312914717467},
{"x":226,"v1":-0.5476544814658999,"v2":0.717829167310866,"v3":-1.91856334779904},
{"x":227,"v1":-1.0652728108005185,"v2":-5.178971974807531,"v3":2.189635983840791},
{"x":228,"v1":1.96269829602181,"v2":-0.4680685142543271,"v3":-0.177124126344605},
{"x":229,"v1":-0.19626420342178996,"v2":1.5037364549916568,"v3":-2.1668848436410824},
{"x":230,"v1":-0.4527182768794369,"v2":0.8293397594186369,"v3":0.14724301343556304},
{"x":231,"v1":1.6919935074748815,"v2":-0.043261842560318,"v3":0.8099761432552214},
{"x":232,"v1":-0.5443157102427159,"v2":0.6798212921295735,"v3":-0.19956214473332667},
{"x":233,"v1":2.8650675170158144,"v2":-0.02535343110395496,"v3":-0.27055163447634},
{"x":234,"v1":-2.453313917776653,"v2":1.1248895290639067,"v3":1.068703427287772},
{"x":235,"v1":1.5798595257244363,"v2":-1.5105789851900298,"v3":0.2567544890527894},
{"x":236,"v1":2.5720394150760306,"v2":0.3954687183189211,"v3":-1.8247717171434445},
{"x":237,"v1":0.8232477593635625,"v2":0.09224427785211442,"v3":-0.31553214110072414},
{"x":238,"v1":-4.925751722925287,"v2":-2.527623444366189,"v3":1.658507180573868},
{"x":239,"v1":3.6266795834782104,"v2":0.07816171798035029,"v3":-0.23145018527178543},
{"x":240,"v1":-2.591688497937054,"v2":2.199683522817724,"v3":-2.1053918221603025},
{"x":241,"v1":-0.741207544431368,"v2":-2.912602326569486,"v3":3.019811667837558},
{"x":242,"v1":-1.8199819929371748,"v2":1.270866139963785,"v3":0.5365110794931475},
{"x":243,"v1":1.1408662033562642,"v2":-0.6587471597427755,"v3":0.3179480429816198},
{"x":244,"v1":0.2446548466748379,"v2":0.6023378901030052,"v3":1.457358145677867},
{"x":245,"v1":1.9597396154079172,"v2":-0.0038142467392505487,"v3":0.4351910716687345},
{"x":246,"v1":1.2370237355975653,"v2":0.2963464643330161,"v3":-0.6870006936456697},
{"x":247,"v1":-0.011059629412743723,"v2":0.31055281242420557,"v3":-0.09117010774034125},
{"x":248,"v1":2.9834845332866493,"v2":-0.9974642981482719,"v3":1.956973536734071},
{"x":249,"v1":-1.082734378782806,"v2":0.0618898686439677,"v3":0.9891521073633206},
{"x":250,"v1":1.1013325452455425,"v2":0.2033292956607546,"v3":1.4552540021331446}];
    const series = [{"name":"Factor 1","color":"#1f77b4","key":"v1","dash":""},{"name":"Factor 2","color":"#ff7f0e","key":"v2","dash":""},{"name":"Factor 3","color":"#2ca02c","key":"v3","dash":""}];
    const bands = [];
    const refLines = [];

    const container = d3.select('#fm_fac_88');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    // Compute domains
    const xVals = data.map(d => d.x);
    const allYVals = [];
    series.forEach(s => data.forEach(d => { if(d[s.key]!==null) allYVals.push(d[s.key]); }));
    bands.forEach(b => data.forEach(d => {
        if(d[b.lo_key]!==null) allYVals.push(d[b.lo_key]);
        if(d[b.hi_key]!==null) allYVals.push(d[b.hi_key]);
    }));
    refLines.forEach(r => allYVals.push(r.value));

    const x = d3.scaleLinear().domain(d3.extent(xVals)).range([0,w]);
    const yExt = d3.extent(allYVals);
    const yPad = (yExt[1]-yExt[0])*0.08 || 1;
    const y = d3.scaleLinear().domain([yExt[0]-yPad, yExt[1]+yPad]).range([h,0]);

    // Grid
    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));

    // Bands
    bands.forEach(b => {
        const area = d3.area()
            .x(d => x(d.x))
            .y0(d => y(d[b.lo_key]!==null ? d[b.lo_key] : 0))
            .y1(d => y(d[b.hi_key]!==null ? d[b.hi_key] : 0))
            .defined(d => d[b.lo_key]!==null && d[b.hi_key]!==null);
        g.append('path').datum(data).attr('d',area)
            .attr('fill',b.color).attr('opacity',b.alpha||0.15);
    });

    // Reference lines
    refLines.forEach(r => {
        g.append('line').attr('x1',0).attr('x2',w)
            .attr('y1',y(r.value)).attr('y2',y(r.value))
            .attr('stroke',r.color||'#999').attr('stroke-width',1)
            .attr('stroke-dasharray',r.dash||'4,3');
    });

    // Lines
    series.forEach(s => {
        const line = d3.line().x(d=>x(d.x)).y(d=>y(d[s.key]))
            .defined(d=>d[s.key]!==null);
        g.append('path').datum(data).attr('d',line)
            .attr('fill','none').attr('stroke',s.color).attr('stroke-width',1.8)
            .attr('stroke-dasharray',s.dash||'');
    });

    // Axes
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(xVals.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6));

    if('Period') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Period');
    if('Factor Value') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Factor Value');

    // Legend
    if(series.length > 1) {
        const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
        series.forEach((s,i) => {
            const gi = leg.append('g').attr('transform','translate('+(i*100)+',0)');
            gi.append('line').attr('x1',0).attr('x2',16).attr('y1',0).attr('y2',0)
                .attr('stroke',s.color).attr('stroke-width',2)
                .attr('stroke-dasharray',s.dash||'');
            gi.append('text').attr('x',20).attr('y',4).attr('font-size','10px')
                .attr('fill','#555').text(s.name);
        });
    }

    // Tooltip overlay
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>x='+fmt(d.x)+'</b>';
            series.forEach(s => { if(d[s.key]!==null) html += '<br>'+s.name+': '+fmt(d[s.key]); });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

</script>
</body>
</html>